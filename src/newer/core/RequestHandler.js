/**
 * Request Handler Core - Unified Reflect Action Handling
 *
 * Single source of truth for all action execution:
 * - UnifiedChannel, ChannelContext, Proxy module
 * - Supports both DataBase-backed and direct object targets
 * - Supports custom Reflect implementations
 */
import { UUIDv4, deepOperateAndClone, isPrimitive, isCanJustReturn, isCanTransfer } from "fest/core";
import { WReflectAction } from "../next/types/Interface";
import { hasNoPath, readByPath, registeredInPath, removeByData, removeByPath, writeByPath, normalizeRef, objectToRef } from "../next/storage/DataBase";
// ============================================================================
// HELPERS
// ============================================================================
const isObject = (obj) => (typeof obj === "object" || typeof obj === "function") && obj != null;
const defaultReflect = {
    get: (t, p) => t?.[p],
    set: (t, p, v) => { t[p] = v; return true; },
    has: (t, p) => p in t,
    apply: (t, ctx, args) => t.apply(ctx, args),
    construct: (t, args) => new t(...args),
    deleteProperty: (t, p) => delete t[p],
    ownKeys: (t) => Object.keys(t),
    getOwnPropertyDescriptor: (t, p) => Object.getOwnPropertyDescriptor(t, p),
    getPrototypeOf: (t) => Object.getPrototypeOf(t),
    setPrototypeOf: (t, p) => Object.setPrototypeOf(t, p),
    isExtensible: (t) => Object.isExtensible(t),
    preventExtensions: (t) => Object.preventExtensions(t)
};
// ============================================================================
// UNIFIED ACTION EXECUTOR
// ============================================================================
/**
 * Execute a reflect action
 *
 * Unified implementation used by all channel/proxy handlers.
 * Supports both DataBase-backed paths and direct object targets.
 *
 * @param action - Action to execute (WReflectAction or string)
 * @param path - Object path
 * @param args - Action arguments
 * @param options - Execution options
 */
export function executeAction(action, path, args, options = {}) {
    const { channel = "", sender = "", reflect = defaultReflect } = options;
    // Get target: from options or DataBase
    const obj = options.target ?? readByPath(path);
    const toTransfer = [];
    let result = null;
    let newPath = path;
    // Normalize action string
    const act = String(action).toLowerCase();
    switch (act) {
        case "import":
        case WReflectAction.IMPORT:
            result = import(args?.[0]);
            break;
        case "transfer":
        case WReflectAction.TRANSFER:
            if (isCanTransfer(obj) && channel !== sender) {
                toTransfer.push(obj);
            }
            result = obj;
            break;
        case "get":
        case WReflectAction.GET: {
            const prop = args?.[0];
            const got = reflect.get?.(obj, prop) ?? obj?.[prop];
            result = typeof got === "function" && obj != null ? got.bind(obj) : got;
            newPath = [...path, String(prop)];
            break;
        }
        case "set":
        case WReflectAction.SET: {
            const [prop, value] = args;
            const normalizedValue = deepOperateAndClone(value, normalizeRef);
            if (options.target) {
                result = reflect.set?.(obj, prop, normalizedValue) ?? (obj[prop] = normalizedValue, true);
            }
            else {
                result = reflect.set?.(obj, prop, normalizedValue) ??
                    writeByPath([...path, String(prop)], normalizedValue);
            }
            break;
        }
        case "apply":
        case "call":
        case WReflectAction.APPLY:
        case WReflectAction.CALL: {
            if (typeof obj === "function") {
                const ctx = options.context ?? (options.target ? undefined : readByPath(path.slice(0, -1)));
                const normalizedArgs = deepOperateAndClone(args?.[0] ?? args ?? [], normalizeRef);
                result = reflect.apply?.(obj, ctx, normalizedArgs) ?? obj.apply(ctx, normalizedArgs);
                if (isCanTransfer(result) && path?.at(-1) === "transfer" && channel !== sender) {
                    toTransfer.push(result);
                }
            }
            break;
        }
        case "construct":
        case WReflectAction.CONSTRUCT: {
            if (typeof obj === "function") {
                const normalizedArgs = deepOperateAndClone(args?.[0] ?? args ?? [], normalizeRef);
                result = reflect.construct?.(obj, normalizedArgs) ?? new obj(...normalizedArgs);
            }
            break;
        }
        case "delete":
        case "deleteproperty":
        case "dispose":
        case WReflectAction.DELETE:
        case WReflectAction.DELETE_PROPERTY:
        case WReflectAction.DISPOSE:
            if (options.target) {
                const prop = path[path.length - 1];
                result = reflect.deleteProperty?.(obj, prop) ?? delete obj[prop];
            }
            else {
                result = path?.length > 0 ? removeByPath(path) : removeByData(obj);
                if (result)
                    newPath = registeredInPath.get(obj) ?? [];
            }
            break;
        case "has":
        case WReflectAction.HAS:
            result = reflect.has?.(obj, args?.[0]) ?? (isObject(obj) ? args?.[0] in obj : false);
            break;
        case "ownkeys":
        case WReflectAction.OWN_KEYS:
            result = reflect.ownKeys?.(obj) ?? (isObject(obj) ? Object.keys(obj) : []);
            break;
        case "getownpropertydescriptor":
        case "getpropertydescriptor":
        case WReflectAction.GET_OWN_PROPERTY_DESCRIPTOR:
        case WReflectAction.GET_PROPERTY_DESCRIPTOR:
            result = reflect.getOwnPropertyDescriptor?.(obj, args?.[0] ?? path?.at(-1) ?? "") ??
                (isObject(obj) ? Object.getOwnPropertyDescriptor(obj, args?.[0] ?? path?.at(-1) ?? "") : undefined);
            break;
        case "getprototypeof":
        case WReflectAction.GET_PROTOTYPE_OF:
            result = reflect.getPrototypeOf?.(obj) ?? (isObject(obj) ? Object.getPrototypeOf(obj) : null);
            break;
        case "setprototypeof":
        case WReflectAction.SET_PROTOTYPE_OF:
            result = reflect.setPrototypeOf?.(obj, args?.[0]) ??
                (isObject(obj) ? Object.setPrototypeOf(obj, args?.[0]) : false);
            break;
        case "isextensible":
        case WReflectAction.IS_EXTENSIBLE:
            result = reflect.isExtensible?.(obj) ?? (isObject(obj) ? Object.isExtensible(obj) : true);
            break;
        case "preventextensions":
        case WReflectAction.PREVENT_EXTENSIONS:
            result = reflect.preventExtensions?.(obj) ??
                (isObject(obj) ? Object.preventExtensions(obj) : false);
            break;
    }
    return { result, toTransfer, path: newPath };
}
/**
 * Execute action with async result resolution
 */
export async function executeActionAsync(action, path, args, options = {}) {
    const { result, toTransfer, path: newPath } = executeAction(action, path, args, options);
    return { result: await result, toTransfer, path: newPath };
}
// ============================================================================
// RESPONSE BUILDER
// ============================================================================
/**
 * Build response object with descriptor
 */
export async function buildResponse(reqId, action, channel, sender, path, rawResult, toTransfer) {
    const result = await rawResult;
    const canBeReturn = (isCanTransfer(result) && toTransfer.includes(result)) || isCanJustReturn(result);
    // Generate temp path if needed
    let finalPath = path;
    if (!canBeReturn && action !== "get" && action !== WReflectAction.GET &&
        (typeof result === "object" || typeof result === "function")) {
        if (hasNoPath(result)) {
            finalPath = [UUIDv4()];
            writeByPath(finalPath, result);
        }
        else {
            finalPath = registeredInPath.get(result) ?? [];
        }
    }
    const ctx = readByPath(finalPath);
    const ctxKey = (action === "get" || action === WReflectAction.GET) ? finalPath?.at(-1) : undefined;
    const obj = readByPath(path);
    const payload = deepOperateAndClone(result, (el) => objectToRef(el, channel, toTransfer)) ?? result;
    return {
        response: {
            channel: sender,
            sender: channel,
            reqId,
            action,
            type: "response",
            payload: {
                result: canBeReturn ? payload : null,
                type: typeof result,
                channel: sender,
                sender: channel,
                descriptor: {
                    $isDescriptor: true,
                    path: finalPath,
                    owner: channel,
                    channel,
                    primitive: isPrimitive(result),
                    writable: true,
                    enumerable: true,
                    configurable: true,
                    argumentCount: obj instanceof Function ? obj.length : -1,
                    ...(isObject(ctx) && ctxKey != null ? Object.getOwnPropertyDescriptor(ctx, ctxKey) : {})
                }
            }
        },
        transfer: toTransfer
    };
}
// ============================================================================
// UNIFIED REQUEST HANDLER
// ============================================================================
/**
 * Handle request and return response (unified handler)
 */
export async function handleRequest(request, reqId, channelName, options) {
    const { channel, sender, path, action, args } = request;
    if (channel !== channelName)
        return null;
    const { result, toTransfer, path: newPath } = executeAction(action, path, args, { channel, sender, ...options });
    return buildResponse(reqId, action, channelName, sender, newPath, result, toTransfer);
}
// ============================================================================
// SIMPLE EXPOSE HANDLER (For Proxy module)
// ============================================================================
/**
 * Create a simple expose handler for an object
 *
 * Unlike the full executeAction, this works directly on the target
 * without DataBase integration. Used by Proxy.ts createExposeHandler.
 *
 * @param target - Object to expose
 * @param reflect - Optional custom Reflect implementation
 */
export function createObjectHandler(target, reflect = defaultReflect) {
    return async (action, path, args) => {
        // Navigate to the parent of the final property
        let parent = target;
        let current = target;
        for (let i = 0; i < path.length; i++) {
            parent = current;
            current = current?.[path[i]];
            if (current === undefined && i < path.length - 1) {
                throw new Error(`Path segment '${path[i]}' not found`);
            }
        }
        const prop = path[path.length - 1];
        const act = String(action).toLowerCase();
        // Handle actions directly on the resolved target
        switch (act) {
            case "get":
            case WReflectAction.GET:
                return current;
            case "set":
            case WReflectAction.SET:
                parent[prop] = args[0];
                return true;
            case "call":
            case "apply":
            case WReflectAction.APPLY:
            case WReflectAction.CALL:
                if (typeof current === "function") {
                    const callArgs = Array.isArray(args[0]) ? args[0] : args;
                    return await current.apply(parent, callArgs);
                }
                throw new Error(`'${prop}' is not a function`);
            case "construct":
            case WReflectAction.CONSTRUCT:
                if (typeof current === "function") {
                    const ctorArgs = Array.isArray(args[0]) ? args[0] : args;
                    return new current(...ctorArgs);
                }
                throw new Error(`'${prop}' is not a constructor`);
            case "has":
            case WReflectAction.HAS:
                return prop in parent;
            case "delete":
            case "deleteproperty":
            case WReflectAction.DELETE_PROPERTY:
                return delete parent[prop];
            case "ownkeys":
            case WReflectAction.OWN_KEYS:
                return Object.keys(current ?? parent);
            default:
                return current;
        }
    };
}
// ============================================================================
// EXPORTS
// ============================================================================
export { defaultReflect, isObject };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVxdWVzdEhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJSZXF1ZXN0SGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HO0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVyRyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDekQsT0FBTyxFQUNILFNBQVMsRUFDVCxVQUFVLEVBQ1YsZ0JBQWdCLEVBQ2hCLFlBQVksRUFDWixZQUFZLEVBQ1osV0FBVyxFQUNYLFlBQVksRUFDWixXQUFXLEVBQ2QsTUFBTSwwQkFBMEIsQ0FBQztBQTBEbEMsK0VBQStFO0FBQy9FLFVBQVU7QUFDViwrRUFBK0U7QUFFL0UsTUFBTSxRQUFRLEdBQUcsQ0FBQyxHQUFRLEVBQWlCLEVBQUUsQ0FDekMsQ0FBQyxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksT0FBTyxHQUFHLEtBQUssVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQztBQUUxRSxNQUFNLGNBQWMsR0FBZ0I7SUFDaEMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3JCLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVDLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3JCLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxD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O2dCQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxJQUFJLHFCQUFxQixDQUFDLENBQUM7WUFFbkQsS0FBSyxXQUFXLENBQUM7WUFDakIsS0FBSyxjQUFjLENBQUMsU0FBUztnQkFDekIsSUFBSSxPQUFPLE9BQU8sS0FBSyxVQUFVLEVBQUUsQ0FBQztvQkFDaEMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ3pELE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQztnQkFDcEMsQ0FBQztnQkFDRCxNQUFNLElBQUksS0FBSyxDQUFDLElBQUksSUFBSSx3QkFBd0IsQ0FBQyxDQUFDO1lBRXRELEtBQUssS0FBSyxDQUFDO1lBQ1gsS0FBSyxjQUFjLENBQUMsR0FBRztnQkFDbkIsT0FBTyxJQUFJLElBQUksTUFBTSxDQUFDO1lBRTFCLEtBQUssUUFBUSxDQUFDO1lBQ2QsS0FBSyxnQkFBZ0IsQ0FBQztZQUN0QixLQUFLLGNBQWMsQ0FBQyxlQUFlO2dCQUMvQixPQUFPLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRS9CLEtBQUssU0FBUyxDQUFDO1lBQ2YsS0FBSyxjQUFjLENBQUMsUUFBUTtnQkFDeEIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsQ0FBQztZQUUxQztnQkFDSSxPQUFPLE9BQU8sQ0FBQztRQUN2QixDQUFDO0lBQ0wsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQUVELCtFQUErRTtBQUMvRSxVQUFVO0FBQ1YsK0VBQStFO0FBRS9FLE9BQU8sRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFJlcXVlc3QgSGFuZGxlciBDb3JlIC0gVW5pZmllZCBSZWZsZWN0IEFjdGlvbiBIYW5kbGluZ1xuICpcbiAqIFNpbmdsZSBzb3VyY2Ugb2YgdHJ1dGggZm9yIGFsbCBhY3Rpb24gZXhlY3V0aW9uOlxuICogLSBVbmlmaWVkQ2hhbm5lbCwgQ2hhbm5lbENvbnRleHQsIFByb3h5IG1vZHVsZVxuICogLSBTdXBwb3J0cyBib3RoIERhdGFCYXNlLWJhY2tlZCBhbmQgZGlyZWN0IG9iamVjdCB0YXJnZXRzXG4gKiAtIFN1cHBvcnRzIGN1c3RvbSBSZWZsZWN0IGltcGxlbWVudGF0aW9uc1xuICovXG5cbmltcG9ydCB7IFVVSUR2NCwgZGVlcE9wZXJhdGVBbmRDbG9uZSwgaXNQcmltaXRpdmUsIGlzQ2FuSnVzdFJldHVybiwgaXNDYW5UcmFuc2ZlciB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB0eXBlIHsgV1JlZmxlY3REZXNjcmlwdG9yLCBXUmVxLCBXUmVzcCB9IGZyb20gXCIuLi9uZXh0L3R5cGVzL0ludGVyZmFjZVwiO1xuaW1wb3J0IHsgV1JlZmxlY3RBY3Rpb24gfSBmcm9tIFwiLi4vbmV4dC90eXBlcy9JbnRlcmZhY2VcIjtcbmltcG9ydCB7XG4gICAgaGFzTm9QYXRoLFxuICAgIHJlYWRCeVBhdGgsXG4gICAgcmVnaXN0ZXJlZEluUGF0aCxcbiAgICByZW1vdmVCeURhdGEsXG4gICAgcmVtb3ZlQnlQYXRoLFxuICAgIHdyaXRlQnlQYXRoLFxuICAgIG5vcm1hbGl6ZVJlZixcbiAgICBvYmplY3RUb1JlZlxufSBmcm9tIFwiLi4vbmV4dC9zdG9yYWdlL0RhdGFCYXNlXCI7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdENvbnRleHQge1xuICAgIGNoYW5uZWw6IHN0cmluZztcbiAgICBzZW5kZXI6IHN0cmluZztcbiAgICBwYXRoOiBzdHJpbmdbXTtcbiAgICBhY3Rpb246IHN0cmluZztcbiAgICBhcmdzOiBhbnlbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZXNwb25zZUJ1aWxkZXIge1xuICAgIHJlc3VsdDogYW55O1xuICAgIHBhdGg6IHN0cmluZ1tdO1xuICAgIHRvVHJhbnNmZXI6IGFueVtdO1xuICAgIGNhbkJlUmV0dXJuOiBib29sZWFuO1xufVxuXG4vKiogUmVmbGVjdC1saWtlIGludGVyZmFjZSBmb3IgY3VzdG9tIGltcGxlbWVudGF0aW9ucyAqL1xuZXhwb3J0IGludGVyZmFjZSBSZWZsZWN0TGlrZSB7XG4gICAgZ2V0Pyh0YXJnZXQ6IGFueSwgcHJvcDogUHJvcGVydHlLZXkpOiBhbnk7XG4gICAgc2V0Pyh0YXJnZXQ6IGFueSwgcHJvcDogUHJvcGVydHlLZXksIHZhbHVlOiBhbnkpOiBib29sZWFuO1xuICAgIGhhcz8odGFyZ2V0OiBhbnksIHByb3A6IFByb3BlcnR5S2V5KTogYm9vbGVhbjtcbiAgICBhcHBseT8odGFyZ2V0OiBhbnksIHRoaXNBcmc6IGFueSwgYXJnczogYW55W10pOiBhbnk7XG4gICAgY29uc3RydWN0Pyh0YXJnZXQ6IGFueSwgYXJnczogYW55W10pOiBhbnk7XG4gICAgZGVsZXRlUHJvcGVydHk/KHRhcmdldDogYW55LCBwcm9wOiBQcm9wZXJ0eUtleSk6IGJvb2xlYW47XG4gICAgb3duS2V5cz8odGFyZ2V0OiBhbnkpOiAoc3RyaW5nIHwgc3ltYm9sKVtdO1xuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcj8odGFyZ2V0OiBhbnksIHByb3A6IFByb3BlcnR5S2V5KTogUHJvcGVydHlEZXNjcmlwdG9yIHwgdW5kZWZpbmVkO1xuICAgIGdldFByb3RvdHlwZU9mPyh0YXJnZXQ6IGFueSk6IG9iamVjdCB8IG51bGw7XG4gICAgc2V0UHJvdG90eXBlT2Y/KHRhcmdldDogYW55LCBwcm90bzogb2JqZWN0IHwgbnVsbCk6IGJvb2xlYW47XG4gICAgaXNFeHRlbnNpYmxlPyh0YXJnZXQ6IGFueSk6IGJvb2xlYW47XG4gICAgcHJldmVudEV4dGVuc2lvbnM/KHRhcmdldDogYW55KTogYm9vbGVhbjtcbn1cblxuLyoqIEFjdGlvbiBleGVjdXRpb24gb3B0aW9ucyAqL1xuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRlT3B0aW9ucyB7XG4gICAgLyoqIENoYW5uZWwgbmFtZSBmb3IgdHJhbnNmZXIgY2hlY2tzICovXG4gICAgY2hhbm5lbD86IHN0cmluZztcbiAgICAvKiogU2VuZGVyIG5hbWUgZm9yIHRyYW5zZmVyIGNoZWNrcyAqL1xuICAgIHNlbmRlcj86IHN0cmluZztcbiAgICAvKiogQ3VzdG9tIFJlZmxlY3QgaW1wbGVtZW50YXRpb24gKi9cbiAgICByZWZsZWN0PzogUmVmbGVjdExpa2U7XG4gICAgLyoqIERpcmVjdCB0YXJnZXQgb2JqZWN0IChieXBhc3NlcyBEYXRhQmFzZSkgKi9cbiAgICB0YXJnZXQ/OiBhbnk7XG4gICAgLyoqIENvbnRleHQgb2JqZWN0IGZvciBmdW5jdGlvbiBiaW5kaW5nICovXG4gICAgY29udGV4dD86IGFueTtcbn1cblxuLyoqIEFjdGlvbiBleGVjdXRpb24gcmVzdWx0ICovXG5leHBvcnQgaW50ZXJmYWNlIEV4ZWN1dGVSZXN1bHQge1xuICAgIHJlc3VsdDogYW55O1xuICAgIHRvVHJhbnNmZXI6IGFueVtdO1xuICAgIHBhdGg6IHN0cmluZ1tdO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBIRUxQRVJTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmNvbnN0IGlzT2JqZWN0ID0gKG9iajogYW55KTogb2JqIGlzIG9iamVjdCA9PlxuICAgICh0eXBlb2Ygb2JqID09PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBvYmogPT09IFwiZnVuY3Rpb25cIikgJiYgb2JqICE9IG51bGw7XG5cbmNvbnN0IGRlZmF1bHRSZWZsZWN0OiBSZWZsZWN0TGlrZSA9IHtcbiAgICBnZXQ6ICh0LCBwKSA9PiB0Py5bcF0sXG4gICAgc2V0OiAodCwgcCwgdikgPT4geyB0W3BdID0gdjsgcmV0dXJuIHRydWU7IH0sXG4gICAgaGFzOiAodCwgcCkgPT4gcCBpbiB0LFxuICAgIGFwcGx5OiAodCwgY3R4LCBhcmdzKSA9PiB0LmFwcGx5KGN0eCwgYXJncyksXG4gICAgY29uc3RydWN0OiAodCwgYXJncykgPT4gbmV3IHQoLi4uYXJncyksXG4gICAgZGVsZXRlUHJvcGVydHk6ICh0LCBwKSA9PiBkZWxldGUgdFtwXSxcbiAgICBvd25LZXlzOiAodCkgPT4gT2JqZWN0LmtleXModCksXG4gICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOiAodCwgcCkgPT4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCBwKSxcbiAgICBnZXRQcm90b3R5cGVPZjogKHQpID0+IE9iamVjdC5nZXRQcm90b3R5cGVPZih0KSxcbiAgICBzZXRQcm90b3R5cGVPZjogKHQsIHApID0+IE9iamVjdC5zZXRQcm90b3R5cGVPZih0LCBwKSxcbiAgICBpc0V4dGVuc2libGU6ICh0KSA9PiBPYmplY3QuaXNFeHRlbnNpYmxlKHQpLFxuICAgIHByZXZlbnRFeHRlbnNpb25zOiAodCkgPT4gT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHQpXG59O1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBVTklGSUVEIEFDVElPTiBFWEVDVVRPUlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIEV4ZWN1dGUgYSByZWZsZWN0IGFjdGlvblxuICpcbiAqIFVuaWZpZWQgaW1wbGVtZW50YXRpb24gdXNlZCBieSBhbGwgY2hhbm5lbC9wcm94eSBoYW5kbGVycy5cbiAqIFN1cHBvcnRzIGJvdGggRGF0YUJhc2UtYmFja2VkIHBhdGhzIGFuZCBkaXJlY3Qgb2JqZWN0IHRhcmdldHMuXG4gKlxuICogQHBhcmFtIGFjdGlvbiAtIEFjdGlvbiB0byBleGVjdXRlIChXUmVmbGVjdEFjdGlvbiBvciBzdHJpbmcpXG4gKiBAcGFyYW0gcGF0aCAtIE9iamVjdCBwYXRoXG4gKiBAcGFyYW0gYXJncyAtIEFjdGlvbiBhcmd1bWVudHNcbiAqIEBwYXJhbSBvcHRpb25zIC0gRXhlY3V0aW9uIG9wdGlvbnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVBY3Rpb24oXG4gICAgYWN0aW9uOiBXUmVmbGVjdEFjdGlvbiB8IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmdbXSxcbiAgICBhcmdzOiBhbnlbXSxcbiAgICBvcHRpb25zOiBFeGVjdXRlT3B0aW9ucyA9IHt9XG4pOiBFeGVjdXRlUmVzdWx0IHtcbiAgICBjb25zdCB7IGNoYW5uZWwgPSBcIlwiLCBzZW5kZXIgPSBcIlwiLCByZWZsZWN0ID0gZGVmYXVsdFJlZmxlY3QgfSA9IG9wdGlvbnM7XG5cbiAgICAvLyBHZXQgdGFyZ2V0OiBmcm9tIG9wdGlvbnMgb3IgRGF0YUJhc2VcbiAgICBjb25zdCBvYmogPSBvcHRpb25zLnRhcmdldCA/PyByZWFkQnlQYXRoKHBhdGgpO1xuICAgIGNvbnN0IHRvVHJhbnNmZXI6IGFueVtdID0gW107XG4gICAgbGV0IHJlc3VsdDogYW55ID0gbnVsbDtcbiAgICBsZXQgbmV3UGF0aCA9IHBhdGg7XG5cbiAgICAvLyBOb3JtYWxpemUgYWN0aW9uIHN0cmluZ1xuICAgIGNvbnN0IGFjdCA9IFN0cmluZyhhY3Rpb24pLnRvTG93ZXJDYXNlKCk7XG5cbiAgICBzd2l0Y2ggKGFjdCkge1xuICAgICAgICBjYXNlIFwiaW1wb3J0XCI6XG4gICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uSU1QT1JUOlxuICAgICAgICAgICAgcmVzdWx0ID0gaW1wb3J0KGFyZ3M/LlswXSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwidHJhbnNmZXJcIjpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5UUkFOU0ZFUjpcbiAgICAgICAgICAgIGlmIChpc0NhblRyYW5zZmVyKG9iaikgJiYgY2hhbm5lbCAhPT0gc2VuZGVyKSB7XG4gICAgICAgICAgICAgICAgdG9UcmFuc2Zlci5wdXNoKG9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQgPSBvYmo7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwiZ2V0XCI6XG4gICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uR0VUOiB7XG4gICAgICAgICAgICBjb25zdCBwcm9wID0gYXJncz8uWzBdO1xuICAgICAgICAgICAgY29uc3QgZ290ID0gcmVmbGVjdC5nZXQ/LihvYmosIHByb3ApID8/IG9iaj8uW3Byb3BdO1xuICAgICAgICAgICAgcmVzdWx0ID0gdHlwZW9mIGdvdCA9PT0gXCJmdW5jdGlvblwiICYmIG9iaiAhPSBudWxsID8gZ290LmJpbmQob2JqKSA6IGdvdDtcbiAgICAgICAgICAgIG5ld1BhdGggPSBbLi4ucGF0aCwgU3RyaW5nKHByb3ApXTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgY2FzZSBcInNldFwiOlxuICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLlNFVDoge1xuICAgICAgICAgICAgY29uc3QgW3Byb3AsIHZhbHVlXSA9IGFyZ3M7XG4gICAgICAgICAgICBjb25zdCBub3JtYWxpemVkVmFsdWUgPSBkZWVwT3BlcmF0ZUFuZENsb25lKHZhbHVlLCBub3JtYWxpemVSZWYpO1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMudGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVmbGVjdC5zZXQ/LihvYmosIHByb3AsIG5vcm1hbGl6ZWRWYWx1ZSkgPz8gKG9ialtwcm9wXSA9IG5vcm1hbGl6ZWRWYWx1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlZmxlY3Quc2V0Py4ob2JqLCBwcm9wLCBub3JtYWxpemVkVmFsdWUpID8/XG4gICAgICAgICAgICAgICAgICAgIHdyaXRlQnlQYXRoKFsuLi5wYXRoLCBTdHJpbmcocHJvcCldLCBub3JtYWxpemVkVmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBjYXNlIFwiYXBwbHlcIjpcbiAgICAgICAgY2FzZSBcImNhbGxcIjpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5BUFBMWTpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5DQUxMOiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3R4ID0gb3B0aW9ucy5jb250ZXh0ID8/IChvcHRpb25zLnRhcmdldCA/IHVuZGVmaW5lZCA6IHJlYWRCeVBhdGgocGF0aC5zbGljZSgwLCAtMSkpKTtcbiAgICAgICAgICAgICAgICBjb25zdCBub3JtYWxpemVkQXJncyA9IGRlZXBPcGVyYXRlQW5kQ2xvbmUoYXJncz8uWzBdID8/IGFyZ3MgPz8gW10sIG5vcm1hbGl6ZVJlZik7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVmbGVjdC5hcHBseT8uKG9iaiwgY3R4LCBub3JtYWxpemVkQXJncykgPz8gb2JqLmFwcGx5KGN0eCwgbm9ybWFsaXplZEFyZ3MpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzQ2FuVHJhbnNmZXIocmVzdWx0KSAmJiBwYXRoPy5hdCgtMSkgPT09IFwidHJhbnNmZXJcIiAmJiBjaGFubmVsICE9PSBzZW5kZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdG9UcmFuc2Zlci5wdXNoKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBjYXNlIFwiY29uc3RydWN0XCI6XG4gICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uQ09OU1RSVUNUOiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZEFyZ3MgPSBkZWVwT3BlcmF0ZUFuZENsb25lKGFyZ3M/LlswXSA/PyBhcmdzID8/IFtdLCBub3JtYWxpemVSZWYpO1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlZmxlY3QuY29uc3RydWN0Py4ob2JqLCBub3JtYWxpemVkQXJncykgPz8gbmV3IG9iaiguLi5ub3JtYWxpemVkQXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGNhc2UgXCJkZWxldGVcIjpcbiAgICAgICAgY2FzZSBcImRlbGV0ZXByb3BlcnR5XCI6XG4gICAgICAgIGNhc2UgXCJkaXNwb3NlXCI6XG4gICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uREVMRVRFOlxuICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLkRFTEVURV9QUk9QRVJUWTpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5ESVNQT1NFOlxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJvcCA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSByZWZsZWN0LmRlbGV0ZVByb3BlcnR5Py4ob2JqLCBwcm9wKSA/PyBkZWxldGUgb2JqW3Byb3BdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBwYXRoPy5sZW5ndGggPiAwID8gcmVtb3ZlQnlQYXRoKHBhdGgpIDogcmVtb3ZlQnlEYXRhKG9iaik7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkgbmV3UGF0aCA9IHJlZ2lzdGVyZWRJblBhdGguZ2V0KG9iaikgPz8gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwiaGFzXCI6XG4gICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uSEFTOlxuICAgICAgICAgICAgcmVzdWx0ID0gcmVmbGVjdC5oYXM/LihvYmosIGFyZ3M/LlswXSkgPz8gKGlzT2JqZWN0KG9iaikgPyBhcmdzPy5bMF0gaW4gb2JqIDogZmFsc2UpO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBcIm93bmtleXNcIjpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5PV05fS0VZUzpcbiAgICAgICAgICAgIHJlc3VsdCA9IHJlZmxlY3Qub3duS2V5cz8uKG9iaikgPz8gKGlzT2JqZWN0KG9iaikgPyBPYmplY3Qua2V5cyhvYmopIDogW10pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBcImdldG93bnByb3BlcnR5ZGVzY3JpcHRvclwiOlxuICAgICAgICBjYXNlIFwiZ2V0cHJvcGVydHlkZXNjcmlwdG9yXCI6XG4gICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uR0VUX09XTl9QUk9QRVJUWV9ERVNDUklQVE9SOlxuICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLkdFVF9QUk9QRVJUWV9ERVNDUklQVE9SOlxuICAgICAgICAgICAgcmVzdWx0ID0gcmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3I/LihvYmosIGFyZ3M/LlswXSA/PyBwYXRoPy5hdCgtMSkgPz8gXCJcIikgPz9cbiAgICAgICAgICAgICAgICAoaXNPYmplY3Qob2JqKSA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBhcmdzPy5bMF0gPz8gcGF0aD8uYXQoLTEpID8/IFwiXCIpIDogdW5kZWZpbmVkKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgXCJnZXRwcm90b3R5cGVvZlwiOlxuICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLkdFVF9QUk9UT1RZUEVfT0Y6XG4gICAgICAgICAgICByZXN1bHQgPSByZWZsZWN0LmdldFByb3RvdHlwZU9mPy4ob2JqKSA/PyAoaXNPYmplY3Qob2JqKSA/IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopIDogbnVsbCk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwic2V0cHJvdG90eXBlb2ZcIjpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5TRVRfUFJPVE9UWVBFX09GOlxuICAgICAgICAgICAgcmVzdWx0ID0gcmVmbGVjdC5zZXRQcm90b3R5cGVPZj8uKG9iaiwgYXJncz8uWzBdKSA/P1xuICAgICAgICAgICAgICAgIChpc09iamVjdChvYmopID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKG9iaiwgYXJncz8uWzBdKSA6IGZhbHNlKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgXCJpc2V4dGVuc2libGVcIjpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5JU19FWFRFTlNJQkxFOlxuICAgICAgICAgICAgcmVzdWx0ID0gcmVmbGVjdC5pc0V4dGVuc2libGU/LihvYmopID8/IChpc09iamVjdChvYmopID8gT2JqZWN0LmlzRXh0ZW5zaWJsZShvYmopIDogdHJ1ZSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwicHJldmVudGV4dGVuc2lvbnNcIjpcbiAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5QUkVWRU5UX0VYVEVOU0lPTlM6XG4gICAgICAgICAgICByZXN1bHQgPSByZWZsZWN0LnByZXZlbnRFeHRlbnNpb25zPy4ob2JqKSA/P1xuICAgICAgICAgICAgICAgIChpc09iamVjdChvYmopID8gT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKG9iaikgOiBmYWxzZSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4geyByZXN1bHQsIHRvVHJhbnNmZXIsIHBhdGg6IG5ld1BhdGggfTtcbn1cblxuLyoqXG4gKiBFeGVjdXRlIGFjdGlvbiB3aXRoIGFzeW5jIHJlc3VsdCByZXNvbHV0aW9uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjdXRlQWN0aW9uQXN5bmMoXG4gICAgYWN0aW9uOiBXUmVmbGVjdEFjdGlvbiB8IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmdbXSxcbiAgICBhcmdzOiBhbnlbXSxcbiAgICBvcHRpb25zOiBFeGVjdXRlT3B0aW9ucyA9IHt9XG4pOiBQcm9taXNlPEV4ZWN1dGVSZXN1bHQ+IHtcbiAgICBjb25zdCB7IHJlc3VsdCwgdG9UcmFuc2ZlciwgcGF0aDogbmV3UGF0aCB9ID0gZXhlY3V0ZUFjdGlvbihhY3Rpb24sIHBhdGgsIGFyZ3MsIG9wdGlvbnMpO1xuICAgIHJldHVybiB7IHJlc3VsdDogYXdhaXQgcmVzdWx0LCB0b1RyYW5zZmVyLCBwYXRoOiBuZXdQYXRoIH07XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFJFU1BPTlNFIEJVSUxERVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBCdWlsZCByZXNwb25zZSBvYmplY3Qgd2l0aCBkZXNjcmlwdG9yXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidWlsZFJlc3BvbnNlKFxuICAgIHJlcUlkOiBzdHJpbmcsXG4gICAgYWN0aW9uOiBzdHJpbmcsXG4gICAgY2hhbm5lbDogc3RyaW5nLFxuICAgIHNlbmRlcjogc3RyaW5nLFxuICAgIHBhdGg6IHN0cmluZ1tdLFxuICAgIHJhd1Jlc3VsdDogYW55LFxuICAgIHRvVHJhbnNmZXI6IGFueVtdXG4pOiBQcm9taXNlPHsgcmVzcG9uc2U6IGFueTsgdHJhbnNmZXI6IGFueVtdIH0+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByYXdSZXN1bHQ7XG5cbiAgICBjb25zdCBjYW5CZVJldHVybiA9IChpc0NhblRyYW5zZmVyKHJlc3VsdCkgJiYgdG9UcmFuc2Zlci5pbmNsdWRlcyhyZXN1bHQpKSB8fCBpc0Nhbkp1c3RSZXR1cm4ocmVzdWx0KTtcblxuICAgIC8vIEdlbmVyYXRlIHRlbXAgcGF0aCBpZiBuZWVkZWRcbiAgICBsZXQgZmluYWxQYXRoID0gcGF0aDtcbiAgICBpZiAoIWNhbkJlUmV0dXJuICYmIGFjdGlvbiAhPT0gXCJnZXRcIiAmJiBhY3Rpb24gIT09IFdSZWZsZWN0QWN0aW9uLkdFVCAmJlxuICAgICAgICAodHlwZW9mIHJlc3VsdCA9PT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgcmVzdWx0ID09PSBcImZ1bmN0aW9uXCIpKSB7XG4gICAgICAgIGlmIChoYXNOb1BhdGgocmVzdWx0KSkge1xuICAgICAgICAgICAgZmluYWxQYXRoID0gW1VVSUR2NCgpXTtcbiAgICAgICAgICAgIHdyaXRlQnlQYXRoKGZpbmFsUGF0aCwgcmVzdWx0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZpbmFsUGF0aCA9IHJlZ2lzdGVyZWRJblBhdGguZ2V0KHJlc3VsdCkgPz8gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBjdHggPSByZWFkQnlQYXRoKGZpbmFsUGF0aCk7XG4gICAgY29uc3QgY3R4S2V5ID0gKGFjdGlvbiA9PT0gXCJnZXRcIiB8fCBhY3Rpb24gPT09IFdSZWZsZWN0QWN0aW9uLkdFVCkgPyBmaW5hbFBhdGg/LmF0KC0xKSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCBvYmogPSByZWFkQnlQYXRoKHBhdGgpO1xuXG4gICAgY29uc3QgcGF5bG9hZCA9IGRlZXBPcGVyYXRlQW5kQ2xvbmUocmVzdWx0LCAoZWwpID0+IG9iamVjdFRvUmVmKGVsLCBjaGFubmVsLCB0b1RyYW5zZmVyKSkgPz8gcmVzdWx0O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIGNoYW5uZWw6IHNlbmRlcixcbiAgICAgICAgICAgIHNlbmRlcjogY2hhbm5lbCxcbiAgICAgICAgICAgIHJlcUlkLFxuICAgICAgICAgICAgYWN0aW9uLFxuICAgICAgICAgICAgdHlwZTogXCJyZXNwb25zZVwiLFxuICAgICAgICAgICAgcGF5bG9hZDoge1xuICAgICAgICAgICAgICAgIHJlc3VsdDogY2FuQmVSZXR1cm4gPyBwYXlsb2FkIDogbnVsbCxcbiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlb2YgcmVzdWx0LFxuICAgICAgICAgICAgICAgIGNoYW5uZWw6IHNlbmRlcixcbiAgICAgICAgICAgICAgICBzZW5kZXI6IGNoYW5uZWwsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRvcjoge1xuICAgICAgICAgICAgICAgICAgICAkaXNEZXNjcmlwdG9yOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBwYXRoOiBmaW5hbFBhdGgsXG4gICAgICAgICAgICAgICAgICAgIG93bmVyOiBjaGFubmVsLFxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsLFxuICAgICAgICAgICAgICAgICAgICBwcmltaXRpdmU6IGlzUHJpbWl0aXZlKHJlc3VsdCksXG4gICAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50Q291bnQ6IG9iaiBpbnN0YW5jZW9mIEZ1bmN0aW9uID8gb2JqLmxlbmd0aCA6IC0xLFxuICAgICAgICAgICAgICAgICAgICAuLi4oaXNPYmplY3QoY3R4KSAmJiBjdHhLZXkgIT0gbnVsbCA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY3R4LCBjdHhLZXkpIDoge30pXG4gICAgICAgICAgICAgICAgfSBhcyBXUmVmbGVjdERlc2NyaXB0b3I8YW55PlxuICAgICAgICAgICAgfSBhcyBXUmVzcDxhbnk+XG4gICAgICAgIH0sXG4gICAgICAgIHRyYW5zZmVyOiB0b1RyYW5zZmVyXG4gICAgfTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVU5JRklFRCBSRVFVRVNUIEhBTkRMRVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBIYW5kbGUgcmVxdWVzdCBhbmQgcmV0dXJuIHJlc3BvbnNlICh1bmlmaWVkIGhhbmRsZXIpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0KFxuICAgIHJlcXVlc3Q6IFdSZXEsXG4gICAgcmVxSWQ6IHN0cmluZyxcbiAgICBjaGFubmVsTmFtZTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBFeGVjdXRlT3B0aW9uc1xuKTogUHJvbWlzZTx7IHJlc3BvbnNlOiBhbnk7IHRyYW5zZmVyOiBhbnlbXSB9IHwgbnVsbD4ge1xuICAgIGNvbnN0IHsgY2hhbm5lbCwgc2VuZGVyLCBwYXRoLCBhY3Rpb24sIGFyZ3MgfSA9IHJlcXVlc3Q7XG5cbiAgICBpZiAoY2hhbm5lbCAhPT0gY2hhbm5lbE5hbWUpIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgeyByZXN1bHQsIHRvVHJhbnNmZXIsIHBhdGg6IG5ld1BhdGggfSA9IGV4ZWN1dGVBY3Rpb24oXG4gICAgICAgIGFjdGlvbixcbiAgICAgICAgcGF0aCxcbiAgICAgICAgYXJncyxcbiAgICAgICAgeyBjaGFubmVsLCBzZW5kZXIsIC4uLm9wdGlvbnMgfVxuICAgICk7XG5cbiAgICByZXR1cm4gYnVpbGRSZXNwb25zZShyZXFJZCwgYWN0aW9uLCBjaGFubmVsTmFtZSwgc2VuZGVyLCBuZXdQYXRoLCByZXN1bHQsIHRvVHJhbnNmZXIpO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBTSU1QTEUgRVhQT1NFIEhBTkRMRVIgKEZvciBQcm94eSBtb2R1bGUpXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogQ3JlYXRlIGEgc2ltcGxlIGV4cG9zZSBoYW5kbGVyIGZvciBhbiBvYmplY3RcbiAqXG4gKiBVbmxpa2UgdGhlIGZ1bGwgZXhlY3V0ZUFjdGlvbiwgdGhpcyB3b3JrcyBkaXJlY3RseSBvbiB0aGUgdGFyZ2V0XG4gKiB3aXRob3V0IERhdGFCYXNlIGludGVncmF0aW9uLiBVc2VkIGJ5IFByb3h5LnRzIGNyZWF0ZUV4cG9zZUhhbmRsZXIuXG4gKlxuICogQHBhcmFtIHRhcmdldCAtIE9iamVjdCB0byBleHBvc2VcbiAqIEBwYXJhbSByZWZsZWN0IC0gT3B0aW9uYWwgY3VzdG9tIFJlZmxlY3QgaW1wbGVtZW50YXRpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZU9iamVjdEhhbmRsZXI8VCBleHRlbmRzIG9iamVjdD4oXG4gICAgdGFyZ2V0OiBULFxuICAgIHJlZmxlY3Q6IFJlZmxlY3RMaWtlID0gZGVmYXVsdFJlZmxlY3Rcbik6IChhY3Rpb246IHN0cmluZywgcGF0aDogc3RyaW5nW10sIGFyZ3M6IGFueVtdKSA9PiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBhc3luYyAoYWN0aW9uLCBwYXRoLCBhcmdzKSA9PiB7XG4gICAgICAgIC8vIE5hdmlnYXRlIHRvIHRoZSBwYXJlbnQgb2YgdGhlIGZpbmFsIHByb3BlcnR5XG4gICAgICAgIGxldCBwYXJlbnQ6IGFueSA9IHRhcmdldDtcbiAgICAgICAgbGV0IGN1cnJlbnQ6IGFueSA9IHRhcmdldDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHBhcmVudCA9IGN1cnJlbnQ7XG4gICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudD8uW3BhdGhbaV1dO1xuICAgICAgICAgICAgaWYgKGN1cnJlbnQgPT09IHVuZGVmaW5lZCAmJiBpIDwgcGF0aC5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXRoIHNlZ21lbnQgJyR7cGF0aFtpXX0nIG5vdCBmb3VuZGApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcHJvcCA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcbiAgICAgICAgY29uc3QgYWN0ID0gU3RyaW5nKGFjdGlvbikudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAvLyBIYW5kbGUgYWN0aW9ucyBkaXJlY3RseSBvbiB0aGUgcmVzb2x2ZWQgdGFyZ2V0XG4gICAgICAgIHN3aXRjaCAoYWN0KSB7XG4gICAgICAgICAgICBjYXNlIFwiZ2V0XCI6XG4gICAgICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLkdFVDpcbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDtcblxuICAgICAgICAgICAgY2FzZSBcInNldFwiOlxuICAgICAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5TRVQ6XG4gICAgICAgICAgICAgICAgcGFyZW50W3Byb3BdID0gYXJnc1swXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcblxuICAgICAgICAgICAgY2FzZSBcImNhbGxcIjpcbiAgICAgICAgICAgIGNhc2UgXCJhcHBseVwiOlxuICAgICAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5BUFBMWTpcbiAgICAgICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uQ0FMTDpcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGN1cnJlbnQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWxsQXJncyA9IEFycmF5LmlzQXJyYXkoYXJnc1swXSkgPyBhcmdzWzBdIDogYXJncztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGN1cnJlbnQuYXBwbHkocGFyZW50LCBjYWxsQXJncyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7cHJvcH0nIGlzIG5vdCBhIGZ1bmN0aW9uYCk7XG5cbiAgICAgICAgICAgIGNhc2UgXCJjb25zdHJ1Y3RcIjpcbiAgICAgICAgICAgIGNhc2UgV1JlZmxlY3RBY3Rpb24uQ09OU1RSVUNUOlxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY3VycmVudCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN0b3JBcmdzID0gQXJyYXkuaXNBcnJheShhcmdzWzBdKSA/IGFyZ3NbMF0gOiBhcmdzO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGN1cnJlbnQoLi4uY3RvckFyZ3MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke3Byb3B9JyBpcyBub3QgYSBjb25zdHJ1Y3RvcmApO1xuXG4gICAgICAgICAgICBjYXNlIFwiaGFzXCI6XG4gICAgICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLkhBUzpcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvcCBpbiBwYXJlbnQ7XG5cbiAgICAgICAgICAgIGNhc2UgXCJkZWxldGVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJkZWxldGVwcm9wZXJ0eVwiOlxuICAgICAgICAgICAgY2FzZSBXUmVmbGVjdEFjdGlvbi5ERUxFVEVfUFJPUEVSVFk6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZSBwYXJlbnRbcHJvcF07XG5cbiAgICAgICAgICAgIGNhc2UgXCJvd25rZXlzXCI6XG4gICAgICAgICAgICBjYXNlIFdSZWZsZWN0QWN0aW9uLk9XTl9LRVlTOlxuICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhjdXJyZW50ID8/IHBhcmVudCk7XG5cbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgICAgIH1cbiAgICB9O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBFWFBPUlRTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCB7IGRlZmF1bHRSZWZsZWN0LCBpc09iamVjdCB9O1xuIl19