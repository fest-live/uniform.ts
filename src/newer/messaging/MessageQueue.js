/**
 * Generic Message Queue Utility
 * Provides persistent queuing for cross-context communications using IndexedDB
 * Part of fest/uniform - no app-specific dependencies
 */
// ============================================================================
// MESSAGE QUEUE CLASS
// ============================================================================
export class MessageQueue {
    db = null;
    dbPromise = null;
    options;
    constructor(options = {}) {
        this.options = {
            dbName: options.dbName ?? 'UniformMessageQueue',
            storeName: options.storeName ?? 'messages',
            maxRetries: options.maxRetries ?? 3,
            defaultExpirationMs: options.defaultExpirationMs ?? 24 * 60 * 60 * 1000, // 24 hours
            fallbackStorageKey: options.fallbackStorageKey ?? 'uniform_message_queue'
        };
    }
    // ========================================================================
    // DATABASE INITIALIZATION
    // ========================================================================
    /**
     * Initialize IndexedDB database
     */
    async initDB() {
        if (this.db)
            return this.db;
        if (this.dbPromise)
            return this.dbPromise;
        // Check if IndexedDB is available
        if (!MessageQueue.isIndexedDBAvailable()) {
            console.warn('[MessageQueue] IndexedDB not available, using sessionStorage fallback');
            return null;
        }
        this.dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(this.options.dbName, 1);
            request.onerror = () => {
                console.warn('[MessageQueue] IndexedDB open failed, falling back to sessionStorage');
                reject(new Error('IndexedDB not available'));
            };
            request.onsuccess = () => {
                this.db = request.result;
                resolve(this.db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.options.storeName)) {
                    const store = db.createObjectStore(this.options.storeName, { keyPath: 'id' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                    store.createIndex('type', 'type', { unique: false });
                    store.createIndex('priority', 'priority', { unique: false });
                    store.createIndex('destination', 'destination', { unique: false });
                }
            };
        });
        try {
            this.db = await this.dbPromise;
            return this.db;
        }
        catch {
            // Fallback to sessionStorage if IndexedDB fails
            return null;
        }
    }
    // ========================================================================
    // QUEUE OPERATIONS
    // ========================================================================
    /**
     * Generate unique message ID
     */
    generateId() {
        return `msg_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`;
    }
    /**
     * Queue a message for later processing
     */
    async queueMessage(type, data, options = {}) {
        const message = {
            id: this.generateId(),
            type,
            data,
            timestamp: Date.now(),
            priority: options.priority ?? 'normal',
            retryCount: 0,
            maxRetries: options.maxRetries ?? this.options.maxRetries,
            expiresAt: options.expiresAt ?? (Date.now() + this.options.defaultExpirationMs),
            destination: options.destination,
            metadata: options.metadata
        };
        try {
            const db = await this.initDB();
            if (db) {
                await this.addToIndexedDB(db, message);
            }
            else {
                this.addToSessionStorage(message);
            }
            console.log(`[MessageQueue] Queued message: ${type}`, message.id);
            return message.id;
        }
        catch (error) {
            console.error('[MessageQueue] Failed to queue message:', error);
            throw error;
        }
    }
    /**
     * Get all queued messages
     */
    async getQueuedMessages(destination) {
        try {
            const db = await this.initDB();
            let messages;
            if (db) {
                messages = await this.getAllFromIndexedDB(db);
            }
            else {
                messages = this.getAllFromSessionStorage();
            }
            // Filter by destination if specified
            if (destination) {
                messages = messages.filter(msg => msg.destination === destination);
            }
            // Filter out expired messages
            const now = Date.now();
            return messages.filter(msg => !msg.expiresAt || msg.expiresAt > now);
        }
        catch (error) {
            console.error('[MessageQueue] Failed to get queued messages:', error);
            return this.getAllFromSessionStorage();
        }
    }
    /**
     * Remove a message from the queue
     */
    async removeMessage(messageId) {
        try {
            const db = await this.initDB();
            if (db) {
                await this.deleteFromIndexedDB(db, messageId);
            }
            else {
                this.deleteFromSessionStorage(messageId);
            }
        }
        catch (error) {
            console.error('[MessageQueue] Failed to remove message:', error);
        }
    }
    /**
     * Update message retry count
     */
    async updateMessageRetry(messageId, retryCount) {
        try {
            const db = await this.initDB();
            if (db) {
                await this.updateInIndexedDB(db, messageId, { retryCount });
            }
            else {
                this.updateInSessionStorage(messageId, { retryCount });
            }
        }
        catch (error) {
            console.error('[MessageQueue] Failed to update message retry:', error);
        }
    }
    /**
     * Clear all expired messages
     */
    async clearExpiredMessages() {
        try {
            const messages = await this.getQueuedMessages();
            const now = Date.now();
            const expiredIds = messages
                .filter(msg => msg.expiresAt && msg.expiresAt <= now)
                .map(msg => msg.id);
            for (const id of expiredIds) {
                await this.removeMessage(id);
            }
            if (expiredIds.length > 0) {
                console.log(`[MessageQueue] Cleared ${expiredIds.length} expired messages`);
            }
            return expiredIds.length;
        }
        catch (error) {
            console.error('[MessageQueue] Failed to clear expired messages:', error);
            return 0;
        }
    }
    /**
     * Clear all messages
     */
    async clearAll() {
        try {
            const db = await this.initDB();
            if (db) {
                await this.clearIndexedDB(db);
            }
            else {
                sessionStorage.removeItem(this.options.fallbackStorageKey);
            }
            console.log('[MessageQueue] Cleared all messages');
        }
        catch (error) {
            console.error('[MessageQueue] Failed to clear all messages:', error);
        }
    }
    /**
     * Get queue statistics
     */
    async getStats() {
        const messages = await this.getQueuedMessages();
        const now = Date.now();
        const byPriority = { low: 0, normal: 0, high: 0 };
        const byDestination = {};
        let expired = 0;
        for (const msg of messages) {
            byPriority[msg.priority]++;
            if (msg.destination) {
                byDestination[msg.destination] = (byDestination[msg.destination] || 0) + 1;
            }
            if (msg.expiresAt && msg.expiresAt <= now) {
                expired++;
            }
        }
        return {
            total: messages.length,
            byPriority,
            byDestination,
            expired
        };
    }
    // ========================================================================
    // INDEXEDDB OPERATIONS
    // ========================================================================
    async addToIndexedDB(db, message) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.options.storeName], 'readwrite');
            const store = transaction.objectStore(this.options.storeName);
            const request = store.add(message);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    async getAllFromIndexedDB(db) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.options.storeName], 'readonly');
            const store = transaction.objectStore(this.options.storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
    async deleteFromIndexedDB(db, id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.options.storeName], 'readwrite');
            const store = transaction.objectStore(this.options.storeName);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    async updateInIndexedDB(db, id, updates) {
        const transaction = db.transaction([this.options.storeName], 'readwrite');
        const store = transaction.objectStore(this.options.storeName);
        const message = await new Promise((resolve, reject) => {
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
        if (message) {
            Object.assign(message, updates);
            await new Promise((resolve, reject) => {
                const request = store.put(message);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
    }
    async clearIndexedDB(db) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([this.options.storeName], 'readwrite');
            const store = transaction.objectStore(this.options.storeName);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    // ========================================================================
    // SESSION STORAGE FALLBACK
    // ========================================================================
    getAllFromSessionStorage() {
        try {
            const stored = sessionStorage.getItem(this.options.fallbackStorageKey);
            return stored ? JSON.parse(stored) : [];
        }
        catch {
            return [];
        }
    }
    addToSessionStorage(message) {
        const existing = this.getAllFromSessionStorage();
        existing.push(message);
        sessionStorage.setItem(this.options.fallbackStorageKey, JSON.stringify(existing));
    }
    deleteFromSessionStorage(id) {
        const existing = this.getAllFromSessionStorage();
        const filtered = existing.filter(msg => msg.id !== id);
        sessionStorage.setItem(this.options.fallbackStorageKey, JSON.stringify(filtered));
    }
    updateInSessionStorage(id, updates) {
        const existing = this.getAllFromSessionStorage();
        const message = existing.find(msg => msg.id === id);
        if (message) {
            Object.assign(message, updates);
            sessionStorage.setItem(this.options.fallbackStorageKey, JSON.stringify(existing));
        }
    }
    // ========================================================================
    // STATIC UTILITIES
    // ========================================================================
    /**
     * Check if IndexedDB is available
     */
    static isIndexedDBAvailable() {
        try {
            return typeof indexedDB !== 'undefined' &&
                typeof IDBTransaction !== 'undefined' &&
                typeof IDBKeyRange !== 'undefined';
        }
        catch {
            return false;
        }
    }
}
// ============================================================================
// SINGLETON FACTORY
// ============================================================================
const instances = new Map();
/**
 * Get or create a MessageQueue instance
 */
export function getMessageQueue(options) {
    const key = options?.dbName ?? 'default';
    if (!instances.has(key)) {
        instances.set(key, new MessageQueue(options));
    }
    return instances.get(key);
}
/**
 * Create a new MessageQueue instance (not cached)
 */
export function createMessageQueue(options) {
    return new MessageQueue(options);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVzc2FnZVF1ZXVlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWVzc2FnZVF1ZXVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFxQ0gsK0VBQStFO0FBQy9FLHNCQUFzQjtBQUN0QiwrRUFBK0U7QUFFL0UsTUFBTSxPQUFPLFlBQVk7SUFDYixFQUFFLEdBQXVCLElBQUksQ0FBQztJQUM5QixTQUFTLEdBQWdDLElBQUksQ0FBQztJQUM5QyxPQUFPLENBQWdDO0lBRS9DLFlBQVksVUFBK0IsRUFBRTtRQUN6QyxJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ1gsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLElBQUkscUJBQXFCO1lBQy9DLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUyxJQUFJLFVBQVU7WUFDMUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUFVLElBQUksQ0FBQztZQUNuQyxtQkFBbUIsRUFBRSxPQUFPLENBQUMsbUJBQW1CLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxFQUFFLFdBQVc7WUFDcEYsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLGtCQUFrQixJQUFJLHVCQUF1QjtTQUM1RSxDQUFDO0lBQ04sQ0FBQztJQUVELDJFQUEyRTtJQUMzRSwwQkFBMEI7SUFDMUIsMkVBQTJFO0lBRTNFOztPQUVHO0lBQ0ssS0FBSyxDQUFDLE1BQU07UUFDaEIsSUFBSSxJQUFJLENBQUMsRUFBRTtZQUFFLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUM1QixJQUFJLElBQUksQ0FBQyxTQUFTO1lBQUUsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBRTFDLGtDQUFrQztRQUNsQyxJQUFJLENBQUMsWUFBWSxDQUFDLG9CQUFvQixFQUFFLEVBQUUsQ0FBQztZQUN2QyxPQUFPLENBQUMsSUFBSSxDQUFDLHVFQUF1RSxDQUFDLENBQUM7WUFDdEYsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDN0MsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztZQUV2RCxPQUFPLENBQUMsT0FBTyxHQUFHLEdBQUcsRUFBRTtnQkFDbkIsT0FBTyxDQUFDLElBQUksQ0FBQyxzRUFBc0UsQ0FBQyxDQUFDO2dCQUNyRixNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDO1lBQ2pELENBQUMsQ0FBQztZQUVGLE9BQU8sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFO2dCQUNyQixJQUFJLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7Z0JBQ3pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDckIsQ0FBQyxDQUFDO1lBRUYsT0FBTyxDQUFDLGVBQWUsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFO2dCQUNoQyxNQUFNLEVBQUUsR0FBSSxLQUFLLENBQUMsTUFBMkIsQ0FBQyxNQUFNLENBQUM7Z0JBQ3JELElBQUksQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztvQkFDeEQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQzlFLEtBQUssQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO29CQUMvRCxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztvQkFDckQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7b0JBQzdELEtBQUssQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGFBQWEsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO2dCQUN2RSxDQUFDO1lBQ0wsQ0FBQyxDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUM7WUFDRCxJQUFJLENBQUMsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUMvQixPQUFPLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDbkIsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNMLGdEQUFnRDtZQUNoRCxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO0lBQ0wsQ0FBQztJQUVELDJFQUEyRTtJQUMzRSxtQkFBbUI7SUFDbkIsMkVBQTJFO0lBRTNFOztPQUVHO0lBQ0ssVUFBVTtRQUNkLE9BQU8sT0FBTyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7SUFDOUUsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFlBQVksQ0FDZCxJQUFZLEVBQ1osSUFBTyxFQUNQLFVBQStCLEVBQUU7UUFFakMsTUFBTSxPQUFPLEdBQXFCO1lBQzlCLEVBQUUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3JCLElBQUk7WUFDSixJQUFJO1lBQ0osU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDckIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRLElBQUksUUFBUTtZQUN0QyxVQUFVLEVBQUUsQ0FBQztZQUNiLFVBQVUsRUFBRSxPQUFPLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVTtZQUN6RCxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDO1lBQy9FLFdBQVcsRUFBRSxPQUFPLENBQUMsV0FBVztZQUNoQyxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7U0FDN0IsQ0FBQztRQUVGLElBQUksQ0FBQztZQUNELE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQy9CLElBQUksRUFBRSxFQUFFLENBQUM7Z0JBQ0wsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMzQyxDQUFDO2lCQUFNLENBQUM7Z0JBQ0osSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3RDLENBQUM7WUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxJQUFJLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbEUsT0FBTyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ3RCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRSxNQUFNLEtBQUssQ0FBQztRQUNoQixDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUFjLFdBQW9CO1FBQ3JELElBQUksQ0FBQztZQUNELE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQy9CLElBQUksUUFBNEIsQ0FBQztZQUVqQyxJQUFJLEVBQUUsRUFBRSxDQUFDO2dCQUNMLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBSSxFQUFFLENBQUMsQ0FBQztZQUNyRCxDQUFDO2lCQUFNLENBQUM7Z0JBQ0osUUFBUSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsRUFBSyxDQUFDO1lBQ2xELENBQUM7WUFFRCxxQ0FBcUM7WUFDckMsSUFBSSxXQUFXLEVBQUUsQ0FBQztnQkFDZCxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssV0FBVyxDQUFDLENBQUM7WUFDdkUsQ0FBQztZQUVELDhCQUE4QjtZQUM5QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDekUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLCtDQUErQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RFLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixFQUFLLENBQUM7UUFDOUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQUMsU0FBaUI7UUFDakMsSUFBSSxDQUFDO1lBQ0QsTUFBTSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDL0IsSUFBSSxFQUFFLEVBQUUsQ0FBQztnQkFDTCxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDbEQsQ0FBQztpQkFBTSxDQUFDO2dCQUNKLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM3QyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLDBDQUEwQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JFLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsa0JBQWtCLENBQUMsU0FBaUIsRUFBRSxVQUFrQjtRQUMxRCxJQUFJLENBQUM7WUFDRCxNQUFNLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMvQixJQUFJLEVBQUUsRUFBRSxDQUFDO2dCQUNMLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLENBQUM7aUJBQU0sQ0FBQztnQkFDSixJQUFJLENBQUMsc0JBQXNCLENBQUMsU0FBUyxFQUFFLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUMzRCxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDYixPQUFPLENBQUMsS0FBSyxDQUFDLGdEQUFnRCxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNFLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsb0JBQW9CO1FBQ3RCLElBQUksQ0FBQztZQUNELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDaEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sVUFBVSxHQUFHLFFBQVE7aUJBQ3RCLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksR0FBRyxDQUFDLFNBQVMsSUFBSSxHQUFHLENBQUM7aUJBQ3BELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUV4QixLQUFLLE1BQU0sRUFBRSxJQUFJLFVBQVUsRUFBRSxDQUFDO2dCQUMxQixNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDakMsQ0FBQztZQUVELElBQUksVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsVUFBVSxDQUFDLE1BQU0sbUJBQW1CLENBQUMsQ0FBQztZQUNoRixDQUFDO1lBRUQsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBQzdCLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxrREFBa0QsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN6RSxPQUFPLENBQUMsQ0FBQztRQUNiLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUTtRQUNWLElBQUksQ0FBQztZQUNELE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQy9CLElBQUksRUFBRSxFQUFFLENBQUM7Z0JBQ0wsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2xDLENBQUM7aUJBQU0sQ0FBQztnQkFDSixjQUFjLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUMvRCxDQUFDO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyw4Q0FBOEMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN6RSxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFFBQVE7UUFNVixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ2hELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUV2QixNQUFNLFVBQVUsR0FBb0MsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ25GLE1BQU0sYUFBYSxHQUEyQixFQUFFLENBQUM7UUFDakQsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBRWhCLEtBQUssTUFBTSxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7WUFDekIsVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQzNCLElBQUksR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNsQixhQUFhLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0UsQ0FBQztZQUNELElBQUksR0FBRyxDQUFDLFNBQVMsSUFBSSxHQUFHLENBQUMsU0FBUyxJQUFJLEdBQUcsRUFBRSxDQUFDO2dCQUN4QyxPQUFPLEVBQUUsQ0FBQztZQUNkLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTztZQUNILEtBQUssRUFBRSxRQUFRLENBQUMsTUFBTTtZQUN0QixVQUFVO1lBQ1YsYUFBYTtZQUNiLE9BQU87U0FDVixDQUFDO0lBQ04sQ0FBQztJQUVELDJFQUEyRTtJQUMzRSx1QkFBdUI7SUFDdkIsMkVBQTJFO0lBRW5FLEtBQUssQ0FBQyxjQUFjLENBQUksRUFBZSxFQUFFLE9BQXlCO1FBQ3RFLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDMUUsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlELE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDbkMsT0FBTyxDQUFDLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwQyxPQUFPLENBQUMsT0FBTyxHQUFHLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEQsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sS0FBSyxDQUFDLG1CQUFtQixDQUFJLEVBQWU7UUFDaEQsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNuQyxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUN6RSxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDOUQsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQy9CLE9BQU8sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUE0QixDQUFDLENBQUM7WUFDeEUsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxFQUFlLEVBQUUsRUFBVTtRQUN6RCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ25DLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM5RCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2pDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDcEMsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLEtBQUssQ0FBQyxpQkFBaUIsQ0FDM0IsRUFBZSxFQUNmLEVBQVUsRUFDVixPQUErQjtRQUUvQixNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUMxRSxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFOUQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLE9BQU8sQ0FBNEIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDN0UsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUM5QixPQUFPLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEQsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNWLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hDLE1BQU0sSUFBSSxPQUFPLENBQU8sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQ3hDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ25DLE9BQU8sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ3BDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7SUFDTCxDQUFDO0lBRU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxFQUFlO1FBQ3hDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDMUUsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlELE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM5QixPQUFPLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3BDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCwyRUFBMkU7SUFDM0UsMkJBQTJCO0lBQzNCLDJFQUEyRTtJQUVuRSx3QkFBd0I7UUFDNUIsSUFBSSxDQUFDO1lBQ0QsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDdkUsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUM1QyxDQUFDO1FBQUMsTUFBTSxDQUFDO1lBQ0wsT0FBTyxFQUFFLENBQUM7UUFDZCxDQUFDO0lBQ0wsQ0FBQztJQUVPLG1CQUFtQixDQUFJLE9BQXlCO1FBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1FBQ2pELFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkIsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUN0RixDQUFDO0lBRU8sd0JBQXdCLENBQUMsRUFBVTtRQUN2QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUNqRCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUN2RCxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3RGLENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxFQUFVLEVBQUUsT0FBK0I7UUFDdEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7UUFDakQsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDcEQsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNWLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hDLGNBQWMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDdEYsQ0FBQztJQUNMLENBQUM7SUFFRCwyRUFBMkU7SUFDM0UsbUJBQW1CO0lBQ25CLDJFQUEyRTtJQUUzRTs7T0FFRztJQUNILE1BQU0sQ0FBQyxvQkFBb0I7UUFDdkIsSUFBSSxDQUFDO1lBQ0QsT0FBTyxPQUFPLFNBQVMsS0FBSyxXQUFXO2dCQUNoQyxPQUFPLGNBQWMsS0FBSyxXQUFXO2dCQUNyQyxPQUFPLFdBQVcsS0FBSyxXQUFXLENBQUM7UUFDOUMsQ0FBQztRQUFDLE1BQU0sQ0FBQztZQUNMLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7SUFDTCxDQUFDO0NBQ0o7QUFFRCwrRUFBK0U7QUFDL0Usb0JBQW9CO0FBQ3BCLCtFQUErRTtBQUUvRSxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQztBQUVsRDs7R0FFRztBQUNILE1BQU0sVUFBVSxlQUFlLENBQUMsT0FBNkI7SUFDekQsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLE1BQU0sSUFBSSxTQUFTLENBQUM7SUFDekMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUN0QixTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFDRCxPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFFLENBQUM7QUFDL0IsQ0FBQztBQUVEOztHQUVHO0FBQ0gsTUFBTSxVQUFVLGtCQUFrQixDQUFDLE9BQTZCO0lBQzVELE9BQU8sSUFBSSxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDckMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2VuZXJpYyBNZXNzYWdlIFF1ZXVlIFV0aWxpdHlcbiAqIFByb3ZpZGVzIHBlcnNpc3RlbnQgcXVldWluZyBmb3IgY3Jvc3MtY29udGV4dCBjb21tdW5pY2F0aW9ucyB1c2luZyBJbmRleGVkREJcbiAqIFBhcnQgb2YgZmVzdC91bmlmb3JtIC0gbm8gYXBwLXNwZWNpZmljIGRlcGVuZGVuY2llc1xuICovXG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBpbnRlcmZhY2UgUXVldWVkTWVzc2FnZTxUID0gdW5rbm93bj4ge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgdHlwZTogc3RyaW5nO1xuICAgIGRhdGE6IFQ7XG4gICAgdGltZXN0YW1wOiBudW1iZXI7XG4gICAgcHJpb3JpdHk6IE1lc3NhZ2VQcmlvcml0eTtcbiAgICByZXRyeUNvdW50OiBudW1iZXI7XG4gICAgbWF4UmV0cmllczogbnVtYmVyO1xuICAgIGV4cGlyZXNBdD86IG51bWJlcjtcbiAgICBkZXN0aW5hdGlvbj86IHN0cmluZztcbiAgICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufVxuXG5leHBvcnQgdHlwZSBNZXNzYWdlUHJpb3JpdHkgPSAnbG93JyB8ICdub3JtYWwnIHwgJ2hpZ2gnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2VRdWV1ZU9wdGlvbnMge1xuICAgIGRiTmFtZT86IHN0cmluZztcbiAgICBzdG9yZU5hbWU/OiBzdHJpbmc7XG4gICAgbWF4UmV0cmllcz86IG51bWJlcjtcbiAgICBkZWZhdWx0RXhwaXJhdGlvbk1zPzogbnVtYmVyO1xuICAgIGZhbGxiYWNrU3RvcmFnZUtleT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBRdWV1ZU1lc3NhZ2VPcHRpb25zIHtcbiAgICBwcmlvcml0eT86IE1lc3NhZ2VQcmlvcml0eTtcbiAgICBtYXhSZXRyaWVzPzogbnVtYmVyO1xuICAgIGV4cGlyZXNBdD86IG51bWJlcjtcbiAgICBkZXN0aW5hdGlvbj86IHN0cmluZztcbiAgICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBNRVNTQUdFIFFVRVVFIENMQVNTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjbGFzcyBNZXNzYWdlUXVldWUge1xuICAgIHByaXZhdGUgZGI6IElEQkRhdGFiYXNlIHwgbnVsbCA9IG51bGw7XG4gICAgcHJpdmF0ZSBkYlByb21pc2U6IFByb21pc2U8SURCRGF0YWJhc2U+IHwgbnVsbCA9IG51bGw7XG4gICAgcHJpdmF0ZSBvcHRpb25zOiBSZXF1aXJlZDxNZXNzYWdlUXVldWVPcHRpb25zPjtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE1lc3NhZ2VRdWV1ZU9wdGlvbnMgPSB7fSkge1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICAgICAgICBkYk5hbWU6IG9wdGlvbnMuZGJOYW1lID8/ICdVbmlmb3JtTWVzc2FnZVF1ZXVlJyxcbiAgICAgICAgICAgIHN0b3JlTmFtZTogb3B0aW9ucy5zdG9yZU5hbWUgPz8gJ21lc3NhZ2VzJyxcbiAgICAgICAgICAgIG1heFJldHJpZXM6IG9wdGlvbnMubWF4UmV0cmllcyA/PyAzLFxuICAgICAgICAgICAgZGVmYXVsdEV4cGlyYXRpb25Nczogb3B0aW9ucy5kZWZhdWx0RXhwaXJhdGlvbk1zID8/IDI0ICogNjAgKiA2MCAqIDEwMDAsIC8vIDI0IGhvdXJzXG4gICAgICAgICAgICBmYWxsYmFja1N0b3JhZ2VLZXk6IG9wdGlvbnMuZmFsbGJhY2tTdG9yYWdlS2V5ID8/ICd1bmlmb3JtX21lc3NhZ2VfcXVldWUnXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gREFUQUJBU0UgSU5JVElBTElaQVRJT05cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgSW5kZXhlZERCIGRhdGFiYXNlXG4gICAgICovXG4gICAgcHJpdmF0ZSBhc3luYyBpbml0REIoKTogUHJvbWlzZTxJREJEYXRhYmFzZSB8IG51bGw+IHtcbiAgICAgICAgaWYgKHRoaXMuZGIpIHJldHVybiB0aGlzLmRiO1xuICAgICAgICBpZiAodGhpcy5kYlByb21pc2UpIHJldHVybiB0aGlzLmRiUHJvbWlzZTtcblxuICAgICAgICAvLyBDaGVjayBpZiBJbmRleGVkREIgaXMgYXZhaWxhYmxlXG4gICAgICAgIGlmICghTWVzc2FnZVF1ZXVlLmlzSW5kZXhlZERCQXZhaWxhYmxlKCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignW01lc3NhZ2VRdWV1ZV0gSW5kZXhlZERCIG5vdCBhdmFpbGFibGUsIHVzaW5nIHNlc3Npb25TdG9yYWdlIGZhbGxiYWNrJyk7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGJQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IGluZGV4ZWREQi5vcGVuKHRoaXMub3B0aW9ucy5kYk5hbWUsIDEpO1xuXG4gICAgICAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdbTWVzc2FnZVF1ZXVlXSBJbmRleGVkREIgb3BlbiBmYWlsZWQsIGZhbGxpbmcgYmFjayB0byBzZXNzaW9uU3RvcmFnZScpO1xuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ0luZGV4ZWREQiBub3QgYXZhaWxhYmxlJykpO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYiA9IHJlcXVlc3QucmVzdWx0O1xuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5kYik7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRiID0gKGV2ZW50LnRhcmdldCBhcyBJREJPcGVuREJSZXF1ZXN0KS5yZXN1bHQ7XG4gICAgICAgICAgICAgICAgaWYgKCFkYi5vYmplY3RTdG9yZU5hbWVzLmNvbnRhaW5zKHRoaXMub3B0aW9ucy5zdG9yZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUodGhpcy5vcHRpb25zLnN0b3JlTmFtZSwgeyBrZXlQYXRoOiAnaWQnIH0pO1xuICAgICAgICAgICAgICAgICAgICBzdG9yZS5jcmVhdGVJbmRleCgndGltZXN0YW1wJywgJ3RpbWVzdGFtcCcsIHsgdW5pcXVlOiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoJ3R5cGUnLCAndHlwZScsIHsgdW5pcXVlOiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoJ3ByaW9yaXR5JywgJ3ByaW9yaXR5JywgeyB1bmlxdWU6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgICAgICBzdG9yZS5jcmVhdGVJbmRleCgnZGVzdGluYXRpb24nLCAnZGVzdGluYXRpb24nLCB7IHVuaXF1ZTogZmFsc2UgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuZGIgPSBhd2FpdCB0aGlzLmRiUHJvbWlzZTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRiO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIHNlc3Npb25TdG9yYWdlIGlmIEluZGV4ZWREQiBmYWlsc1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBRVUVVRSBPUEVSQVRJT05TXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgICAvKipcbiAgICAgKiBHZW5lcmF0ZSB1bmlxdWUgbWVzc2FnZSBJRFxuICAgICAqL1xuICAgIHByaXZhdGUgZ2VuZXJhdGVJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYG1zZ18ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDExKX1gO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFF1ZXVlIGEgbWVzc2FnZSBmb3IgbGF0ZXIgcHJvY2Vzc2luZ1xuICAgICAqL1xuICAgIGFzeW5jIHF1ZXVlTWVzc2FnZTxUPihcbiAgICAgICAgdHlwZTogc3RyaW5nLFxuICAgICAgICBkYXRhOiBULFxuICAgICAgICBvcHRpb25zOiBRdWV1ZU1lc3NhZ2VPcHRpb25zID0ge31cbiAgICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlOiBRdWV1ZWRNZXNzYWdlPFQ+ID0ge1xuICAgICAgICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVJZCgpLFxuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICBwcmlvcml0eTogb3B0aW9ucy5wcmlvcml0eSA/PyAnbm9ybWFsJyxcbiAgICAgICAgICAgIHJldHJ5Q291bnQ6IDAsXG4gICAgICAgICAgICBtYXhSZXRyaWVzOiBvcHRpb25zLm1heFJldHJpZXMgPz8gdGhpcy5vcHRpb25zLm1heFJldHJpZXMsXG4gICAgICAgICAgICBleHBpcmVzQXQ6IG9wdGlvbnMuZXhwaXJlc0F0ID8/IChEYXRlLm5vdygpICsgdGhpcy5vcHRpb25zLmRlZmF1bHRFeHBpcmF0aW9uTXMpLFxuICAgICAgICAgICAgZGVzdGluYXRpb246IG9wdGlvbnMuZGVzdGluYXRpb24sXG4gICAgICAgICAgICBtZXRhZGF0YTogb3B0aW9ucy5tZXRhZGF0YVxuICAgICAgICB9O1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IGF3YWl0IHRoaXMuaW5pdERCKCk7XG4gICAgICAgICAgICBpZiAoZGIpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFkZFRvSW5kZXhlZERCKGRiLCBtZXNzYWdlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRUb1Nlc3Npb25TdG9yYWdlKG1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgW01lc3NhZ2VRdWV1ZV0gUXVldWVkIG1lc3NhZ2U6ICR7dHlwZX1gLCBtZXNzYWdlLmlkKTtcbiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlLmlkO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW01lc3NhZ2VRdWV1ZV0gRmFpbGVkIHRvIHF1ZXVlIG1lc3NhZ2U6JywgZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYWxsIHF1ZXVlZCBtZXNzYWdlc1xuICAgICAqL1xuICAgIGFzeW5jIGdldFF1ZXVlZE1lc3NhZ2VzPFQgPSB1bmtub3duPihkZXN0aW5hdGlvbj86IHN0cmluZyk6IFByb21pc2U8UXVldWVkTWVzc2FnZTxUPltdPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IGF3YWl0IHRoaXMuaW5pdERCKCk7XG4gICAgICAgICAgICBsZXQgbWVzc2FnZXM6IFF1ZXVlZE1lc3NhZ2U8VD5bXTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGRiKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMgPSBhd2FpdCB0aGlzLmdldEFsbEZyb21JbmRleGVkREI8VD4oZGIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlcyA9IHRoaXMuZ2V0QWxsRnJvbVNlc3Npb25TdG9yYWdlPFQ+KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEZpbHRlciBieSBkZXN0aW5hdGlvbiBpZiBzcGVjaWZpZWRcbiAgICAgICAgICAgIGlmIChkZXN0aW5hdGlvbikge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2VzID0gbWVzc2FnZXMuZmlsdGVyKG1zZyA9PiBtc2cuZGVzdGluYXRpb24gPT09IGRlc3RpbmF0aW9uKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gRmlsdGVyIG91dCBleHBpcmVkIG1lc3NhZ2VzXG4gICAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzLmZpbHRlcihtc2cgPT4gIW1zZy5leHBpcmVzQXQgfHwgbXNnLmV4cGlyZXNBdCA+IG5vdyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbTWVzc2FnZVF1ZXVlXSBGYWlsZWQgdG8gZ2V0IHF1ZXVlZCBtZXNzYWdlczonLCBlcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRBbGxGcm9tU2Vzc2lvblN0b3JhZ2U8VD4oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhIG1lc3NhZ2UgZnJvbSB0aGUgcXVldWVcbiAgICAgKi9cbiAgICBhc3luYyByZW1vdmVNZXNzYWdlKG1lc3NhZ2VJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IGF3YWl0IHRoaXMuaW5pdERCKCk7XG4gICAgICAgICAgICBpZiAoZGIpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmRlbGV0ZUZyb21JbmRleGVkREIoZGIsIG1lc3NhZ2VJZCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVsZXRlRnJvbVNlc3Npb25TdG9yYWdlKG1lc3NhZ2VJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdbTWVzc2FnZVF1ZXVlXSBGYWlsZWQgdG8gcmVtb3ZlIG1lc3NhZ2U6JywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIG1lc3NhZ2UgcmV0cnkgY291bnRcbiAgICAgKi9cbiAgICBhc3luYyB1cGRhdGVNZXNzYWdlUmV0cnkobWVzc2FnZUlkOiBzdHJpbmcsIHJldHJ5Q291bnQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZGIgPSBhd2FpdCB0aGlzLmluaXREQigpO1xuICAgICAgICAgICAgaWYgKGRiKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbkluZGV4ZWREQihkYiwgbWVzc2FnZUlkLCB7IHJldHJ5Q291bnQgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlSW5TZXNzaW9uU3RvcmFnZShtZXNzYWdlSWQsIHsgcmV0cnlDb3VudCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tNZXNzYWdlUXVldWVdIEZhaWxlZCB0byB1cGRhdGUgbWVzc2FnZSByZXRyeTonLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGVhciBhbGwgZXhwaXJlZCBtZXNzYWdlc1xuICAgICAqL1xuICAgIGFzeW5jIGNsZWFyRXhwaXJlZE1lc3NhZ2VzKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlcyA9IGF3YWl0IHRoaXMuZ2V0UXVldWVkTWVzc2FnZXMoKTtcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBjb25zdCBleHBpcmVkSWRzID0gbWVzc2FnZXNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKG1zZyA9PiBtc2cuZXhwaXJlc0F0ICYmIG1zZy5leHBpcmVzQXQgPD0gbm93KVxuICAgICAgICAgICAgICAgIC5tYXAobXNnID0+IG1zZy5pZCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgaWQgb2YgZXhwaXJlZElkcykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVtb3ZlTWVzc2FnZShpZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChleHBpcmVkSWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW01lc3NhZ2VRdWV1ZV0gQ2xlYXJlZCAke2V4cGlyZWRJZHMubGVuZ3RofSBleHBpcmVkIG1lc3NhZ2VzYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBleHBpcmVkSWRzLmxlbmd0aDtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1tNZXNzYWdlUXVldWVdIEZhaWxlZCB0byBjbGVhciBleHBpcmVkIG1lc3NhZ2VzOicsIGVycm9yKTtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xlYXIgYWxsIG1lc3NhZ2VzXG4gICAgICovXG4gICAgYXN5bmMgY2xlYXJBbGwoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBkYiA9IGF3YWl0IHRoaXMuaW5pdERCKCk7XG4gICAgICAgICAgICBpZiAoZGIpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNsZWFySW5kZXhlZERCKGRiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLm9wdGlvbnMuZmFsbGJhY2tTdG9yYWdlS2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbTWVzc2FnZVF1ZXVlXSBDbGVhcmVkIGFsbCBtZXNzYWdlcycpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignW01lc3NhZ2VRdWV1ZV0gRmFpbGVkIHRvIGNsZWFyIGFsbCBtZXNzYWdlczonLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgcXVldWUgc3RhdGlzdGljc1xuICAgICAqL1xuICAgIGFzeW5jIGdldFN0YXRzKCk6IFByb21pc2U8e1xuICAgICAgICB0b3RhbDogbnVtYmVyO1xuICAgICAgICBieVByaW9yaXR5OiBSZWNvcmQ8TWVzc2FnZVByaW9yaXR5LCBudW1iZXI+O1xuICAgICAgICBieURlc3RpbmF0aW9uOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+O1xuICAgICAgICBleHBpcmVkOiBudW1iZXI7XG4gICAgfT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IGF3YWl0IHRoaXMuZ2V0UXVldWVkTWVzc2FnZXMoKTtcbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGJ5UHJpb3JpdHk6IFJlY29yZDxNZXNzYWdlUHJpb3JpdHksIG51bWJlcj4gPSB7IGxvdzogMCwgbm9ybWFsOiAwLCBoaWdoOiAwIH07XG4gICAgICAgIGNvbnN0IGJ5RGVzdGluYXRpb246IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcbiAgICAgICAgbGV0IGV4cGlyZWQgPSAwO1xuXG4gICAgICAgIGZvciAoY29uc3QgbXNnIG9mIG1lc3NhZ2VzKSB7XG4gICAgICAgICAgICBieVByaW9yaXR5W21zZy5wcmlvcml0eV0rKztcbiAgICAgICAgICAgIGlmIChtc2cuZGVzdGluYXRpb24pIHtcbiAgICAgICAgICAgICAgICBieURlc3RpbmF0aW9uW21zZy5kZXN0aW5hdGlvbl0gPSAoYnlEZXN0aW5hdGlvblttc2cuZGVzdGluYXRpb25dIHx8IDApICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtc2cuZXhwaXJlc0F0ICYmIG1zZy5leHBpcmVzQXQgPD0gbm93KSB7XG4gICAgICAgICAgICAgICAgZXhwaXJlZCsrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvdGFsOiBtZXNzYWdlcy5sZW5ndGgsXG4gICAgICAgICAgICBieVByaW9yaXR5LFxuICAgICAgICAgICAgYnlEZXN0aW5hdGlvbixcbiAgICAgICAgICAgIGV4cGlyZWRcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBJTkRFWEVEREIgT1BFUkFUSU9OU1xuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgcHJpdmF0ZSBhc3luYyBhZGRUb0luZGV4ZWREQjxUPihkYjogSURCRGF0YWJhc2UsIG1lc3NhZ2U6IFF1ZXVlZE1lc3NhZ2U8VD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gZGIudHJhbnNhY3Rpb24oW3RoaXMub3B0aW9ucy5zdG9yZU5hbWVdLCAncmVhZHdyaXRlJyk7XG4gICAgICAgICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHRoaXMub3B0aW9ucy5zdG9yZU5hbWUpO1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLmFkZChtZXNzYWdlKTtcbiAgICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gcmVzb2x2ZSgpO1xuICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gKCkgPT4gcmVqZWN0KHJlcXVlc3QuZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGdldEFsbEZyb21JbmRleGVkREI8VD4oZGI6IElEQkRhdGFiYXNlKTogUHJvbWlzZTxRdWV1ZWRNZXNzYWdlPFQ+W10+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gZGIudHJhbnNhY3Rpb24oW3RoaXMub3B0aW9ucy5zdG9yZU5hbWVdLCAncmVhZG9ubHknKTtcbiAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGhpcy5vcHRpb25zLnN0b3JlTmFtZSk7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmUuZ2V0QWxsKCk7XG4gICAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHJlc29sdmUocmVxdWVzdC5yZXN1bHQgYXMgUXVldWVkTWVzc2FnZTxUPltdKTtcbiAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHJlamVjdChyZXF1ZXN0LmVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBkZWxldGVGcm9tSW5kZXhlZERCKGRiOiBJREJEYXRhYmFzZSwgaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihbdGhpcy5vcHRpb25zLnN0b3JlTmFtZV0sICdyZWFkd3JpdGUnKTtcbiAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGhpcy5vcHRpb25zLnN0b3JlTmFtZSk7XG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmUuZGVsZXRlKGlkKTtcbiAgICAgICAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gcmVzb2x2ZSgpO1xuICAgICAgICAgICAgcmVxdWVzdC5vbmVycm9yID0gKCkgPT4gcmVqZWN0KHJlcXVlc3QuZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHVwZGF0ZUluSW5kZXhlZERCKFxuICAgICAgICBkYjogSURCRGF0YWJhc2UsIFxuICAgICAgICBpZDogc3RyaW5nLCBcbiAgICAgICAgdXBkYXRlczogUGFydGlhbDxRdWV1ZWRNZXNzYWdlPlxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IGRiLnRyYW5zYWN0aW9uKFt0aGlzLm9wdGlvbnMuc3RvcmVOYW1lXSwgJ3JlYWR3cml0ZScpO1xuICAgICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHRoaXMub3B0aW9ucy5zdG9yZU5hbWUpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IG5ldyBQcm9taXNlPFF1ZXVlZE1lc3NhZ2UgfCB1bmRlZmluZWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5nZXQoaWQpO1xuICAgICAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTtcbiAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHJlamVjdChyZXF1ZXN0LmVycm9yKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24obWVzc2FnZSwgdXBkYXRlcyk7XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLnB1dChtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgY2xlYXJJbmRleGVkREIoZGI6IElEQkRhdGFiYXNlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IGRiLnRyYW5zYWN0aW9uKFt0aGlzLm9wdGlvbnMuc3RvcmVOYW1lXSwgJ3JlYWR3cml0ZScpO1xuICAgICAgICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0aGlzLm9wdGlvbnMuc3RvcmVOYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5jbGVhcigpO1xuICAgICAgICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiByZXNvbHZlKCk7XG4gICAgICAgICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIFNFU1NJT04gU1RPUkFHRSBGQUxMQkFDS1xuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgcHJpdmF0ZSBnZXRBbGxGcm9tU2Vzc2lvblN0b3JhZ2U8VD4oKTogUXVldWVkTWVzc2FnZTxUPltdIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHN0b3JlZCA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0odGhpcy5vcHRpb25zLmZhbGxiYWNrU3RvcmFnZUtleSk7XG4gICAgICAgICAgICByZXR1cm4gc3RvcmVkID8gSlNPTi5wYXJzZShzdG9yZWQpIDogW107XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRUb1Nlc3Npb25TdG9yYWdlPFQ+KG1lc3NhZ2U6IFF1ZXVlZE1lc3NhZ2U8VD4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmdldEFsbEZyb21TZXNzaW9uU3RvcmFnZSgpO1xuICAgICAgICBleGlzdGluZy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHRoaXMub3B0aW9ucy5mYWxsYmFja1N0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KGV4aXN0aW5nKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWxldGVGcm9tU2Vzc2lvblN0b3JhZ2UoaWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuZ2V0QWxsRnJvbVNlc3Npb25TdG9yYWdlKCk7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkID0gZXhpc3RpbmcuZmlsdGVyKG1zZyA9PiBtc2cuaWQgIT09IGlkKTtcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLm9wdGlvbnMuZmFsbGJhY2tTdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShmaWx0ZXJlZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlSW5TZXNzaW9uU3RvcmFnZShpZDogc3RyaW5nLCB1cGRhdGVzOiBQYXJ0aWFsPFF1ZXVlZE1lc3NhZ2U+KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5nZXRBbGxGcm9tU2Vzc2lvblN0b3JhZ2UoKTtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGV4aXN0aW5nLmZpbmQobXNnID0+IG1zZy5pZCA9PT0gaWQpO1xuICAgICAgICBpZiAobWVzc2FnZSkge1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihtZXNzYWdlLCB1cGRhdGVzKTtcbiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0odGhpcy5vcHRpb25zLmZhbGxiYWNrU3RvcmFnZUtleSwgSlNPTi5zdHJpbmdpZnkoZXhpc3RpbmcpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIFNUQVRJQyBVVElMSVRJRVNcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIEluZGV4ZWREQiBpcyBhdmFpbGFibGVcbiAgICAgKi9cbiAgICBzdGF0aWMgaXNJbmRleGVkREJBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIGluZGV4ZWREQiAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAgICAgICAgICAgICAgICB0eXBlb2YgSURCVHJhbnNhY3Rpb24gIT09ICd1bmRlZmluZWQnICYmXG4gICAgICAgICAgICAgICAgICAgdHlwZW9mIElEQktleVJhbmdlICE9PSAndW5kZWZpbmVkJztcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFNJTkdMRVRPTiBGQUNUT1JZXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmNvbnN0IGluc3RhbmNlcyA9IG5ldyBNYXA8c3RyaW5nLCBNZXNzYWdlUXVldWU+KCk7XG5cbi8qKlxuICogR2V0IG9yIGNyZWF0ZSBhIE1lc3NhZ2VRdWV1ZSBpbnN0YW5jZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWVzc2FnZVF1ZXVlKG9wdGlvbnM/OiBNZXNzYWdlUXVldWVPcHRpb25zKTogTWVzc2FnZVF1ZXVlIHtcbiAgICBjb25zdCBrZXkgPSBvcHRpb25zPy5kYk5hbWUgPz8gJ2RlZmF1bHQnO1xuICAgIGlmICghaW5zdGFuY2VzLmhhcyhrZXkpKSB7XG4gICAgICAgIGluc3RhbmNlcy5zZXQoa2V5LCBuZXcgTWVzc2FnZVF1ZXVlKG9wdGlvbnMpKTtcbiAgICB9XG4gICAgcmV0dXJuIGluc3RhbmNlcy5nZXQoa2V5KSE7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbmV3IE1lc3NhZ2VRdWV1ZSBpbnN0YW5jZSAobm90IGNhY2hlZClcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZU1lc3NhZ2VRdWV1ZShvcHRpb25zPzogTWVzc2FnZVF1ZXVlT3B0aW9ucyk6IE1lc3NhZ2VRdWV1ZSB7XG4gICAgcmV0dXJuIG5ldyBNZXNzYWdlUXVldWUob3B0aW9ucyk7XG59XG4iXX0=