/**
 * Service Channel Manager
 * Manages BroadcastChannel-based service channels for views and components
 * Part of fest/uniform - configurable without app-specific dependencies
 */
import { detectExecutionContext } from '../next/utils/Env';
// ============================================================================
// SERVICE CHANNEL MANAGER
// ============================================================================
export class ServiceChannelManager {
    channels = new Map();
    readyPromises = new Map();
    messageHandlers = new Map();
    channelConfigs;
    executionContext;
    logPrefix;
    constructor(config = {}) {
        this.channelConfigs = config.channels ?? {};
        this.logPrefix = config.logPrefix ?? '[ServiceChannels]';
        this.executionContext = detectExecutionContext();
        console.log(`${this.logPrefix} Initialized in ${this.executionContext} context`);
    }
    // ========================================================================
    // CONFIGURATION
    // ========================================================================
    /**
     * Register channel configurations
     */
    registerConfigs(configs) {
        this.channelConfigs = { ...this.channelConfigs, ...configs };
    }
    /**
     * Get channel configuration
     */
    getConfig(channelId) {
        return this.channelConfigs[channelId];
    }
    /**
     * Get all channel configurations
     */
    getAllConfigs() {
        return { ...this.channelConfigs };
    }
    // ========================================================================
    // CHANNEL LIFECYCLE
    // ========================================================================
    /**
     * Initialize a service channel
     */
    async initChannel(channelId) {
        // Return existing channel if already initialized
        if (this.channels.has(channelId)) {
            return this.channels.get(channelId);
        }
        const config = this.channelConfigs[channelId];
        if (!config) {
            throw new Error(`Unknown channel: ${channelId}. Register configuration first.`);
        }
        // Create deferred for ready state
        let resolveReady;
        const readyPromise = new Promise((resolve) => {
            resolveReady = resolve;
        });
        this.readyPromises.set(channelId, { promise: readyPromise, resolve: resolveReady });
        console.log(`${this.logPrefix} Initializing channel: ${channelId} -> ${config.broadcastName}`);
        // Create broadcast channel
        const channel = new BroadcastChannel(config.broadcastName);
        // Setup message handler
        channel.onmessage = (event) => {
            this.handleIncomingMessage(channelId, event.data);
        };
        channel.onmessageerror = (event) => {
            console.error(`${this.logPrefix} Message error on ${channelId}:`, event);
        };
        this.channels.set(channelId, channel);
        // Mark as ready
        resolveReady();
        console.log(`${this.logPrefix} Channel ready: ${channelId}`);
        return channel;
    }
    /**
     * Close a service channel
     */
    closeChannel(channelId) {
        const channel = this.channels.get(channelId);
        if (channel) {
            channel.close();
            this.channels.delete(channelId);
            this.readyPromises.delete(channelId);
            this.messageHandlers.delete(channelId);
            console.log(`${this.logPrefix} Channel closed: ${channelId}`);
        }
    }
    /**
     * Close all channels
     */
    closeAll() {
        for (const channelId of this.channels.keys()) {
            this.closeChannel(channelId);
        }
    }
    /**
     * Wait for a channel to be ready
     */
    async waitForChannel(channelId) {
        const deferred = this.readyPromises.get(channelId);
        if (deferred) {
            await deferred.promise;
        }
        else {
            await this.initChannel(channelId);
        }
    }
    // ========================================================================
    // MESSAGING
    // ========================================================================
    /**
     * Send a message to a channel
     */
    async send(target, type, data, options = {}) {
        await this.waitForChannel(target);
        const channel = this.channels.get(target);
        if (!channel) {
            throw new Error(`Channel not ready: ${target}`);
        }
        const message = {
            type,
            source: options.source ?? this.executionContext,
            target,
            data,
            timestamp: Date.now(),
            correlationId: options.correlationId
        };
        channel.postMessage(message);
        console.log(`${this.logPrefix} Sent message to ${target}:`, type);
    }
    /**
     * Broadcast a message to all initialized channels
     */
    broadcast(type, data, source) {
        for (const [channelId, channel] of this.channels) {
            const message = {
                type,
                source: source ?? this.executionContext,
                target: channelId,
                data,
                timestamp: Date.now()
            };
            channel.postMessage(message);
        }
        console.log(`${this.logPrefix} Broadcast message:`, type);
    }
    /**
     * Subscribe to messages on a channel
     */
    subscribe(channelId, handler) {
        if (!this.messageHandlers.has(channelId)) {
            this.messageHandlers.set(channelId, new Set());
        }
        this.messageHandlers.get(channelId).add(handler);
        // Initialize channel if not already
        this.initChannel(channelId).catch(console.error);
        // Return unsubscribe function
        return () => {
            this.messageHandlers.get(channelId)?.delete(handler);
        };
    }
    /**
     * Handle incoming message
     */
    handleIncomingMessage(channelId, data) {
        const handlers = this.messageHandlers.get(channelId);
        if (!handlers || handlers.size === 0) {
            console.log(`${this.logPrefix} No handlers for ${channelId}, message queued`);
            return;
        }
        const message = data;
        for (const handler of handlers) {
            try {
                handler(message);
            }
            catch (error) {
                console.error(`${this.logPrefix} Handler error on ${channelId}:`, error);
            }
        }
    }
    // ========================================================================
    // CHANNEL STATE
    // ========================================================================
    /**
     * Check if channel is initialized
     */
    isInitialized(channelId) {
        return this.channels.has(channelId);
    }
    /**
     * Get all initialized channel IDs
     */
    getInitializedChannels() {
        return Array.from(this.channels.keys());
    }
    /**
     * Get channel status
     */
    getStatus() {
        const status = {};
        for (const channelId of Object.keys(this.channelConfigs)) {
            status[channelId] = {
                connected: this.channels.has(channelId),
                lastActivity: Date.now(),
                pendingMessages: 0
            };
        }
        return status;
    }
    /**
     * Get execution context
     */
    getExecutionContext() {
        return this.executionContext;
    }
}
// ============================================================================
// FACTORY FUNCTIONS
// ============================================================================
/**
 * Create a new ServiceChannelManager instance
 */
export function createServiceChannelManager(config) {
    return new ServiceChannelManager(config);
}
// Default instance (optional singleton pattern)
let defaultManager = null;
/**
 * Get or create the default ServiceChannelManager
 */
export function getServiceChannelManager(config) {
    if (!defaultManager) {
        defaultManager = new ServiceChannelManager(config);
    }
    else if (config?.channels) {
        defaultManager.registerConfigs(config.channels);
    }
    return defaultManager;
}
/**
 * Reset the default manager (useful for testing)
 */
export function resetServiceChannelManager() {
    if (defaultManager) {
        defaultManager.closeAll();
        defaultManager = null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VydmljZUNoYW5uZWxNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU2VydmljZUNoYW5uZWxNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQStDM0QsK0VBQStFO0FBQy9FLDBCQUEwQjtBQUMxQiwrRUFBK0U7QUFFL0UsTUFBTSxPQUFPLHFCQUFxQjtJQUN0QixRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQWdDLENBQUM7SUFDbkQsYUFBYSxHQUFHLElBQUksR0FBRyxFQUErRCxDQUFDO0lBQ3ZGLGVBQWUsR0FBRyxJQUFJLEdBQUcsRUFBa0QsQ0FBQztJQUM1RSxjQUFjLENBQXVDO0lBQ3JELGdCQUFnQixDQUFTO0lBQ3pCLFNBQVMsQ0FBUztJQUUxQixZQUFZLFNBQXNDLEVBQUU7UUFDaEQsSUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLElBQUksbUJBQW1CLENBQUM7UUFDekQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLHNCQUFzQixFQUFFLENBQUM7UUFDakQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLG1CQUFtQixJQUFJLENBQUMsZ0JBQWdCLFVBQVUsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7SUFFRCwyRUFBMkU7SUFDM0UsZ0JBQWdCO0lBQ2hCLDJFQUEyRTtJQUUzRTs7T0FFRztJQUNILGVBQWUsQ0FBQyxPQUE2QztRQUN6RCxJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFDakUsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUyxDQUFDLFNBQXFCO1FBQzNCLE9BQU8sSUFBSSxDQUFDLGNBQWMs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YyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzFCLGNBQWMsR0FBRyxJQUFJLENBQUM7SUFDMUIsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNlcnZpY2UgQ2hhbm5lbCBNYW5hZ2VyXG4gKiBNYW5hZ2VzIEJyb2FkY2FzdENoYW5uZWwtYmFzZWQgc2VydmljZSBjaGFubmVscyBmb3Igdmlld3MgYW5kIGNvbXBvbmVudHNcbiAqIFBhcnQgb2YgZmVzdC91bmlmb3JtIC0gY29uZmlndXJhYmxlIHdpdGhvdXQgYXBwLXNwZWNpZmljIGRlcGVuZGVuY2llc1xuICovXG5cbmltcG9ydCB7IGRldGVjdEV4ZWN1dGlvbkNvbnRleHQgfSBmcm9tICcuLi9uZXh0L3V0aWxzL0Vudic7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogQ2hhbm5lbCBjb25maWd1cmF0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU2VydmljZUNoYW5uZWxDb25maWcge1xuICAgIGJyb2FkY2FzdE5hbWU6IHN0cmluZztcbiAgICByb3V0ZUhhc2g/OiBzdHJpbmc7XG4gICAgY29tcG9uZW50Pzogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIENoYW5uZWwgbWVzc2FnZSBmb3JtYXRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDaGFubmVsTWVzc2FnZTxUID0gdW5rbm93bj4ge1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBzb3VyY2U6IHN0cmluZztcbiAgICB0YXJnZXQ6IHN0cmluZztcbiAgICBkYXRhOiBUO1xuICAgIHRpbWVzdGFtcDogbnVtYmVyO1xuICAgIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogQ2hhbm5lbCBzdGF0ZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIENoYW5uZWxTdGF0ZSB7XG4gICAgY29ubmVjdGVkOiBib29sZWFuO1xuICAgIGxhc3RBY3Rpdml0eTogbnVtYmVyO1xuICAgIHBlbmRpbmdNZXNzYWdlczogbnVtYmVyO1xufVxuXG4vKipcbiAqIFNlcnZpY2UgY2hhbm5lbCBtYW5hZ2VyIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZXJ2aWNlQ2hhbm5lbE1hbmFnZXJDb25maWcge1xuICAgIC8qKiBDaGFubmVsIGNvbmZpZ3VyYXRpb25zIGJ5IElEICovXG4gICAgY2hhbm5lbHM/OiBSZWNvcmQ8c3RyaW5nLCBTZXJ2aWNlQ2hhbm5lbENvbmZpZz47XG4gICAgLyoqIExvZyBwcmVmaXggZm9yIGRlYnVnZ2luZyAqL1xuICAgIGxvZ1ByZWZpeD86IHN0cmluZztcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gU0VSVklDRSBDSEFOTkVMIE1BTkFHRVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGNsYXNzIFNlcnZpY2VDaGFubmVsTWFuYWdlcjxUQ2hhbm5lbElkIGV4dGVuZHMgc3RyaW5nID0gc3RyaW5nPiB7XG4gICAgcHJpdmF0ZSBjaGFubmVscyA9IG5ldyBNYXA8VENoYW5uZWxJZCwgQnJvYWRjYXN0Q2hhbm5lbD4oKTtcbiAgICBwcml2YXRlIHJlYWR5UHJvbWlzZXMgPSBuZXcgTWFwPFRDaGFubmVsSWQsIHsgcHJvbWlzZTogUHJvbWlzZTx2b2lkPjsgcmVzb2x2ZTogKCkgPT4gdm9pZCB9PigpO1xuICAgIHByaXZhdGUgbWVzc2FnZUhhbmRsZXJzID0gbmV3IE1hcDxUQ2hhbm5lbElkLCBTZXQ8KG1zZzogQ2hhbm5lbE1lc3NhZ2UpID0+IHZvaWQ+PigpO1xuICAgIHByaXZhdGUgY2hhbm5lbENvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIFNlcnZpY2VDaGFubmVsQ29uZmlnPjtcbiAgICBwcml2YXRlIGV4ZWN1dGlvbkNvbnRleHQ6IHN0cmluZztcbiAgICBwcml2YXRlIGxvZ1ByZWZpeDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBTZXJ2aWNlQ2hhbm5lbE1hbmFnZXJDb25maWcgPSB7fSkge1xuICAgICAgICB0aGlzLmNoYW5uZWxDb25maWdzID0gY29uZmlnLmNoYW5uZWxzID8/IHt9O1xuICAgICAgICB0aGlzLmxvZ1ByZWZpeCA9IGNvbmZpZy5sb2dQcmVmaXggPz8gJ1tTZXJ2aWNlQ2hhbm5lbHNdJztcbiAgICAgICAgdGhpcy5leGVjdXRpb25Db250ZXh0ID0gZGV0ZWN0RXhlY3V0aW9uQ29udGV4dCgpO1xuICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLmxvZ1ByZWZpeH0gSW5pdGlhbGl6ZWQgaW4gJHt0aGlzLmV4ZWN1dGlvbkNvbnRleHR9IGNvbnRleHRgKTtcbiAgICB9XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBDT05GSUdVUkFUSU9OXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciBjaGFubmVsIGNvbmZpZ3VyYXRpb25zXG4gICAgICovXG4gICAgcmVnaXN0ZXJDb25maWdzKGNvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIFNlcnZpY2VDaGFubmVsQ29uZmlnPik6IHZvaWQge1xuICAgICAgICB0aGlzLmNoYW5uZWxDb25maWdzID0geyAuLi50aGlzLmNoYW5uZWxDb25maWdzLCAuLi5jb25maWdzIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGNoYW5uZWwgY29uZmlndXJhdGlvblxuICAgICAqL1xuICAgIGdldENvbmZpZyhjaGFubmVsSWQ6IFRDaGFubmVsSWQpOiBTZXJ2aWNlQ2hhbm5lbENvbmZpZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmNoYW5uZWxDb25maWdzW2NoYW5uZWxJZF07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGFsbCBjaGFubmVsIGNvbmZpZ3VyYXRpb25zXG4gICAgICovXG4gICAgZ2V0QWxsQ29uZmlncygpOiBSZWNvcmQ8c3RyaW5nLCBTZXJ2aWNlQ2hhbm5lbENvbmZpZz4ge1xuICAgICAgICByZXR1cm4geyAuLi50aGlzLmNoYW5uZWxDb25maWdzIH07XG4gICAgfVxuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgLy8gQ0hBTk5FTCBMSUZFQ1lDTEVcbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgYSBzZXJ2aWNlIGNoYW5uZWxcbiAgICAgKi9cbiAgICBhc3luYyBpbml0Q2hhbm5lbChjaGFubmVsSWQ6IFRDaGFubmVsSWQpOiBQcm9taXNlPEJyb2FkY2FzdENoYW5uZWw+IHtcbiAgICAgICAgLy8gUmV0dXJuIGV4aXN0aW5nIGNoYW5uZWwgaWYgYWxyZWFkeSBpbml0aWFsaXplZFxuICAgICAgICBpZiAodGhpcy5jaGFubmVscy5oYXMoY2hhbm5lbElkKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2hhbm5lbHMuZ2V0KGNoYW5uZWxJZCkhO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29uZmlnID0gdGhpcy5jaGFubmVsQ29uZmlnc1tjaGFubmVsSWRdO1xuICAgICAgICBpZiAoIWNvbmZpZykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGNoYW5uZWw6ICR7Y2hhbm5lbElkfS4gUmVnaXN0ZXIgY29uZmlndXJhdGlvbiBmaXJzdC5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBkZWZlcnJlZCBmb3IgcmVhZHkgc3RhdGVcbiAgICAgICAgbGV0IHJlc29sdmVSZWFkeSE6ICgpID0+IHZvaWQ7XG4gICAgICAgIGNvbnN0IHJlYWR5UHJvbWlzZSA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICByZXNvbHZlUmVhZHkgPSByZXNvbHZlO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZWFkeVByb21pc2VzLnNldChjaGFubmVsSWQsIHsgcHJvbWlzZTogcmVhZHlQcm9taXNlLCByZXNvbHZlOiByZXNvbHZlUmVhZHkgfSk7XG5cbiAgICAgICAgY29uc29sZS5sb2coYCR7dGhpcy5sb2dQcmVmaXh9IEluaXRpYWxpemluZyBjaGFubmVsOiAke2NoYW5uZWxJZH0gLT4gJHtjb25maWcuYnJvYWRjYXN0TmFtZX1gKTtcblxuICAgICAgICAvLyBDcmVhdGUgYnJvYWRjYXN0IGNoYW5uZWxcbiAgICAgICAgY29uc3QgY2hhbm5lbCA9IG5ldyBCcm9hZGNhc3RDaGFubmVsKGNvbmZpZy5icm9hZGNhc3ROYW1lKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFNldHVwIG1lc3NhZ2UgaGFuZGxlclxuICAgICAgICBjaGFubmVsLm9ubWVzc2FnZSA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVJbmNvbWluZ01lc3NhZ2UoY2hhbm5lbElkLCBldmVudC5kYXRhKTtcbiAgICAgICAgfTtcblxuICAgICAgICBjaGFubmVsLm9ubWVzc2FnZWVycm9yID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGAke3RoaXMubG9nUHJlZml4fSBNZXNzYWdlIGVycm9yIG9uICR7Y2hhbm5lbElkfTpgLCBldmVudCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5jaGFubmVscy5zZXQoY2hhbm5lbElkLCBjaGFubmVsKTtcbiAgICAgICAgXG4gICAgICAgIC8vIE1hcmsgYXMgcmVhZHlcbiAgICAgICAgcmVzb2x2ZVJlYWR5KCk7XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLmxvZ1ByZWZpeH0gQ2hhbm5lbCByZWFkeTogJHtjaGFubmVsSWR9YCk7XG4gICAgICAgIHJldHVybiBjaGFubmVsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENsb3NlIGEgc2VydmljZSBjaGFubmVsXG4gICAgICovXG4gICAgY2xvc2VDaGFubmVsKGNoYW5uZWxJZDogVENoYW5uZWxJZCk6IHZvaWQge1xuICAgICAgICBjb25zdCBjaGFubmVsID0gdGhpcy5jaGFubmVscy5nZXQoY2hhbm5lbElkKTtcbiAgICAgICAgaWYgKGNoYW5uZWwpIHtcbiAgICAgICAgICAgIGNoYW5uZWwuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMuY2hhbm5lbHMuZGVsZXRlKGNoYW5uZWxJZCk7XG4gICAgICAgICAgICB0aGlzLnJlYWR5UHJvbWlzZXMuZGVsZXRlKGNoYW5uZWxJZCk7XG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVycy5kZWxldGUoY2hhbm5lbElkKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMubG9nUHJlZml4fSBDaGFubmVsIGNsb3NlZDogJHtjaGFubmVsSWR9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbG9zZSBhbGwgY2hhbm5lbHNcbiAgICAgKi9cbiAgICBjbG9zZUFsbCgpOiB2b2lkIHtcbiAgICAgICAgZm9yIChjb25zdCBjaGFubmVsSWQgb2YgdGhpcy5jaGFubmVscy5rZXlzKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VDaGFubmVsKGNoYW5uZWxJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXYWl0IGZvciBhIGNoYW5uZWwgdG8gYmUgcmVhZHlcbiAgICAgKi9cbiAgICBhc3luYyB3YWl0Rm9yQ2hhbm5lbChjaGFubmVsSWQ6IFRDaGFubmVsSWQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgZGVmZXJyZWQgPSB0aGlzLnJlYWR5UHJvbWlzZXMuZ2V0KGNoYW5uZWxJZCk7XG4gICAgICAgIGlmIChkZWZlcnJlZCkge1xuICAgICAgICAgICAgYXdhaXQgZGVmZXJyZWQucHJvbWlzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuaW5pdENoYW5uZWwoY2hhbm5lbElkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIC8vIE1FU1NBR0lOR1xuICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4gICAgLyoqXG4gICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gYSBjaGFubmVsXG4gICAgICovXG4gICAgYXN5bmMgc2VuZDxUPihcbiAgICAgICAgdGFyZ2V0OiBUQ2hhbm5lbElkLFxuICAgICAgICB0eXBlOiBzdHJpbmcsXG4gICAgICAgIGRhdGE6IFQsXG4gICAgICAgIG9wdGlvbnM6IHsgY29ycmVsYXRpb25JZD86IHN0cmluZzsgc291cmNlPzogc3RyaW5nIH0gPSB7fVxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBhd2FpdCB0aGlzLndhaXRGb3JDaGFubmVsKHRhcmdldCk7XG5cbiAgICAgICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHMuZ2V0KHRhcmdldCk7XG4gICAgICAgIGlmICghY2hhbm5lbCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDaGFubmVsIG5vdCByZWFkeTogJHt0YXJnZXR9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtZXNzYWdlOiBDaGFubmVsTWVzc2FnZTxUPiA9IHtcbiAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICBzb3VyY2U6IG9wdGlvbnMuc291cmNlID8/IHRoaXMuZXhlY3V0aW9uQ29udGV4dCxcbiAgICAgICAgICAgIHRhcmdldCxcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICBjb3JyZWxhdGlvbklkOiBvcHRpb25zLmNvcnJlbGF0aW9uSWRcbiAgICAgICAgfTtcblxuICAgICAgICBjaGFubmVsLnBvc3RNZXNzYWdlKG1lc3NhZ2UpO1xuICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLmxvZ1ByZWZpeH0gU2VudCBtZXNzYWdlIHRvICR7dGFyZ2V0fTpgLCB0eXBlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCcm9hZGNhc3QgYSBtZXNzYWdlIHRvIGFsbCBpbml0aWFsaXplZCBjaGFubmVsc1xuICAgICAqL1xuICAgIGJyb2FkY2FzdDxUPih0eXBlOiBzdHJpbmcsIGRhdGE6IFQsIHNvdXJjZT86IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBmb3IgKGNvbnN0IFtjaGFubmVsSWQsIGNoYW5uZWxdIG9mIHRoaXMuY2hhbm5lbHMpIHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2U6IENoYW5uZWxNZXNzYWdlPFQ+ID0ge1xuICAgICAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICAgICAgc291cmNlOiBzb3VyY2UgPz8gdGhpcy5leGVjdXRpb25Db250ZXh0LFxuICAgICAgICAgICAgICAgIHRhcmdldDogY2hhbm5lbElkLFxuICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY2hhbm5lbC5wb3N0TWVzc2FnZShtZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhgJHt0aGlzLmxvZ1ByZWZpeH0gQnJvYWRjYXN0IG1lc3NhZ2U6YCwgdHlwZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlIHRvIG1lc3NhZ2VzIG9uIGEgY2hhbm5lbFxuICAgICAqL1xuICAgIHN1YnNjcmliZShcbiAgICAgICAgY2hhbm5lbElkOiBUQ2hhbm5lbElkLFxuICAgICAgICBoYW5kbGVyOiAobXNnOiBDaGFubmVsTWVzc2FnZSkgPT4gdm9pZFxuICAgICk6ICgpID0+IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMubWVzc2FnZUhhbmRsZXJzLmhhcyhjaGFubmVsSWQpKSB7XG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVycy5zZXQoY2hhbm5lbElkLCBuZXcgU2V0KCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnMuZ2V0KGNoYW5uZWxJZCkhLmFkZChoYW5kbGVyKTtcblxuICAgICAgICAvLyBJbml0aWFsaXplIGNoYW5uZWwgaWYgbm90IGFscmVhZHlcbiAgICAgICAgdGhpcy5pbml0Q2hhbm5lbChjaGFubmVsSWQpLmNhdGNoKGNvbnNvbGUuZXJyb3IpO1xuXG4gICAgICAgIC8vIFJldHVybiB1bnN1YnNjcmliZSBmdW5jdGlvblxuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlcnMuZ2V0KGNoYW5uZWxJZCk/LmRlbGV0ZShoYW5kbGVyKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGUgaW5jb21pbmcgbWVzc2FnZVxuICAgICAqL1xuICAgIHByaXZhdGUgaGFuZGxlSW5jb21pbmdNZXNzYWdlKGNoYW5uZWxJZDogVENoYW5uZWxJZCwgZGF0YTogdW5rbm93bik6IHZvaWQge1xuICAgICAgICBjb25zdCBoYW5kbGVycyA9IHRoaXMubWVzc2FnZUhhbmRsZXJzLmdldChjaGFubmVsSWQpO1xuICAgICAgICBpZiAoIWhhbmRsZXJzIHx8IGhhbmRsZXJzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RoaXMubG9nUHJlZml4fSBObyBoYW5kbGVycyBmb3IgJHtjaGFubmVsSWR9LCBtZXNzYWdlIHF1ZXVlZGApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGRhdGEgYXMgQ2hhbm5lbE1lc3NhZ2U7XG4gICAgICAgIGZvciAoY29uc3QgaGFuZGxlciBvZiBoYW5kbGVycykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBoYW5kbGVyKG1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGAke3RoaXMubG9nUHJlZml4fSBIYW5kbGVyIGVycm9yIG9uICR7Y2hhbm5lbElkfTpgLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAvLyBDSEFOTkVMIFNUQVRFXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBjaGFubmVsIGlzIGluaXRpYWxpemVkXG4gICAgICovXG4gICAgaXNJbml0aWFsaXplZChjaGFubmVsSWQ6IFRDaGFubmVsSWQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hhbm5lbHMuaGFzKGNoYW5uZWxJZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGFsbCBpbml0aWFsaXplZCBjaGFubmVsIElEc1xuICAgICAqL1xuICAgIGdldEluaXRpYWxpemVkQ2hhbm5lbHMoKTogVENoYW5uZWxJZFtdIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5jaGFubmVscy5rZXlzKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBjaGFubmVsIHN0YXR1c1xuICAgICAqL1xuICAgIGdldFN0YXR1cygpOiBSZWNvcmQ8c3RyaW5nLCBDaGFubmVsU3RhdGU+IHtcbiAgICAgICAgY29uc3Qgc3RhdHVzOiBSZWNvcmQ8c3RyaW5nLCBDaGFubmVsU3RhdGU+ID0ge307XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IGNoYW5uZWxJZCBvZiBPYmplY3Qua2V5cyh0aGlzLmNoYW5uZWxDb25maWdzKSkge1xuICAgICAgICAgICAgc3RhdHVzW2NoYW5uZWxJZF0gPSB7XG4gICAgICAgICAgICAgICAgY29ubmVjdGVkOiB0aGlzLmNoYW5uZWxzLmhhcyhjaGFubmVsSWQgYXMgVENoYW5uZWxJZCksXG4gICAgICAgICAgICAgICAgbGFzdEFjdGl2aXR5OiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgIHBlbmRpbmdNZXNzYWdlczogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzdGF0dXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGV4ZWN1dGlvbiBjb250ZXh0XG4gICAgICovXG4gICAgZ2V0RXhlY3V0aW9uQ29udGV4dCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRpb25Db250ZXh0O1xuICAgIH1cbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gRkFDVE9SWSBGVU5DVElPTlNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBDcmVhdGUgYSBuZXcgU2VydmljZUNoYW5uZWxNYW5hZ2VyIGluc3RhbmNlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTZXJ2aWNlQ2hhbm5lbE1hbmFnZXI8VENoYW5uZWxJZCBleHRlbmRzIHN0cmluZyA9IHN0cmluZz4oXG4gICAgY29uZmlnPzogU2VydmljZUNoYW5uZWxNYW5hZ2VyQ29uZmlnXG4pOiBTZXJ2aWNlQ2hhbm5lbE1hbmFnZXI8VENoYW5uZWxJZD4ge1xuICAgIHJldHVybiBuZXcgU2VydmljZUNoYW5uZWxNYW5hZ2VyPFRDaGFubmVsSWQ+KGNvbmZpZyk7XG59XG5cbi8vIERlZmF1bHQgaW5zdGFuY2UgKG9wdGlvbmFsIHNpbmdsZXRvbiBwYXR0ZXJuKVxubGV0IGRlZmF1bHRNYW5hZ2VyOiBTZXJ2aWNlQ2hhbm5lbE1hbmFnZXIgfCBudWxsID0gbnVsbDtcblxuLyoqXG4gKiBHZXQgb3IgY3JlYXRlIHRoZSBkZWZhdWx0IFNlcnZpY2VDaGFubmVsTWFuYWdlclxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VydmljZUNoYW5uZWxNYW5hZ2VyKGNvbmZpZz86IFNlcnZpY2VDaGFubmVsTWFuYWdlckNvbmZpZyk6IFNlcnZpY2VDaGFubmVsTWFuYWdlciB7XG4gICAgaWYgKCFkZWZhdWx0TWFuYWdlcikge1xuICAgICAgICBkZWZhdWx0TWFuYWdlciA9IG5ldyBTZXJ2aWNlQ2hhbm5lbE1hbmFnZXIoY29uZmlnKTtcbiAgICB9IGVsc2UgaWYgKGNvbmZpZz8uY2hhbm5lbHMpIHtcbiAgICAgICAgZGVmYXVsdE1hbmFnZXIucmVnaXN0ZXJDb25maWdzKGNvbmZpZy5jaGFubmVscyk7XG4gICAgfVxuICAgIHJldHVybiBkZWZhdWx0TWFuYWdlcjtcbn1cblxuLyoqXG4gKiBSZXNldCB0aGUgZGVmYXVsdCBtYW5hZ2VyICh1c2VmdWwgZm9yIHRlc3RpbmcpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZXNldFNlcnZpY2VDaGFubmVsTWFuYWdlcigpOiB2b2lkIHtcbiAgICBpZiAoZGVmYXVsdE1hbmFnZXIpIHtcbiAgICAgICAgZGVmYXVsdE1hbmFnZXIuY2xvc2VBbGwoKTtcbiAgICAgICAgZGVmYXVsdE1hbmFnZXIgPSBudWxsO1xuICAgIH1cbn1cbiJdfQ==