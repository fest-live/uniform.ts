/**
 * Channel Message Handler - Unified message routing
 *
 * Delegates to core/TransportCore and core/RequestHandler.
 * Simplified wrapper providing Observable-style message handling.
 */
import { UUIDv4 } from "fest/core";
import { createTransportSender, createTransportListener } from "../../core/TransportCore";
import { handleRequest } from "../../core/RequestHandler";
// ============================================================================
// MESSAGE HANDLER FACTORY
// ============================================================================
export function makeChannelMessageHandler(transport, channelName, handler) {
    const pending = new Map();
    const send = createTransportSender(transport);
    return (subscriber) => {
        const respond = (data) => {
            if (data.type === "response" && data.reqId) {
                return (result) => {
                    const p = pending.get(data.reqId);
                    if (p) {
                        p.resolve(result);
                        pending.delete(data.reqId);
                    }
                };
            }
            if (data.type === "request") {
                return (result, transfer) => send({ ...result, channel: data.sender, sender: channelName, type: "response", reqId: data.reqId }, transfer);
            }
            return send;
        };
        const onMessage = (data) => {
            if (!subscriber.active)
                return;
            if (data.type === "response" && data.reqId) {
                const p = pending.get(data.reqId);
                if (p) {
                    p.resolve(data.payload);
                    pending.delete(data.reqId);
                }
            }
            handler ? handler(data, respond(data)) : subscriber.next(data);
        };
        const cleanup = createTransportListener(transport, onMessage, (e) => subscriber.error(e), () => subscriber.complete());
        // Add request capability
        subscriber.request = (msg) => {
            const reqId = msg.reqId ?? UUIDv4();
            msg.reqId = reqId;
            return new Promise((resolve, reject) => {
                pending.set(reqId, { resolve, reject, timestamp: Date.now() });
                send(msg);
            });
        };
        return cleanup;
    };
}
// ============================================================================
// MESSAGE OBSERVABLE
// ============================================================================
export class ChannelMessageObservable {
    _transport;
    _channelName;
    _pending = new Map();
    _subs = new Set();
    _cleanup = null;
    _send;
    _active = false;
    constructor(_transport, _channelName) {
        this._transport = _transport;
        this._channelName = _channelName;
        this._send = createTransportSender(_transport);
    }
    subscribe(observer) {
        this._subs.add(observer);
        if (!this._active)
            this._activate();
        return {
            unsubscribe: () => {
                this._subs.delete(observer);
                if (this._subs.size === 0)
                    this._deactivate();
            }
        };
    }
    next(msg, transfer) { this._send(msg, transfer); }
    request(msg) {
        const reqId = msg.reqId ?? UUIDv4();
        return new Promise((resolve, reject) => {
            this._pending.set(reqId, { resolve, reject, timestamp: Date.now() });
            this.next({ ...msg, reqId });
        });
    }
    _activate() {
        if (this._active)
            return;
        this._cleanup = createTransportListener(this._transport, (data) => {
            if (data.type === "response" && data.reqId) {
                const p = this._pending.get(data.reqId);
                if (p) {
                    p.resolve(data.payload);
                    this._pending.delete(data.reqId);
                }
            }
            for (const s of this._subs) {
                try {
                    s.next?.(data);
                }
                catch (e) {
                    s.error?.(e);
                }
            }
        }, (e) => this._subs.forEach((s) => s.error?.(e)), () => this._subs.forEach((s) => s.complete?.()));
        this._active = true;
    }
    _deactivate() {
        this._cleanup?.();
        this._cleanup = null;
        this._active = false;
    }
}
// ============================================================================
// REQUEST HANDLER FACTORY
// ============================================================================
export function createChannelRequestHandler(channelName, options = {}) {
    return async (data, respond) => {
        if (data.type !== "request" || data.channel !== channelName)
            return;
        options.onRequest?.(data.payload);
        const result = await handleRequest(data.payload, data.reqId, channelName);
        if (result) {
            options.onResponse?.(result.response);
            respond({ ...result.response, id: UUIDv4(), timestamp: Date.now() }, result.transfer);
        }
    };
}
// ============================================================================
// DISPATCHER (Simplified)
// ============================================================================
export class ObservableRequestDispatcher {
    _channelName;
    _targetChannel;
    _pending = new Map();
    _subscriber = null;
    constructor(_channelName, _targetChannel) {
        this._channelName = _channelName;
        this._targetChannel = _targetChannel;
    }
    connect(subscriber) { this._subscriber = subscriber; }
    disconnect() {
        for (const p of this._pending.values())
            p.reject(new Error("Disconnected"));
        this._pending.clear();
        this._subscriber = null;
    }
    handleMessage(data) {
        if (data.type === "response" && data.reqId) {
            const p = this._pending.get(data.reqId);
            if (p) {
                p.resolve(data.payload);
                this._pending.delete(data.reqId);
            }
        }
    }
    dispatch(action, path, args) {
        if (!this._subscriber?.active)
            return Promise.reject(new Error("Not connected"));
        const reqId = UUIDv4();
        const msg = {
            id: UUIDv4(), channel: this._targetChannel, sender: this._channelName,
            type: "request", reqId, payload: { channel: this._targetChannel, sender: this._channelName, path, action, args },
            timestamp: Date.now()
        };
        const promise = new Promise((resolve, reject) => this._pending.set(reqId, { resolve, reject, timestamp: Date.now() }));
        this._subscriber.next(msg);
        return promise;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhbm5lbE1lc3NhZ2VIYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ2hhbm5lbE1lc3NhZ2VIYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuQyxPQUFPLEVBQ0gscUJBQXFCLEVBQ3JCLHVCQUF1QixFQUcxQixNQUFNLDBCQUEwQixDQUFDO0FBQ2xDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQXdCMUQsK0VBQStFO0FBQy9FLDBCQUEwQjtBQUMxQiwrRUFBK0U7QUFFL0UsTUFBTSxVQUFVLHlCQUF5QixDQUNyQyxTQUEwQixFQUMxQixXQUFtQixFQUNuQixPQUFnRDtJQUVoRCxNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztJQUNsRCxNQUFNLElBQUksR0FBRyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUU5QyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUU7UUFDbEIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFvQixFQUE2QixFQUFFO1lBQ2hFLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxVQUFVLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUN6QyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUU7b0JBQ2QsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBTSxDQUFDLENBQUM7b0JBQ25DLElBQUksQ0FBQyxFQUFFLENBQUM7d0JBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQzt3QkFBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFNLENBQUMsQ0FBQztvQkFBQyxDQUFDO2dCQUM5RCxDQUFDLENBQUM7WUFDTixDQUFDO1lBQ0QsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMs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QUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7WUFDaEgsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7U0FDeEIsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZILElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNCLE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ2hhbm5lbCBNZXNzYWdlIEhhbmRsZXIgLSBVbmlmaWVkIG1lc3NhZ2Ugcm91dGluZ1xuICpcbiAqIERlbGVnYXRlcyB0byBjb3JlL1RyYW5zcG9ydENvcmUgYW5kIGNvcmUvUmVxdWVzdEhhbmRsZXIuXG4gKiBTaW1wbGlmaWVkIHdyYXBwZXIgcHJvdmlkaW5nIE9ic2VydmFibGUtc3R5bGUgbWVzc2FnZSBoYW5kbGluZy5cbiAqL1xuXG5pbXBvcnQgeyBVVUlEdjQgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5pbXBvcnQge1xuICAgIGNyZWF0ZVRyYW5zcG9ydFNlbmRlcixcbiAgICBjcmVhdGVUcmFuc3BvcnRMaXN0ZW5lcixcbiAgICB0eXBlIFRyYW5zcG9ydFRhcmdldCxcbiAgICB0eXBlIFNlbmRGblxufSBmcm9tIFwiLi4vLi4vY29yZS9UcmFuc3BvcnRDb3JlXCI7XG5pbXBvcnQgeyBoYW5kbGVSZXF1ZXN0IH0gZnJvbSBcIi4uLy4uL2NvcmUvUmVxdWVzdEhhbmRsZXJcIjtcbmltcG9ydCB0eXBlIHsgQ2hhbm5lbE1lc3NhZ2UsIFN1YnNjcmliZXIsIFN1YnNjcmlwdGlvbiwgT2JzZXJ2ZXIgfSBmcm9tIFwiLi4vb2JzZXJ2YWJsZS9PYnNlcnZhYmxlXCI7XG5pbXBvcnQgdHlwZSB7IFdSZXEgfSBmcm9tIFwiLi4vdHlwZXMvSW50ZXJmYWNlXCI7XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFRZUEVTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCB0eXBlIE1lc3NhZ2VUeXBlID0gXCJyZXF1ZXN0XCIgfCBcInJlc3BvbnNlXCIgfCBcImV2ZW50XCIgfCBcInBpbmdcIiB8IFwicG9uZ1wiO1xuZXhwb3J0IHR5cGUgUmVzcG9uZEZuPFQgPSBhbnk+ID0gKHJlc3VsdDogVCwgdHJhbnNmZXI/OiBUcmFuc2ZlcmFibGVbXSkgPT4gdm9pZCB8IFByb21pc2U8dm9pZD47XG5leHBvcnQgdHlwZSBNZXNzYWdlSGFuZGxlckNhbGxiYWNrPFQgPSBDaGFubmVsTWVzc2FnZT4gPSAoZGF0YTogVCwgcmVzcG9uZDogUmVzcG9uZEZuPFQ+KSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcblxuZXhwb3J0IGludGVyZmFjZSBDaGFubmVsU3Vic2NyaWJlcjxUID0gQ2hhbm5lbE1lc3NhZ2U+IGV4dGVuZHMgU3Vic2NyaWJlcjxUPiB7XG4gICAgcmVxdWVzdD8obXNnOiBUKTogUHJvbWlzZTxhbnk+O1xufVxuXG5pbnRlcmZhY2UgUGVuZGluZ1JlcXVlc3Qge1xuICAgIHJlc29sdmU6ICh2YWx1ZTogYW55KSA9PiB2b2lkO1xuICAgIHJlamVjdDogKGVycm9yOiBFcnJvcikgPT4gdm9pZDtcbiAgICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuZXhwb3J0IHR5cGUgeyBUcmFuc3BvcnRUYXJnZXQgfTtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gTUVTU0FHRSBIQU5ETEVSIEZBQ1RPUllcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VDaGFubmVsTWVzc2FnZUhhbmRsZXIoXG4gICAgdHJhbnNwb3J0OiBUcmFuc3BvcnRUYXJnZXQsXG4gICAgY2hhbm5lbE5hbWU6IHN0cmluZyxcbiAgICBoYW5kbGVyPzogTWVzc2FnZUhhbmRsZXJDYWxsYmFjazxDaGFubmVsTWVzc2FnZT5cbik6IChzdWJzY3JpYmVyOiBDaGFubmVsU3Vic2NyaWJlcjxDaGFubmVsTWVzc2FnZT4pID0+ICgpID0+IHZvaWQge1xuICAgIGNvbnN0IHBlbmRpbmcgPSBuZXcgTWFwPHN0cmluZywgUGVuZGluZ1JlcXVlc3Q+KCk7XG4gICAgY29uc3Qgc2VuZCA9IGNyZWF0ZVRyYW5zcG9ydFNlbmRlcih0cmFuc3BvcnQpO1xuXG4gICAgcmV0dXJuIChzdWJzY3JpYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbmQgPSAoZGF0YTogQ2hhbm5lbE1lc3NhZ2UpOiBSZXNwb25kRm48Q2hhbm5lbE1lc3NhZ2U+ID0+IHtcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09IFwicmVzcG9uc2VcIiAmJiBkYXRhLnJlcUlkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcCA9IHBlbmRpbmcuZ2V0KGRhdGEucmVxSWQhKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHApIHsgcC5yZXNvbHZlKHJlc3VsdCk7IHBlbmRpbmcuZGVsZXRlKGRhdGEucmVxSWQhKTsgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGF0YS50eXBlID09PSBcInJlcXVlc3RcIikge1xuICAgICAgICAgICAgICAgIHJldHVybiAocmVzdWx0LCB0cmFuc2ZlcikgPT4gc2VuZCh7IC4uLnJlc3VsdCwgY2hhbm5lbDogZGF0YS5zZW5kZXIsIHNlbmRlcjogY2hhbm5lbE5hbWUsIHR5cGU6IFwicmVzcG9uc2VcIiwgcmVxSWQ6IGRhdGEucmVxSWQgfSwgdHJhbnNmZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHNlbmQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgb25NZXNzYWdlID0gKGRhdGE6IENoYW5uZWxNZXNzYWdlKTogdm9pZCA9PiB7XG4gICAgICAgICAgICBpZiAoIXN1YnNjcmliZXIuYWN0aXZlKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoZGF0YS50eXBlID09PSBcInJlc3BvbnNlXCIgJiYgZGF0YS5yZXFJZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHAgPSBwZW5kaW5nLmdldChkYXRhLnJlcUlkKTtcbiAgICAgICAgICAgICAgICBpZiAocCkgeyBwLnJlc29sdmUoZGF0YS5wYXlsb2FkKTsgcGVuZGluZy5kZWxldGUoZGF0YS5yZXFJZCk7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGhhbmRsZXIgPyBoYW5kbGVyKGRhdGEsIHJlc3BvbmQoZGF0YSkpIDogc3Vic2NyaWJlci5uZXh0KGRhdGEpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGNsZWFudXAgPSBjcmVhdGVUcmFuc3BvcnRMaXN0ZW5lcih0cmFuc3BvcnQsIG9uTWVzc2FnZSwgKGUpID0+IHN1YnNjcmliZXIuZXJyb3IoZSksICgpID0+IHN1YnNjcmliZXIuY29tcGxldGUoKSk7XG5cbiAgICAgICAgLy8gQWRkIHJlcXVlc3QgY2FwYWJpbGl0eVxuICAgICAgICAoc3Vic2NyaWJlciBhcyBhbnkpLnJlcXVlc3QgPSAobXNnOiBDaGFubmVsTWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxSWQgPSBtc2cucmVxSWQgPz8gVVVJRHY0KCk7XG4gICAgICAgICAgICBtc2cucmVxSWQgPSByZXFJZDtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgcGVuZGluZy5zZXQocmVxSWQsIHsgcmVzb2x2ZSwgcmVqZWN0LCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSk7XG4gICAgICAgICAgICAgICAgc2VuZChtc2cpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIGNsZWFudXA7XG4gICAgfTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gTUVTU0FHRSBPQlNFUlZBQkxFXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjbGFzcyBDaGFubmVsTWVzc2FnZU9ic2VydmFibGUge1xuICAgIHByaXZhdGUgX3BlbmRpbmcgPSBuZXcgTWFwPHN0cmluZywgUGVuZGluZ1JlcXVlc3Q+KCk7XG4gICAgcHJpdmF0ZSBfc3VicyA9IG5ldyBTZXQ8T2JzZXJ2ZXI8Q2hhbm5lbE1lc3NhZ2U+PigpO1xuICAgIHByaXZhdGUgX2NsZWFudXA6ICgoKSA9PiB2b2lkKSB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgX3NlbmQ6IFNlbmRGbjxDaGFubmVsTWVzc2FnZT47XG4gICAgcHJpdmF0ZSBfYWN0aXZlID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF90cmFuc3BvcnQ6IFRyYW5zcG9ydFRhcmdldCwgcHJpdmF0ZSBfY2hhbm5lbE5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9zZW5kID0gY3JlYXRlVHJhbnNwb3J0U2VuZGVyKF90cmFuc3BvcnQpO1xuICAgIH1cblxuICAgIHN1YnNjcmliZShvYnNlcnZlcjogeyBuZXh0PzogKHY6IENoYW5uZWxNZXNzYWdlKSA9PiB2b2lkOyBlcnJvcj86IChlOiBFcnJvcikgPT4gdm9pZDsgY29tcGxldGU/OiAoKSA9PiB2b2lkIH0pOiB7IHVuc3Vic2NyaWJlOiAoKSA9PiB2b2lkIH0ge1xuICAgICAgICB0aGlzLl9zdWJzLmFkZChvYnNlcnZlcik7XG4gICAgICAgIGlmICghdGhpcy5fYWN0aXZlKSB0aGlzLl9hY3RpdmF0ZSgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdW5zdWJzY3JpYmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdWJzLmRlbGV0ZShvYnNlcnZlcik7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N1YnMuc2l6ZSA9PT0gMCkgdGhpcy5fZGVhY3RpdmF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIG5leHQobXNnOiBDaGFubmVsTWVzc2FnZSwgdHJhbnNmZXI/OiBUcmFuc2ZlcmFibGVbXSk6IHZvaWQgeyB0aGlzLl9zZW5kKG1zZywgdHJhbnNmZXIpOyB9XG5cbiAgICByZXF1ZXN0KG1zZzogT21pdDxDaGFubmVsTWVzc2FnZSwgXCJyZXFJZFwiPiAmIHsgcmVxSWQ/OiBzdHJpbmcgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlcUlkID0gbXNnLnJlcUlkID8/IFVVSUR2NCgpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcGVuZGluZy5zZXQocmVxSWQsIHsgcmVzb2x2ZSwgcmVqZWN0LCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSk7XG4gICAgICAgICAgICB0aGlzLm5leHQoeyAuLi5tc2csIHJlcUlkIH0gYXMgQ2hhbm5lbE1lc3NhZ2UpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX2FjdGl2ZSkgcmV0dXJuO1xuICAgICAgICB0aGlzLl9jbGVhbnVwID0gY3JlYXRlVHJhbnNwb3J0TGlzdGVuZXIoXG4gICAgICAgICAgICB0aGlzLl90cmFuc3BvcnQsXG4gICAgICAgICAgICAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09IFwicmVzcG9uc2VcIiAmJiBkYXRhLnJlcUlkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLl9wZW5kaW5nLmdldChkYXRhLnJlcUlkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHApIHsgcC5yZXNvbHZlKGRhdGEucGF5bG9hZCk7IHRoaXMuX3BlbmRpbmcuZGVsZXRlKGRhdGEucmVxSWQpOyB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9zdWJzKSB7IHRyeSB7IHMubmV4dD8uKGRhdGEpOyB9IGNhdGNoIChlKSB7IHMuZXJyb3I/LihlIGFzIEVycm9yKTsgfSB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGUpID0+IHRoaXMuX3N1YnMuZm9yRWFjaCgocykgPT4gcy5lcnJvcj8uKGUpKSxcbiAgICAgICAgICAgICgpID0+IHRoaXMuX3N1YnMuZm9yRWFjaCgocykgPT4gcy5jb21wbGV0ZT8uKCkpXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuX2FjdGl2ZSA9IHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZGVhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fY2xlYW51cD8uKCk7IHRoaXMuX2NsZWFudXAgPSBudWxsOyB0aGlzLl9hY3RpdmUgPSBmYWxzZTtcbiAgICB9XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFJFUVVFU1QgSEFORExFUiBGQUNUT1JZXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDaGFubmVsUmVxdWVzdEhhbmRsZXIoXG4gICAgY2hhbm5lbE5hbWU6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7IG9uUmVxdWVzdD86IChyZXE6IFdSZXEpID0+IHZvaWQ7IG9uUmVzcG9uc2U/OiAocmVzOiBhbnkpID0+IHZvaWQgfSA9IHt9XG4pOiBNZXNzYWdlSGFuZGxlckNhbGxiYWNrPENoYW5uZWxNZXNzYWdlPiB7XG4gICAgcmV0dXJuIGFzeW5jIChkYXRhLCByZXNwb25kKSA9PiB7XG4gICAgICAgIGlmIChkYXRhLnR5cGUgIT09IFwicmVxdWVzdFwiIHx8IGRhdGEuY2hhbm5lbCAhPT0gY2hhbm5lbE5hbWUpIHJldHVybjtcbiAgICAgICAgb3B0aW9ucy5vblJlcXVlc3Q/LihkYXRhLnBheWxvYWQgYXMgV1JlcSk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZVJlcXVlc3QoZGF0YS5wYXlsb2FkIGFzIFdSZXEsIGRhdGEucmVxSWQhLCBjaGFubmVsTmFtZSk7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgIG9wdGlvbnMub25SZXNwb25zZT8uKHJlc3VsdC5yZXNwb25zZSk7XG4gICAgICAgICAgICByZXNwb25kKHsgLi4ucmVzdWx0LnJlc3BvbnNlLCBpZDogVVVJRHY0KCksIHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9IGFzIENoYW5uZWxNZXNzYWdlLCByZXN1bHQudHJhbnNmZXIpO1xuICAgICAgICB9XG4gICAgfTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gRElTUEFUQ0hFUiAoU2ltcGxpZmllZClcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGNsYXNzIE9ic2VydmFibGVSZXF1ZXN0RGlzcGF0Y2hlciB7XG4gICAgcHJpdmF0ZSBfcGVuZGluZyA9IG5ldyBNYXA8c3RyaW5nLCBQZW5kaW5nUmVxdWVzdD4oKTtcbiAgICBwcml2YXRlIF9zdWJzY3JpYmVyOiBDaGFubmVsU3Vic2NyaWJlcjxDaGFubmVsTWVzc2FnZT4gfCBudWxsID0gbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NoYW5uZWxOYW1lOiBzdHJpbmcsIHByaXZhdGUgX3RhcmdldENoYW5uZWw6IHN0cmluZykge31cblxuICAgIGNvbm5lY3Qoc3Vic2NyaWJlcjogQ2hhbm5lbFN1YnNjcmliZXI8Q2hhbm5lbE1lc3NhZ2U+KTogdm9pZCB7IHRoaXMuX3N1YnNjcmliZXIgPSBzdWJzY3JpYmVyOyB9XG5cbiAgICBkaXNjb25uZWN0KCk6IHZvaWQge1xuICAgICAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5fcGVuZGluZy52YWx1ZXMoKSkgcC5yZWplY3QobmV3IEVycm9yKFwiRGlzY29ubmVjdGVkXCIpKTtcbiAgICAgICAgdGhpcy5fcGVuZGluZy5jbGVhcigpO1xuICAgICAgICB0aGlzLl9zdWJzY3JpYmVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBoYW5kbGVNZXNzYWdlKGRhdGE6IENoYW5uZWxNZXNzYWdlKTogdm9pZCB7XG4gICAgICAgIGlmIChkYXRhLnR5cGUgPT09IFwicmVzcG9uc2VcIiAmJiBkYXRhLnJlcUlkKSB7XG4gICAgICAgICAgICBjb25zdCBwID0gdGhpcy5fcGVuZGluZy5nZXQoZGF0YS5yZXFJZCk7XG4gICAgICAgICAgICBpZiAocCkgeyBwLnJlc29sdmUoZGF0YS5wYXlsb2FkKTsgdGhpcy5fcGVuZGluZy5kZWxldGUoZGF0YS5yZXFJZCk7IH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRpc3BhdGNoKGFjdGlvbjogc3RyaW5nLCBwYXRoOiBzdHJpbmdbXSwgYXJnczogYW55W10pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmliZXI/LmFjdGl2ZSkgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcihcIk5vdCBjb25uZWN0ZWRcIikpO1xuICAgICAgICBjb25zdCByZXFJZCA9IFVVSUR2NCgpO1xuICAgICAgICBjb25zdCBtc2c6IENoYW5uZWxNZXNzYWdlID0ge1xuICAgICAgICAgICAgaWQ6IFVVSUR2NCgpLCBjaGFubmVsOiB0aGlzLl90YXJnZXRDaGFubmVsLCBzZW5kZXI6IHRoaXMuX2NoYW5uZWxOYW1lLFxuICAgICAgICAgICAgdHlwZTogXCJyZXF1ZXN0XCIsIHJlcUlkLCBwYXlsb2FkOiB7IGNoYW5uZWw6IHRoaXMuX3RhcmdldENoYW5uZWwsIHNlbmRlcjogdGhpcy5fY2hhbm5lbE5hbWUsIHBhdGgsIGFjdGlvbiwgYXJncyB9LFxuICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLl9wZW5kaW5nLnNldChyZXFJZCwgeyByZXNvbHZlLCByZWplY3QsIHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9KSk7XG4gICAgICAgIHRoaXMuX3N1YnNjcmliZXIubmV4dChtc2cpO1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG59XG5cbmV4cG9ydCB0eXBlIHsgUGVuZGluZ1JlcXVlc3QsIE1lc3NhZ2VIYW5kbGVyQ2FsbGJhY2sgYXMgQ2hhbm5lbE1lc3NhZ2VDYWxsYmFjayB9O1xuIl19