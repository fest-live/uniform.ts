/**
 * Channel Connection - Connection abstraction layer
 *
 * Provides connection pooling, state management, and message routing.
 */
import { UUIDv4 } from "fest/core";
import { ChannelSubject, filter } from "../observable/Observable";
// ============================================================================
// CHANNEL CONNECTION
// ============================================================================
export class ChannelConnection {
    _name;
    _transportType;
    _id = UUIDv4();
    _state = "disconnected";
    _inbound = new ChannelSubject({ bufferSize: 1000 });
    _outbound = new ChannelSubject({ bufferSize: 1000 });
    _stateChanges = new ChannelSubject();
    _connectedPeers = new Map();
    _subs = [];
    _stats = { messagesSent: 0, messagesReceived: 0, bytesTransferred: 0, latencyMs: 0, uptime: 0, reconnectCount: 0 };
    _startTime = 0;
    // @ts-ignore
    _pending = new Map();
    _buffer = [];
    _opts;
    constructor(_name, _transportType = "internal", options = {}) {
        this._name = _name;
        this._transportType = _transportType;
        this._opts = {
            timeout: 30000,
            autoReconnect: true,
            reconnectInterval: 1000,
            maxReconnectAttempts: 5,
            bufferMessages: true,
            bufferSize: 1000,
            metadata: {},
            ...options
        };
        this._setupSubscriptions();
    }
    // Observable API
    subscribe(observer, fromChannel) {
        const src = fromChannel ? filter((m) => m.sender === fromChannel)(this._inbound) : this._inbound;
        return src.subscribe(typeof observer === "function" ? { next: observer } : observer);
    }
    next(message) {
        if (this._state !== "connected") {
            if (this._opts.bufferMessages && this._buffer.length < this._opts.bufferSize) {
                this._buffer.push(message);
            }
            return;
        }
        this._outbound.next(message);
        this._stats.messagesSent++;
    }
    async request(toChannel, payload, opts = {}) {
        const reqId = UUIDv4();
        // @ts-ignore
        const resolvers = Promise.withResolvers();
        this._pending.set(reqId, resolvers);
        const timeout = setTimeout(() => {
            if (this._pending.has(reqId)) {
                this._pending.delete(reqId);
                resolvers.reject(new Error(`Request timeout`));
            }
        }, opts.timeout ?? this._opts.timeout);
        this.next({
            id: UUIDv4(), channel: toChannel, sender: this._name, type: "request",
            reqId, payload: { ...payload, action: opts.action, path: opts.path }, timestamp: Date.now()
        });
        return resolvers.promise.finally(() => clearTimeout(timeout));
    }
    respond(original, payload) {
        this.next({ id: UUIDv4(), channel: original.sender, sender: this._name, type: "response", reqId: original.reqId, payload, timestamp: Date.now() });
    }
    emit(toChannel, eventType, data) {
        this.next({ id: UUIDv4(), channel: toChannel, sender: this._name, type: "event", payload: { type: eventType, data }, timestamp: Date.now() });
    }
    subscribeOutbound(observer) {
        return this._outbound.subscribe(typeof observer === "function" ? { next: observer } : observer);
    }
    pushInbound(message) {
        this._stats.messagesReceived++;
        if (message.type === "response" && message.reqId) {
            const r = this._pending.get(message.reqId);
            if (r) {
                this._pending.delete(message.reqId);
                r.resolve(message.payload);
                return;
            }
        }
        this._inbound.next(message);
    }
    // Connection lifecycle
    async connect() {
        if (this._state === "connected")
            return;
        this._setState("connecting");
        this._startTime = Date.now();
        this._setState("connected");
        this._flushBuffer();
    }
    disconnect() {
        if (this._state === "disconnected" || this._state === "closed")
            return;
        this._setState("disconnected");
        this._subs.forEach((s) => s.unsubscribe());
        this._subs = [];
    }
    close() {
        this.disconnect();
        this._setState("closed");
        this._inbound.complete();
        this._outbound.complete();
        this._stateChanges.complete();
    }
    markConnected() { this._setState("connected"); this._flushBuffer(); }
    markDisconnected() { this._setState("disconnected"); }
    // State management
    _setState(state) {
        if (this._state !== state) {
            this._state = state;
            this._stateChanges.next(state);
        }
    }
    _flushBuffer() {
        for (const msg of this._buffer)
            this._outbound.next(msg);
        this._buffer = [];
    }
    _setupSubscriptions() {
        this._subs.push(this._inbound.subscribe({
            next: (msg) => {
                if (msg.type === "signal" && msg.payload?.type === "connect") {
                    this._connectedPeers.set(msg.sender, { name: msg.sender, state: "connected", isHost: false });
                }
            }
        }));
    }
    // Getters
    get id() { return this._id; }
    get name() { return this._name; }
    get state() { return this._state; }
    get transportType() { return this._transportType; }
    get stats() { return { ...this._stats, uptime: this._startTime ? Date.now() - this._startTime : 0 }; }
    get stateChanges() { return this._stateChanges; }
    get connectedPeers() { return [...this._connectedPeers.keys()]; }
    get meta() { return { id: this._id, name: this._name, state: this._state, isHost: false, connectedChannels: new Set(this._connectedPeers.keys()) }; }
}
// ============================================================================
// CONNECTION POOL
// ============================================================================
export class ConnectionPool {
    _connections = new Map();
    static _instance = null;
    static getInstance() {
        if (!ConnectionPool._instance)
            ConnectionPool._instance = new ConnectionPool();
        return ConnectionPool._instance;
    }
    getOrCreate(name, transportType = "internal", options = {}) {
        if (!this._connections.has(name)) {
            this._connections.set(name, new ChannelConnection(name, transportType, options));
        }
        return this._connections.get(name);
    }
    get(name) { return this._connections.get(name); }
    has(name) { return this._connections.has(name); }
    delete(name) { this._connections.get(name)?.close(); return this._connections.delete(name); }
    clear() { this._connections.forEach((c) => c.close()); this._connections.clear(); }
    get size() { return this._connections.size; }
    get names() { return [...this._connections.keys()]; }
}
// ============================================================================
// FACTORY FUNCTIONS
// ============================================================================
export const getConnectionPool = () => ConnectionPool.getInstance();
export const getConnection = (name, transportType, options) => getConnectionPool().getOrCreate(name, transportType, options);
export const getHostConnection = (name = "$host$", options) => getConnection(name, "internal", { ...options, metadata: { ...options?.metadata, isHost: true } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNvbm5lY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLGNBQWMsRUFBcUIsTUFBTSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUE0QnJGLCtFQUErRTtBQUMvRSxxQkFBcUI7QUFDckIsK0VBQStFO0FBRS9FLE1BQU0sT0FBTyxpQkFBaUI7SUFnQmQ7SUFDQTtJQWhCSixHQUFHLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDZixNQUFNLEdBQWlCLGNBQWMsQ0FBQztJQUN0QyxRQUFRLEdBQUcsSUFBSSxjQUFjLENBQWlCLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDcEUsU0FBUyxHQUFHLElBQUksY0FBYyxDQUFpQixFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3JFLGFBQWEsR0FBRyxJQUFJLGNBQWMsRUFBZ0IsQ0FBQztJQUNuRCxlQUFlLEdBQUcsSUFBSSxHQUFHLEVBQXVCLENBQUM7SUFDakQsS0FBSyxHQUFtQixFQUFFLENBQUM7SUFDM0IsTUFBTSxHQUFvQixFQUFFLFlBQVksRUFBRSxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLGdCQUFnQixFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsY0FBYyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3BJLFVBQVUsR0FBRyxDQUFDLENBQUM7SUFDdkIsYUFBYTtJQUNMLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBcUMsQ0FBQztJQUN4RCxPQUFPLEdBQXFCLEVBQUUsQ0FBQztJQUMvQixLQUFLLENBQThCO0lBRTNDLFlBQ1ksS0FBYSxFQUNiLGlCQUFnQyxVQUFVLEVBQ2xELFVBQTZCLEVBQUU7UUFGdkIs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QUM7SUFDOUcsS0FBSyxLQUFXLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3pGLElBQUksSUFBSSxLQUFhLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3JELElBQUksS0FBSyxLQUFlLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBR25FLCtFQUErRTtBQUMvRSxvQkFBb0I7QUFDcEIsK0VBQStFO0FBRS9FLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLEdBQW1CLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDcEYsTUFBTSxDQUFDLE1BQU0sYUFBYSxHQUFHLENBQUMsSUFBWSxFQUFFLGFBQTZCLEVBQUUsT0FBMkIsRUFBcUIsRUFBRSxDQUN6SCxpQkFBaUIsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ2xFLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsT0FBZSxRQUFRLEVBQUUsT0FBMkIsRUFBcUIsRUFBRSxDQUN6RyxhQUFhLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxFQUFFLEdBQUcsT0FBTyxFQUFFLFFBQVEsRUFBRSxFQUFFLEdBQUcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDaGFubmVsIENvbm5lY3Rpb24gLSBDb25uZWN0aW9uIGFic3RyYWN0aW9uIGxheWVyXG4gKlxuICogUHJvdmlkZXMgY29ubmVjdGlvbiBwb29saW5nLCBzdGF0ZSBtYW5hZ2VtZW50LCBhbmQgbWVzc2FnZSByb3V0aW5nLlxuICovXG5cbmltcG9ydCB7IFVVSUR2NCB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7IENoYW5uZWxTdWJqZWN0LCBNZXNzYWdlT2JzZXJ2YWJsZSwgZmlsdGVyIH0gZnJvbSBcIi4uL29ic2VydmFibGUvT2JzZXJ2YWJsZVwiO1xuaW1wb3J0IHR5cGUge1xuICAgIENoYW5uZWxNZXNzYWdlLFxuICAgIENoYW5uZWxTdGF0ZSxcbiAgICBDaGFubmVsTWV0YSxcbiAgICBPYnNlcnZlcixcbiAgICBTdWJzY3JpcHRpb24sXG4gICAgVHJhbnNwb3J0VHlwZSxcbiAgICBDb25uZWN0aW9uT3B0aW9ucyxcbiAgICBQZW5kaW5nUmVxdWVzdFxufSBmcm9tIFwiLi4vdHlwZXMvSW50ZXJmYWNlXCI7XG5cbi8vIFJlLWV4cG9ydCB0eXBlc1xuZXhwb3J0IHR5cGUgeyBUcmFuc3BvcnRUeXBlLCBDb25uZWN0aW9uT3B0aW9ucyB9O1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBDT05ORUNUSU9OIFNUQVRTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvblN0YXRzIHtcbiAgICBtZXNzYWdlc1NlbnQ6IG51bWJlcjtcbiAgICBtZXNzYWdlc1JlY2VpdmVkOiBudW1iZXI7XG4gICAgYnl0ZXNUcmFuc2ZlcnJlZDogbnVtYmVyO1xuICAgIGxhdGVuY3lNczogbnVtYmVyO1xuICAgIHVwdGltZTogbnVtYmVyO1xuICAgIHJlY29ubmVjdENvdW50OiBudW1iZXI7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIENIQU5ORUwgQ09OTkVDVElPTlxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgY2xhc3MgQ2hhbm5lbENvbm5lY3Rpb24ge1xuICAgIHByaXZhdGUgX2lkID0gVVVJRHY0KCk7XG4gICAgcHJpdmF0ZSBfc3RhdGU6IENoYW5uZWxTdGF0ZSA9IFwiZGlzY29ubmVjdGVkXCI7XG4gICAgcHJpdmF0ZSBfaW5ib3VuZCA9IG5ldyBDaGFubmVsU3ViamVjdDxDaGFubmVsTWVzc2FnZT4oeyBidWZmZXJTaXplOiAxMDAwIH0pO1xuICAgIHByaXZhdGUgX291dGJvdW5kID0gbmV3IENoYW5uZWxTdWJqZWN0PENoYW5uZWxNZXNzYWdlPih7IGJ1ZmZlclNpemU6IDEwMDAgfSk7XG4gICAgcHJpdmF0ZSBfc3RhdGVDaGFuZ2VzID0gbmV3IENoYW5uZWxTdWJqZWN0PENoYW5uZWxTdGF0ZT4oKTtcbiAgICBwcml2YXRlIF9jb25uZWN0ZWRQZWVycyA9IG5ldyBNYXA8c3RyaW5nLCBDaGFubmVsTWV0YT4oKTtcbiAgICBwcml2YXRlIF9zdWJzOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuICAgIHByaXZhdGUgX3N0YXRzOiBDb25uZWN0aW9uU3RhdHMgPSB7IG1lc3NhZ2VzU2VudDogMCwgbWVzc2FnZXNSZWNlaXZlZDogMCwgYnl0ZXNUcmFuc2ZlcnJlZDogMCwgbGF0ZW5jeU1zOiAwLCB1cHRpbWU6IDAsIHJlY29ubmVjdENvdW50OiAwIH07XG4gICAgcHJpdmF0ZSBfc3RhcnRUaW1lID0gMDtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcHJpdmF0ZSBfcGVuZGluZyA9IG5ldyBNYXA8c3RyaW5nLCBQcm9taXNlV2l0aFJlc29sdmVyczxhbnk+PigpO1xuICAgIHByaXZhdGUgX2J1ZmZlcjogQ2hhbm5lbE1lc3NhZ2VbXSA9IFtdO1xuICAgIHByaXZhdGUgX29wdHM6IFJlcXVpcmVkPENvbm5lY3Rpb25PcHRpb25zPjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIF9uYW1lOiBzdHJpbmcsXG4gICAgICAgIHByaXZhdGUgX3RyYW5zcG9ydFR5cGU6IFRyYW5zcG9ydFR5cGUgPSBcImludGVybmFsXCIsXG4gICAgICAgIG9wdGlvbnM6IENvbm5lY3Rpb25PcHRpb25zID0ge31cbiAgICApIHtcbiAgICAgICAgdGhpcy5fb3B0cyA9IHtcbiAgICAgICAgICAgIHRpbWVvdXQ6IDMwMDAwLFxuICAgICAgICAgICAgYXV0b1JlY29ubmVjdDogdHJ1ZSxcbiAgICAgICAgICAgIHJlY29ubmVjdEludGVydmFsOiAxMDAwLFxuICAgICAgICAgICAgbWF4UmVjb25uZWN0QXR0ZW1wdHM6IDUsXG4gICAgICAgICAgICBidWZmZXJNZXNzYWdlczogdHJ1ZSxcbiAgICAgICAgICAgIGJ1ZmZlclNpemU6IDEwMDAsXG4gICAgICAgICAgICBtZXRhZGF0YToge30sXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuX3NldHVwU3Vic2NyaXB0aW9ucygpO1xuICAgIH1cblxuICAgIC8vIE9ic2VydmFibGUgQVBJXG4gICAgc3Vic2NyaWJlKG9ic2VydmVyOiBPYnNlcnZlcjxDaGFubmVsTWVzc2FnZT4gfCAoKG1zZzogQ2hhbm5lbE1lc3NhZ2UpID0+IHZvaWQpLCBmcm9tQ2hhbm5lbD86IHN0cmluZyk6IFN1YnNjcmlwdGlvbiB7XG4gICAgICAgIGNvbnN0IHNyYyA9IGZyb21DaGFubmVsID8gZmlsdGVyKChtOiBDaGFubmVsTWVzc2FnZSkgPT4gbS5zZW5kZXIgPT09IGZyb21DaGFubmVsKSh0aGlzLl9pbmJvdW5kKSA6IHRoaXMuX2luYm91bmQ7XG4gICAgICAgIHJldHVybiBzcmMuc3Vic2NyaWJlKHR5cGVvZiBvYnNlcnZlciA9PT0gXCJmdW5jdGlvblwiID8geyBuZXh0OiBvYnNlcnZlciB9IDogb2JzZXJ2ZXIpO1xuICAgIH1cblxuICAgIG5leHQobWVzc2FnZTogQ2hhbm5lbE1lc3NhZ2UpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX3N0YXRlICE9PSBcImNvbm5lY3RlZFwiKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fb3B0cy5idWZmZXJNZXNzYWdlcyAmJiB0aGlzLl9idWZmZXIubGVuZ3RoIDwgdGhpcy5fb3B0cy5idWZmZXJTaXplKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fYnVmZmVyLnB1c2gobWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fb3V0Ym91bmQubmV4dChtZXNzYWdlKTtcbiAgICAgICAgdGhpcy5fc3RhdHMubWVzc2FnZXNTZW50Kys7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVxdWVzdDxUID0gYW55Pih0b0NoYW5uZWw6IHN0cmluZywgcGF5bG9hZDogYW55LCBvcHRzOiB7IHRpbWVvdXQ/OiBudW1iZXI7IGFjdGlvbj86IHN0cmluZzsgcGF0aD86IHN0cmluZ1tdIH0gPSB7fSk6IFByb21pc2U8VD4ge1xuICAgICAgICBjb25zdCByZXFJZCA9IFVVSUR2NCgpO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHJlc29sdmVycyA9IFByb21pc2Uud2l0aFJlc29sdmVyczxUPigpO1xuICAgICAgICB0aGlzLl9wZW5kaW5nLnNldChyZXFJZCwgcmVzb2x2ZXJzKTtcblxuICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcGVuZGluZy5oYXMocmVxSWQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGVuZGluZy5kZWxldGUocmVxSWQpO1xuICAgICAgICAgICAgICAgIHJlc29sdmVycy5yZWplY3QobmV3IEVycm9yKGBSZXF1ZXN0IHRpbWVvdXRgKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIG9wdHMudGltZW91dCA/PyB0aGlzLl9vcHRzLnRpbWVvdXQpO1xuXG4gICAgICAgIHRoaXMubmV4dCh7XG4gICAgICAgICAgICBpZDogVVVJRHY0KCksIGNoYW5uZWw6IHRvQ2hhbm5lbCwgc2VuZGVyOiB0aGlzLl9uYW1lLCB0eXBlOiBcInJlcXVlc3RcIixcbiAgICAgICAgICAgIHJlcUlkLCBwYXlsb2FkOiB7IC4uLnBheWxvYWQsIGFjdGlvbjogb3B0cy5hY3Rpb24sIHBhdGg6IG9wdHMucGF0aCB9LCB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmVycy5wcm9taXNlLmZpbmFsbHkoKCkgPT4gY2xlYXJUaW1lb3V0KHRpbWVvdXQpKTtcbiAgICB9XG5cbiAgICByZXNwb25kKG9yaWdpbmFsOiBDaGFubmVsTWVzc2FnZSwgcGF5bG9hZDogYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMubmV4dCh7IGlkOiBVVUlEdjQoKSwgY2hhbm5lbDogb3JpZ2luYWwuc2VuZGVyLCBzZW5kZXI6IHRoaXMuX25hbWUsIHR5cGU6IFwicmVzcG9uc2VcIiwgcmVxSWQ6IG9yaWdpbmFsLnJlcUlkLCBwYXlsb2FkLCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSk7XG4gICAgfVxuXG4gICAgZW1pdCh0b0NoYW5uZWw6IHN0cmluZywgZXZlbnRUeXBlOiBzdHJpbmcsIGRhdGE6IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLm5leHQoeyBpZDogVVVJRHY0KCksIGNoYW5uZWw6IHRvQ2hhbm5lbCwgc2VuZGVyOiB0aGlzLl9uYW1lLCB0eXBlOiBcImV2ZW50XCIsIHBheWxvYWQ6IHsgdHlwZTogZXZlbnRUeXBlLCBkYXRhIH0sIHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9KTtcbiAgICB9XG5cbiAgICBzdWJzY3JpYmVPdXRib3VuZChvYnNlcnZlcjogT2JzZXJ2ZXI8Q2hhbm5lbE1lc3NhZ2U+IHwgKChtc2c6IENoYW5uZWxNZXNzYWdlKSA9PiB2b2lkKSk6IFN1YnNjcmlwdGlvbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9vdXRib3VuZC5zdWJzY3JpYmUodHlwZW9mIG9ic2VydmVyID09PSBcImZ1bmN0aW9uXCIgPyB7IG5leHQ6IG9ic2VydmVyIH0gOiBvYnNlcnZlcik7XG4gICAgfVxuXG4gICAgcHVzaEluYm91bmQobWVzc2FnZTogQ2hhbm5lbE1lc3NhZ2UpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fc3RhdHMubWVzc2FnZXNSZWNlaXZlZCsrO1xuICAgICAgICBpZiAobWVzc2FnZS50eXBlID09PSBcInJlc3BvbnNlXCIgJiYgbWVzc2FnZS5yZXFJZCkge1xuICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuX3BlbmRpbmcuZ2V0KG1lc3NhZ2UucmVxSWQpO1xuICAgICAgICAgICAgaWYgKHIpIHsgdGhpcy5fcGVuZGluZy5kZWxldGUobWVzc2FnZS5yZXFJZCk7IHIucmVzb2x2ZShtZXNzYWdlLnBheWxvYWQpOyByZXR1cm47IH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9pbmJvdW5kLm5leHQobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgLy8gQ29ubmVjdGlvbiBsaWZlY3ljbGVcbiAgICBhc3luYyBjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAodGhpcy5fc3RhdGUgPT09IFwiY29ubmVjdGVkXCIpIHJldHVybjtcbiAgICAgICAgdGhpcy5fc2V0U3RhdGUoXCJjb25uZWN0aW5nXCIpO1xuICAgICAgICB0aGlzLl9zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICB0aGlzLl9zZXRTdGF0ZShcImNvbm5lY3RlZFwiKTtcbiAgICAgICAgdGhpcy5fZmx1c2hCdWZmZXIoKTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5fc3RhdGUgPT09IFwiZGlzY29ubmVjdGVkXCIgfHwgdGhpcy5fc3RhdGUgPT09IFwiY2xvc2VkXCIpIHJldHVybjtcbiAgICAgICAgdGhpcy5fc2V0U3RhdGUoXCJkaXNjb25uZWN0ZWRcIik7XG4gICAgICAgIHRoaXMuX3N1YnMuZm9yRWFjaCgocykgPT4gcy51bnN1YnNjcmliZSgpKTtcbiAgICAgICAgdGhpcy5fc3VicyA9IFtdO1xuICAgIH1cblxuICAgIGNsb3NlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgdGhpcy5fc2V0U3RhdGUoXCJjbG9zZWRcIik7XG4gICAgICAgIHRoaXMuX2luYm91bmQuY29tcGxldGUoKTtcbiAgICAgICAgdGhpcy5fb3V0Ym91bmQuY29tcGxldGUoKTtcbiAgICAgICAgdGhpcy5fc3RhdGVDaGFuZ2VzLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgbWFya0Nvbm5lY3RlZCgpOiB2b2lkIHsgdGhpcy5fc2V0U3RhdGUoXCJjb25uZWN0ZWRcIik7IHRoaXMuX2ZsdXNoQnVmZmVyKCk7IH1cbiAgICBtYXJrRGlzY29ubmVjdGVkKCk6IHZvaWQgeyB0aGlzLl9zZXRTdGF0ZShcImRpc2Nvbm5lY3RlZFwiKTsgfVxuXG4gICAgLy8gU3RhdGUgbWFuYWdlbWVudFxuICAgIHByaXZhdGUgX3NldFN0YXRlKHN0YXRlOiBDaGFubmVsU3RhdGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX3N0YXRlICE9PSBzdGF0ZSkgeyB0aGlzLl9zdGF0ZSA9IHN0YXRlOyB0aGlzLl9zdGF0ZUNoYW5nZXMubmV4dChzdGF0ZSk7IH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9mbHVzaEJ1ZmZlcigpOiB2b2lkIHtcbiAgICAgICAgZm9yIChjb25zdCBtc2cgb2YgdGhpcy5fYnVmZmVyKSB0aGlzLl9vdXRib3VuZC5uZXh0KG1zZyk7XG4gICAgICAgIHRoaXMuX2J1ZmZlciA9IFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3NldHVwU3Vic2NyaXB0aW9ucygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fc3Vicy5wdXNoKHRoaXMuX2luYm91bmQuc3Vic2NyaWJlKHtcbiAgICAgICAgICAgIG5leHQ6IChtc2cpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobXNnLnR5cGUgPT09IFwic2lnbmFsXCIgJiYgbXNnLnBheWxvYWQ/LnR5cGUgPT09IFwiY29ubmVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3RlZFBlZXJzLnNldChtc2cuc2VuZGVyLCB7IG5hbWU6IG1zZy5zZW5kZXIsIHN0YXRlOiBcImNvbm5lY3RlZFwiLCBpc0hvc3Q6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8vIEdldHRlcnNcbiAgICBnZXQgaWQoKTogc3RyaW5nIHsgcmV0dXJuIHRoaXMuX2lkOyB9XG4gICAgZ2V0IG5hbWUoKTogc3RyaW5nIHsgcmV0dXJuIHRoaXMuX25hbWU7IH1cbiAgICBnZXQgc3RhdGUoKTogQ2hhbm5lbFN0YXRlIHsgcmV0dXJuIHRoaXMuX3N0YXRlOyB9XG4gICAgZ2V0IHRyYW5zcG9ydFR5cGUoKTogVHJhbnNwb3J0VHlwZSB7IHJldHVybiB0aGlzLl90cmFuc3BvcnRUeXBlOyB9XG4gICAgZ2V0IHN0YXRzKCk6IENvbm5lY3Rpb25TdGF0cyB7IHJldHVybiB7IC4uLnRoaXMuX3N0YXRzLCB1cHRpbWU6IHRoaXMuX3N0YXJ0VGltZSA/IERhdGUubm93KCkgLSB0aGlzLl9zdGFydFRpbWUgOiAwIH07IH1cbiAgICBnZXQgc3RhdGVDaGFuZ2VzKCkgeyByZXR1cm4gdGhpcy5fc3RhdGVDaGFuZ2VzOyB9XG4gICAgZ2V0IGNvbm5lY3RlZFBlZXJzKCk6IHN0cmluZ1tdIHsgcmV0dXJuIFsuLi50aGlzLl9jb25uZWN0ZWRQZWVycy5rZXlzKCldOyB9XG4gICAgZ2V0IG1ldGEoKTogQ2hhbm5lbE1ldGEgeyByZXR1cm4geyBpZDogdGhpcy5faWQsIG5hbWU6IHRoaXMuX25hbWUsIHN0YXRlOiB0aGlzLl9zdGF0ZSwgaXNIb3N0OiBmYWxzZSwgY29ubmVjdGVkQ2hhbm5lbHM6IG5ldyBTZXQodGhpcy5fY29ubmVjdGVkUGVlcnMua2V5cygpKSB9OyB9XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIENPTk5FQ1RJT04gUE9PTFxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvblBvb2wge1xuICAgIHByaXZhdGUgX2Nvbm5lY3Rpb25zID0gbmV3IE1hcDxzdHJpbmcsIENoYW5uZWxDb25uZWN0aW9uPigpO1xuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogQ29ubmVjdGlvblBvb2wgfCBudWxsID0gbnVsbDtcblxuICAgIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBDb25uZWN0aW9uUG9vbCB7XG4gICAgICAgIGlmICghQ29ubmVjdGlvblBvb2wuX2luc3RhbmNlKSBDb25uZWN0aW9uUG9vbC5faW5zdGFuY2UgPSBuZXcgQ29ubmVjdGlvblBvb2woKTtcbiAgICAgICAgcmV0dXJuIENvbm5lY3Rpb25Qb29sLl9pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBnZXRPckNyZWF0ZShuYW1lOiBzdHJpbmcsIHRyYW5zcG9ydFR5cGU6IFRyYW5zcG9ydFR5cGUgPSBcImludGVybmFsXCIsIG9wdGlvbnM6IENvbm5lY3Rpb25PcHRpb25zID0ge30pOiBDaGFubmVsQ29ubmVjdGlvbiB7XG4gICAgICAgIGlmICghdGhpcy5fY29ubmVjdGlvbnMuaGFzKG5hbWUpKSB7XG4gICAgICAgICAgICB0aGlzLl9jb25uZWN0aW9ucy5zZXQobmFtZSwgbmV3IENoYW5uZWxDb25uZWN0aW9uKG5hbWUsIHRyYW5zcG9ydFR5cGUsIG9wdGlvbnMpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbnMuZ2V0KG5hbWUpITtcbiAgICB9XG5cbiAgICBnZXQobmFtZTogc3RyaW5nKTogQ2hhbm5lbENvbm5lY3Rpb24gfCB1bmRlZmluZWQgeyByZXR1cm4gdGhpcy5fY29ubmVjdGlvbnMuZ2V0KG5hbWUpOyB9XG4gICAgaGFzKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4geyByZXR1cm4gdGhpcy5fY29ubmVjdGlvbnMuaGFzKG5hbWUpOyB9XG4gICAgZGVsZXRlKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4geyB0aGlzLl9jb25uZWN0aW9ucy5nZXQobmFtZSk/LmNsb3NlKCk7IHJldHVybiB0aGlzLl9jb25uZWN0aW9ucy5kZWxldGUobmFtZSk7IH1cbiAgICBjbGVhcigpOiB2b2lkIHsgdGhpcy5fY29ubmVjdGlvbnMuZm9yRWFjaCgoYykgPT4gYy5jbG9zZSgpKTsgdGhpcy5fY29ubmVjdGlvbnMuY2xlYXIoKTsgfVxuICAgIGdldCBzaXplKCk6IG51bWJlciB7IHJldHVybiB0aGlzLl9jb25uZWN0aW9ucy5zaXplOyB9XG4gICAgZ2V0IG5hbWVzKCk6IHN0cmluZ1tdIHsgcmV0dXJuIFsuLi50aGlzLl9jb25uZWN0aW9ucy5rZXlzKCldOyB9XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEZBQ1RPUlkgRlVOQ1RJT05TXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjb25zdCBnZXRDb25uZWN0aW9uUG9vbCA9ICgpOiBDb25uZWN0aW9uUG9vbCA9PiBDb25uZWN0aW9uUG9vbC5nZXRJbnN0YW5jZSgpO1xuZXhwb3J0IGNvbnN0IGdldENvbm5lY3Rpb24gPSAobmFtZTogc3RyaW5nLCB0cmFuc3BvcnRUeXBlPzogVHJhbnNwb3J0VHlwZSwgb3B0aW9ucz86IENvbm5lY3Rpb25PcHRpb25zKTogQ2hhbm5lbENvbm5lY3Rpb24gPT5cbiAgICBnZXRDb25uZWN0aW9uUG9vbCgpLmdldE9yQ3JlYXRlKG5hbWUsIHRyYW5zcG9ydFR5cGUsIG9wdGlvbnMpO1xuZXhwb3J0IGNvbnN0IGdldEhvc3RDb25uZWN0aW9uID0gKG5hbWU6IHN0cmluZyA9IFwiJGhvc3QkXCIsIG9wdGlvbnM/OiBDb25uZWN0aW9uT3B0aW9ucyk6IENoYW5uZWxDb25uZWN0aW9uID0+XG4gICAgZ2V0Q29ubmVjdGlvbihuYW1lLCBcImludGVybmFsXCIsIHsgLi4ub3B0aW9ucywgbWV0YWRhdGE6IHsgLi4ub3B0aW9ucz8ubWV0YWRhdGEsIGlzSG9zdDogdHJ1ZSB9IH0pO1xuIl19