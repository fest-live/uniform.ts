/**
 * Channel Handler - Legacy Re-exports
 *
 * @deprecated Use UnifiedChannel instead.
 * This file is kept for backward compatibility.
 */
import { WReflectAction } from "../types/Interface";
import { createUnifiedChannel, getWorkerChannel } from "./UnifiedChannel";
import { handleRequest } from "../../core/RequestHandler";
// ============================================================================
// LEGACY GLOBALS (for backward compatibility)
// ============================================================================
export const RemoteChannels = new Map();
export const SELF_CHANNEL = {
    name: "unknown",
    instance: null
};
export const CHANNEL_MAP = new Map();
// ============================================================================
// HELPERS
// ============================================================================
const isReflectAction = (action) => [...Object.values(WReflectAction)].includes(action);
export const loadWorker = (WX) => {
    if (WX instanceof Worker)
        return WX;
    if (WX instanceof URL)
        return new Worker(WX.href, { type: "module" });
    if (typeof WX === "function") {
        try {
            return new WX({ type: "module" });
        }
        catch {
            return WX({ type: "module" });
        }
    }
    if (typeof WX === "string") {
        if (WX.startsWith("/"))
            return new Worker(new URL(WX.replace(/^\//, "./"), import.meta.url).href, { type: "module" });
        if (URL.canParse(WX) || WX.startsWith("./"))
            return new Worker(new URL(WX, import.meta.url).href, { type: "module" });
        return new Worker(URL.createObjectURL(new Blob([WX], { type: "application/javascript" })), { type: "module" });
    }
    if (WX instanceof Blob || WX instanceof File)
        return new Worker(URL.createObjectURL(WX), { type: "module" });
    return WX ?? (typeof self !== "undefined" ? self : null);
};
// ============================================================================
// REMOTE CHANNEL HELPER (Legacy wrapper)
// ============================================================================
/** @deprecated Use UnifiedChannel.remote() instead */
export class RemoteChannelHelper {
    channelName;
    options;
    _channel;
    constructor(channelName, options = {}) {
        this.channelName = channelName;
        this.options = options;
        this._channel = getWorkerChannel();
    }
    request(path, action, args, options = {}) {
        if (typeof path === "string")
            path = [path];
        if (Array.isArray(action) && isReflectAction(path)) {
            options = args;
            args = action;
            action = path;
            path = [];
        }
        return this._channel.invoke(this.channelName, action, path, args);
    }
    doImportModule(url, options) {
        return this._channel.import(url, this.channelName);
    }
}
// ============================================================================
// CHANNEL HANDLER (Legacy wrapper)
// ============================================================================
/** @deprecated Use UnifiedChannel instead */
export class ChannelHandler {
    channel;
    options;
    _unified;
    broadcasts = {};
    constructor(channel, options = {}) {
        this.channel = channel;
        this.options = options;
        this._unified = createUnifiedChannel({ name: channel, autoListen: false });
        SELF_CHANNEL.name = channel;
        SELF_CHANNEL.instance = this;
    }
    createRemoteChannel(channel, options = {}, broadcast) {
        if (broadcast) {
            this._unified.attach(broadcast, { targetChannel: channel });
            this.broadcasts[channel] = broadcast;
        }
        return Promise.resolve(new RemoteChannelHelper(channel, options));
    }
    getChannel() { return this.channel; }
    request(path, action, args, options = {}, toChannel = "worker") {
        if (typeof path === "string")
            path = [path];
        if (Array.isArray(action) && isReflectAction(path)) {
            toChannel = options;
            options = args;
            args = action;
            action = path;
            path = [];
        }
        return this._unified.invoke(toChannel, action, path, args);
    }
    resolveResponse(reqId, result) { return Promise.resolve(result); }
    async handleAndResponse(request, reqId, responseFn) {
        const result = await handleRequest(request, reqId, this.channel);
        if (!result)
            return;
        responseFn?.(result.response, result.transfer);
    }
    close() { this._unified.close(); }
}
// ============================================================================
// FACTORY FUNCTIONS (Legacy)
// ============================================================================
/** @deprecated Use createUnifiedChannel instead */
export const initChannelHandler = (channel = "$host$") => {
    if (SELF_CHANNEL?.instance && channel === "$host$")
        return SELF_CHANNEL.instance;
    if (CHANNEL_MAP.has(channel))
        return CHANNEL_MAP.get(channel) ?? null;
    const $channel = new ChannelHandler(channel);
    if (channel === "$host$") {
        SELF_CHANNEL.name = channel;
        SELF_CHANNEL.instance = $channel;
    }
    CHANNEL_MAP.set(channel, $channel);
    return $channel;
};
/** @deprecated Use createUnifiedChannel instead */
export const createHostChannel = (channel = "$host$") => initChannelHandler(channel);
/** @deprecated Use UnifiedChannel.attach() instead */
export const createOrUseExistingChannel = (channel, options = {}, broadcast = (typeof self !== "undefined" ? self : null)) => {
    const $host = createHostChannel(channel ?? "$host$");
    return $host?.createRemoteChannel?.(channel, options, broadcast) ?? $host;
};
/** @deprecated Internal use */
export const $createOrUseExistingChannel = (channel, options = {}, broadcast) => {
    if (channel == null || broadcast)
        return;
    if (RemoteChannels.has(channel))
        return RemoteChannels.get(channel);
    const result = { channel, instance: SELF_CHANNEL.instance, remote: Promise.resolve(new RemoteChannelHelper(channel, options)) };
    RemoteChannels.set(channel, result);
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhbm5lbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDaGFubmVscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUdILE9BQU8sRUFBRSxjQUFjLEVBQXNDLE1BQU0sb0JBQW9CLENBQUM7QUFDeEYsT0FBTyxFQUFrQixvQkFBb0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUUxRCwrRUFBK0U7QUFDL0UsOENBQThDO0FBQzlDLCtFQUErRTtBQUUvRSxNQUFNLENBQUMsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztBQUVyRCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUc7SUFDeEIsSUFBSSxFQUFFLFNBQVM7SUFDZixRQUFRLEVBQUUsSUFBNkI7Q0FDMUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBaUMsQ0FBQztBQUVwRSwrRUFBK0U7QUFDL0UsVUFBVTtBQUNWLCtFQUErRTtBQUUvRSxNQUFNLGVBQWUsR0FBRyxDQUFDLE1BQVcsRUFBNEIsRUFBRSxDQUM5RCxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV4RCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxFQUFPLEVBQWlCLEVBQUU7SUFDakQsSUFBSSxFQUFFLFlBQVksTUFBTTtRQUFFLE9BQU8sRUFBRSxDQUFDO0lBQ3BDLElBQUksRUFBRSxZQUFZLEdBQUc7UUFBRSxPQUFPLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUN0RSxJQUFJLE9BQU8sRUFBRSxLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FB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UztRQUFFLE9BQU87SUFDekMsSUFBSSxjQUFjLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUFFLE9BQU8sY0FBYyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwRSxNQUFNLE1BQU0sR0FBRyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsWUFBWSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDaEksY0FBYyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDcEMsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDaGFubmVsIEhhbmRsZXIgLSBMZWdhY3kgUmUtZXhwb3J0c1xuICpcbiAqIEBkZXByZWNhdGVkIFVzZSBVbmlmaWVkQ2hhbm5lbCBpbnN0ZWFkLlxuICogVGhpcyBmaWxlIGlzIGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuXG4gKi9cblxuaW1wb3J0IHsgVVVJRHY0LCBQcm9taXNlZCB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7IFdSZWZsZWN0QWN0aW9uLCB0eXBlIFdSZWZsZWN0RGVzY3JpcHRvciwgdHlwZSBXUmVxIH0gZnJvbSBcIi4uL3R5cGVzL0ludGVyZmFjZVwiO1xuaW1wb3J0IHsgVW5pZmllZENoYW5uZWwsIGNyZWF0ZVVuaWZpZWRDaGFubmVsLCBnZXRXb3JrZXJDaGFubmVsIH0gZnJvbSBcIi4vVW5pZmllZENoYW5uZWxcIjtcbmltcG9ydCB7IGhhbmRsZVJlcXVlc3QgfSBmcm9tIFwiLi4vLi4vY29yZS9SZXF1ZXN0SGFuZGxlclwiO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBMRUdBQ1kgR0xPQkFMUyAoZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjb25zdCBSZW1vdGVDaGFubmVscyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG5cbmV4cG9ydCBjb25zdCBTRUxGX0NIQU5ORUwgPSB7XG4gICAgbmFtZTogXCJ1bmtub3duXCIsXG4gICAgaW5zdGFuY2U6IG51bGwgYXMgQ2hhbm5lbEhhbmRsZXIgfCBudWxsXG59O1xuXG5leHBvcnQgY29uc3QgQ0hBTk5FTF9NQVAgPSBuZXcgTWFwPHN0cmluZywgQ2hhbm5lbEhhbmRsZXIgfCBudWxsPigpO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBIRUxQRVJTXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmNvbnN0IGlzUmVmbGVjdEFjdGlvbiA9IChhY3Rpb246IGFueSk6IGFjdGlvbiBpcyBXUmVmbGVjdEFjdGlvbiA9PlxuICAgIFsuLi5PYmplY3QudmFsdWVzKFdSZWZsZWN0QWN0aW9uKV0uaW5jbHVkZXMoYWN0aW9uKTtcblxuZXhwb3J0IGNvbnN0IGxvYWRXb3JrZXIgPSAoV1g6IGFueSk6IFdvcmtlciB8IG51bGwgPT4ge1xuICAgIGlmIChXWCBpbnN0YW5jZW9mIFdvcmtlcikgcmV0dXJuIFdYO1xuICAgIGlmIChXWCBpbnN0YW5jZW9mIFVSTCkgcmV0dXJuIG5ldyBXb3JrZXIoV1guaHJlZiwgeyB0eXBlOiBcIm1vZHVsZVwiIH0pO1xuICAgIGlmICh0eXBlb2YgV1ggPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICB0cnkgeyByZXR1cm4gbmV3IFdYKHsgdHlwZTogXCJtb2R1bGVcIiB9KTsgfVxuICAgICAgICBjYXRjaCB7IHJldHVybiBXWCh7IHR5cGU6IFwibW9kdWxlXCIgfSk7IH1cbiAgICB9XG4gICAgaWYgKHR5cGVvZiBXWCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBpZiAoV1guc3RhcnRzV2l0aChcIi9cIikpIHJldHVybiBuZXcgV29ya2VyKG5ldyBVUkwoV1gucmVwbGFjZSgvXlxcLy8sIFwiLi9cIiksIGltcG9ydC5tZXRhLnVybCkuaHJlZiwgeyB0eXBlOiBcIm1vZHVsZVwiIH0pO1xuICAgICAgICBpZiAoVVJMLmNhblBhcnNlKFdYKSB8fCBXWC5zdGFydHNXaXRoKFwiLi9cIikpIHJldHVybiBuZXcgV29ya2VyKG5ldyBVUkwoV1gsIGltcG9ydC5tZXRhLnVybCkuaHJlZiwgeyB0eXBlOiBcIm1vZHVsZVwiIH0pO1xuICAgICAgICByZXR1cm4gbmV3IFdvcmtlcihVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFtXWF0sIHsgdHlwZTogXCJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0XCIgfSkpLCB7IHR5cGU6IFwibW9kdWxlXCIgfSk7XG4gICAgfVxuICAgIGlmIChXWCBpbnN0YW5jZW9mIEJsb2IgfHwgV1ggaW5zdGFuY2VvZiBGaWxlKSByZXR1cm4gbmV3IFdvcmtlcihVUkwuY3JlYXRlT2JqZWN0VVJMKFdYKSwgeyB0eXBlOiBcIm1vZHVsZVwiIH0pO1xuICAgIHJldHVybiBXWCA/PyAodHlwZW9mIHNlbGYgIT09IFwidW5kZWZpbmVkXCIgPyBzZWxmIDogbnVsbCkgYXMgdW5rbm93biBhcyBXb3JrZXI7XG59O1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBSRU1PVEUgQ0hBTk5FTCBIRUxQRVIgKExlZ2FjeSB3cmFwcGVyKVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKiogQGRlcHJlY2F0ZWQgVXNlIFVuaWZpZWRDaGFubmVsLnJlbW90ZSgpIGluc3RlYWQgKi9cbmV4cG9ydCBjbGFzcyBSZW1vdGVDaGFubmVsSGVscGVyIHtcbiAgICBwcml2YXRlIF9jaGFubmVsOiBVbmlmaWVkQ2hhbm5lbDtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2hhbm5lbE5hbWU6IHN0cmluZywgcHJpdmF0ZSBvcHRpb25zOiBhbnkgPSB7fSkge1xuICAgICAgICB0aGlzLl9jaGFubmVsID0gZ2V0V29ya2VyQ2hhbm5lbCgpO1xuICAgIH1cblxuICAgIHJlcXVlc3QocGF0aDogc3RyaW5nW10gfCBXUmVmbGVjdERlc2NyaXB0b3IsIGFjdGlvbjogV1JlZmxlY3RBY3Rpb24gfCBhbnlbXSwgYXJnczogYW55W10gfCBhbnksIG9wdGlvbnM6IGFueSA9IHt9KTogUHJvbWlzZTxhbnk+IHwgbnVsbCB7XG4gICAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gXCJzdHJpbmdcIikgcGF0aCA9IFtwYXRoXTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYWN0aW9uKSAmJiBpc1JlZmxlY3RBY3Rpb24ocGF0aCkpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBhcmdzOyBhcmdzID0gYWN0aW9uO1xuICAgICAgICAgICAgYWN0aW9uID0gcGF0aCBhcyB1bmtub3duIGFzIFdSZWZsZWN0QWN0aW9uOyBwYXRoID0gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NoYW5uZWwuaW52b2tlKHRoaXMuY2hhbm5lbE5hbWUsIGFjdGlvbiBhcyBXUmVmbGVjdEFjdGlvbiwgcGF0aCBhcyBzdHJpbmdbXSwgYXJncyk7XG4gICAgfVxuXG4gICAgZG9JbXBvcnRNb2R1bGUodXJsOiBzdHJpbmcsIG9wdGlvbnM6IGFueSk6IFByb21pc2U8YW55PiB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5fY2hhbm5lbC5pbXBvcnQodXJsLCB0aGlzLmNoYW5uZWxOYW1lKTtcbiAgICB9XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIENIQU5ORUwgSEFORExFUiAoTGVnYWN5IHdyYXBwZXIpXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbi8qKiBAZGVwcmVjYXRlZCBVc2UgVW5pZmllZENoYW5uZWwgaW5zdGVhZCAqL1xuZXhwb3J0IGNsYXNzIENoYW5uZWxIYW5kbGVyIHtcbiAgICBwcml2YXRlIF91bmlmaWVkOiBVbmlmaWVkQ2hhbm5lbDtcbiAgICBwcml2YXRlIGJyb2FkY2FzdHM6IFJlY29yZDxzdHJpbmcsIFdvcmtlciB8IEJyb2FkY2FzdENoYW5uZWwgfCBNZXNzYWdlUG9ydD4gPSB7fTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2hhbm5lbDogc3RyaW5nLCBwcml2YXRlIG9wdGlvbnM6IGFueSA9IHt9KSB7XG4gICAgICAgIHRoaXMuX3VuaWZpZWQgPSBjcmVhdGVVbmlmaWVkQ2hhbm5lbCh7IG5hbWU6IGNoYW5uZWwsIGF1dG9MaXN0ZW46IGZhbHNlIH0pO1xuICAgICAgICBTRUxGX0NIQU5ORUwubmFtZSA9IGNoYW5uZWw7XG4gICAgICAgIFNFTEZfQ0hBTk5FTC5pbnN0YW5jZSA9IHRoaXM7XG4gICAgfVxuXG4gICAgY3JlYXRlUmVtb3RlQ2hhbm5lbChjaGFubmVsOiBzdHJpbmcsIG9wdGlvbnM6IGFueSA9IHt9LCBicm9hZGNhc3Q/OiBXb3JrZXIgfCBCcm9hZGNhc3RDaGFubmVsIHwgTWVzc2FnZVBvcnQgfCBudWxsKSB7XG4gICAgICAgIGlmIChicm9hZGNhc3QpIHtcbiAgICAgICAgICAgIHRoaXMuX3VuaWZpZWQuYXR0YWNoKGJyb2FkY2FzdCwgeyB0YXJnZXRDaGFubmVsOiBjaGFubmVsIH0pO1xuICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RzW2NoYW5uZWxdID0gYnJvYWRjYXN0O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IFJlbW90ZUNoYW5uZWxIZWxwZXIoY2hhbm5lbCwgb3B0aW9ucykpO1xuICAgIH1cblxuICAgIGdldENoYW5uZWwoKTogc3RyaW5nIHsgcmV0dXJuIHRoaXMuY2hhbm5lbDsgfVxuXG4gICAgcmVxdWVzdChwYXRoOiBzdHJpbmdbXSB8IFdSZWZsZWN0QWN0aW9uLCBhY3Rpb246IFdSZWZsZWN0QWN0aW9uIHwgYW55W10sIGFyZ3M6IGFueVtdIHwgYW55LCBvcHRpb25zOiBhbnkgfCBzdHJpbmcgPSB7fSwgdG9DaGFubmVsOiBzdHJpbmcgPSBcIndvcmtlclwiKTogUHJvbWlzZTxhbnk+IHwgbnVsbCB7XG4gICAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gXCJzdHJpbmdcIikgcGF0aCA9IFtwYXRoXTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYWN0aW9uKSAmJiBpc1JlZmxlY3RBY3Rpb24ocGF0aCkpIHtcbiAgICAgICAgICAgIHRvQ2hhbm5lbCA9IG9wdGlvbnMgYXMgc3RyaW5nOyBvcHRpb25zID0gYXJncztcbiAgICAgICAgICAgIGFyZ3MgPSBhY3Rpb247IGFjdGlvbiA9IHBhdGggYXMgdW5rbm93biBhcyBXUmVmbGVjdEFjdGlvbjsgcGF0aCA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl91bmlmaWVkLmludm9rZSh0b0NoYW5uZWwsIGFjdGlvbiBhcyBXUmVmbGVjdEFjdGlvbiwgcGF0aCBhcyBzdHJpbmdbXSwgYXJncyk7XG4gICAgfVxuXG4gICAgcmVzb2x2ZVJlc3BvbnNlKHJlcUlkOiBzdHJpbmcsIHJlc3VsdDogYW55KSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTsgfVxuXG4gICAgYXN5bmMgaGFuZGxlQW5kUmVzcG9uc2UocmVxdWVzdDogV1JlcSwgcmVxSWQ6IHN0cmluZywgcmVzcG9uc2VGbj86IChyZXN1bHQ6IGFueSwgdHJhbnNmZXI6IGFueVtdKSA9PiB2b2lkKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZVJlcXVlc3QocmVxdWVzdCwgcmVxSWQsIHRoaXMuY2hhbm5lbCk7XG4gICAgICAgIGlmICghcmVzdWx0KSByZXR1cm47XG4gICAgICAgIHJlc3BvbnNlRm4/LihyZXN1bHQucmVzcG9uc2UsIHJlc3VsdC50cmFuc2Zlcik7XG4gICAgfVxuXG4gICAgY2xvc2UoKTogdm9pZCB7IHRoaXMuX3VuaWZpZWQuY2xvc2UoKTsgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBGQUNUT1JZIEZVTkNUSU9OUyAoTGVnYWN5KVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKiogQGRlcHJlY2F0ZWQgVXNlIGNyZWF0ZVVuaWZpZWRDaGFubmVsIGluc3RlYWQgKi9cbmV4cG9ydCBjb25zdCBpbml0Q2hhbm5lbEhhbmRsZXIgPSAoY2hhbm5lbDogc3RyaW5nID0gXCIkaG9zdCRcIik6IENoYW5uZWxIYW5kbGVyIHwgbnVsbCA9PiB7XG4gICAgaWYgKFNFTEZfQ0hBTk5FTD8uaW5zdGFuY2UgJiYgY2hhbm5lbCA9PT0gXCIkaG9zdCRcIikgcmV0dXJuIFNFTEZfQ0hBTk5FTC5pbnN0YW5jZTtcbiAgICBpZiAoQ0hBTk5FTF9NQVAuaGFzKGNoYW5uZWwpKSByZXR1cm4gQ0hBTk5FTF9NQVAuZ2V0KGNoYW5uZWwpID8/IG51bGw7XG4gICAgY29uc3QgJGNoYW5uZWwgPSBuZXcgQ2hhbm5lbEhhbmRsZXIoY2hhbm5lbCk7XG4gICAgaWYgKGNoYW5uZWwgPT09IFwiJGhvc3QkXCIpIHsgU0VMRl9DSEFOTkVMLm5hbWUgPSBjaGFubmVsOyBTRUxGX0NIQU5ORUwuaW5zdGFuY2UgPSAkY2hhbm5lbDsgfVxuICAgIENIQU5ORUxfTUFQLnNldChjaGFubmVsLCAkY2hhbm5lbCk7XG4gICAgcmV0dXJuICRjaGFubmVsO1xufTtcblxuLyoqIEBkZXByZWNhdGVkIFVzZSBjcmVhdGVVbmlmaWVkQ2hhbm5lbCBpbnN0ZWFkICovXG5leHBvcnQgY29uc3QgY3JlYXRlSG9zdENoYW5uZWwgPSAoY2hhbm5lbDogc3RyaW5nID0gXCIkaG9zdCRcIikgPT4gaW5pdENoYW5uZWxIYW5kbGVyKGNoYW5uZWwpO1xuXG4vKiogQGRlcHJlY2F0ZWQgVXNlIFVuaWZpZWRDaGFubmVsLmF0dGFjaCgpIGluc3RlYWQgKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVPclVzZUV4aXN0aW5nQ2hhbm5lbCA9IChcbiAgICBjaGFubmVsOiBzdHJpbmcsXG4gICAgb3B0aW9uczogYW55ID0ge30sXG4gICAgYnJvYWRjYXN0OiBXb3JrZXIgfCBCcm9hZGNhc3RDaGFubmVsIHwgTWVzc2FnZVBvcnQgfCBudWxsID0gKHR5cGVvZiBzZWxmICE9PSBcInVuZGVmaW5lZFwiID8gc2VsZiA6IG51bGwpIGFzIGFueVxuKSA9PiB7XG4gICAgY29uc3QgJGhvc3QgPSBjcmVhdGVIb3N0Q2hhbm5lbChjaGFubmVsID8/IFwiJGhvc3QkXCIpO1xuICAgIHJldHVybiAkaG9zdD8uY3JlYXRlUmVtb3RlQ2hhbm5lbD8uKGNoYW5uZWwsIG9wdGlvbnMsIGJyb2FkY2FzdCkgPz8gJGhvc3Q7XG59O1xuXG4vKiogQGRlcHJlY2F0ZWQgSW50ZXJuYWwgdXNlICovXG5leHBvcnQgY29uc3QgJGNyZWF0ZU9yVXNlRXhpc3RpbmdDaGFubmVsID0gKGNoYW5uZWw6IHN0cmluZywgb3B0aW9uczogYW55ID0ge30sIGJyb2FkY2FzdD86IFdvcmtlciB8IEJyb2FkY2FzdENoYW5uZWwgfCBNZXNzYWdlUG9ydCB8IG51bGwpID0+IHtcbiAgICBpZiAoY2hhbm5lbCA9PSBudWxsIHx8IGJyb2FkY2FzdCkgcmV0dXJuO1xuICAgIGlmIChSZW1vdGVDaGFubmVscy5oYXMoY2hhbm5lbCkpIHJldHVybiBSZW1vdGVDaGFubmVscy5nZXQoY2hhbm5lbCk7XG4gICAgY29uc3QgcmVzdWx0ID0geyBjaGFubmVsLCBpbnN0YW5jZTogU0VMRl9DSEFOTkVMLmluc3RhbmNlLCByZW1vdGU6IFByb21pc2UucmVzb2x2ZShuZXcgUmVtb3RlQ2hhbm5lbEhlbHBlcihjaGFubmVsLCBvcHRpb25zKSkgfTtcbiAgICBSZW1vdGVDaGFubmVscy5zZXQoY2hhbm5lbCwgcmVzdWx0KTtcbiAgICByZXR1cm4gcmVzdWx0O1xufTtcbiJdfQ==