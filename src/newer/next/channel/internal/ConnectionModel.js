function createConnectionKey(params) {
    return [
        params.localChannel,
        params.remoteChannel,
        params.sender,
        params.transportType,
        params.direction
    ].join("::");
}
export function queryConnections(connections, query = {}) {
    const includeClosed = query.includeClosed ?? false;
    const desiredStatus = query.status ?? (includeClosed ? undefined : "active");
    return [...connections]
        .filter((connection) => {
        if (desiredStatus && connection.status !== desiredStatus)
            return false;
        if (query.channel && connection.localChannel !== query.channel && connection.remoteChannel !== query.channel)
            return false;
        if (query.localChannel && connection.localChannel !== query.localChannel)
            return false;
        if (query.remoteChannel && connection.remoteChannel !== query.remoteChannel)
            return false;
        if (query.sender && connection.sender !== query.sender)
            return false;
        if (query.transportType && connection.transportType !== query.transportType)
            return false;
        if (query.direction && connection.direction !== query.direction)
            return false;
        return true;
    })
        .sort((a, b) => b.updatedAt - a.updatedAt);
}
export class ConnectionRegistry {
    _createId;
    _emitEvent;
    _connections = new Map();
    constructor(_createId, _emitEvent) {
        this._createId = _createId;
        this._emitEvent = _emitEvent;
    }
    register(params) {
        const key = createConnectionKey(params);
        const now = Date.now();
        const existing = this._connections.get(key);
        if (existing) {
            existing.updatedAt = now;
            existing.status = "active";
            existing.metadata = { ...existing.metadata, ...params.metadata };
            return existing;
        }
        const connection = {
            id: this._createId(),
            localChannel: params.localChannel,
            remoteChannel: params.remoteChannel,
            sender: params.sender,
            transportType: params.transportType,
            direction: params.direction,
            status: "active",
            createdAt: now,
            updatedAt: now,
            metadata: params.metadata
        };
        this._connections.set(key, connection);
        this._emitEvent?.({
            type: "connected",
            connection,
            timestamp: now
        });
        return connection;
    }
    markNotified(connection, payload) {
        const now = Date.now();
        connection.lastNotifyAt = now;
        connection.updatedAt = now;
        this._emitEvent?.({
            type: "notified",
            connection,
            timestamp: now,
            payload
        });
    }
    closeByChannel(channel) {
        const now = Date.now();
        for (const connection of this._connections.values()) {
            if (connection.localChannel !== channel && connection.remoteChannel !== channel)
                continue;
            if (connection.status === "closed")
                continue;
            connection.status = "closed";
            connection.updatedAt = now;
            this._emitEvent?.({
                type: "disconnected",
                connection,
                timestamp: now
            });
        }
    }
    closeAll() {
        const now = Date.now();
        for (const connection of this._connections.values()) {
            if (connection.status === "closed")
                continue;
            connection.status = "closed";
            connection.updatedAt = now;
            this._emitEvent?.({
                type: "disconnected",
                connection,
                timestamp: now
            });
        }
    }
    query(query = {}) {
        return queryConnections(this._connections.values(), query);
    }
    values() {
        return [...this._connections.values()];
    }
    clear() {
        this._connections.clear();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbk1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ29ubmVjdGlvbk1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQTRDQSxTQUFTLG1CQUFtQixDQUN4QixNQUE0QztJQUU1QyxPQUFPO1FBQ0gsTUFBTSxDQUFDLFlBQVk7UUFDbkIsTUFBTSxDQUFDLGFBQWE7UUFDcEIsTUFBTSxDQUFDLE1BQU07UUFDYixNQUFNLENBQUMsYUFBYTtRQUNwQixNQUFNLENBQUMsU0FBUztLQUNuQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNqQixDQUFDO0FBRUQsTUFBTSxVQUFVLGdCQUFnQixDQUM1QixXQUFpRCxFQUNqRCxRQUE2QyxFQUFFO0lBRS9DLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDO0lBQ25ELE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFN0UsT0FBTyxDQUFDLEdBQUcsV0FBVyxDQUFDO1NBQ2xCLE1BQU0sQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO1FBQ25CLElBQUksYUFBYSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssYUFBYTtZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQ3ZFLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxVQUFVLENBQUMsWUFBWSxLQUFLLEtBQUssQ0FBQyxPQUFPLElBQUksVUFBVSxDQUFDLGFBQWEsS0FBSyxLQUFLLENBQUMsT0FBTztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQzNILElBQUksS0FBSyxDQUFDLFlBQVksSUFBSSxVQUFVLENBQUMsWUFBWSxLQUFLLEtBQUssQ0FBQyxZQUFZO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFDdkYsSUFBSSxLQUFLLENBQUMsYUFBYSxJQUFJLFVBQVUsQ0FBQyxhQUFhLEtB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LE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsS0FBSztRQUNELElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDOUIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IHR5cGUgQ29ubmVjdGlvbkRpcmVjdGlvbiA9IFwiaW5jb21pbmdcIiB8IFwib3V0Z29pbmdcIjtcbmV4cG9ydCB0eXBlIENvbm5lY3Rpb25TdGF0dXMgPSBcImFjdGl2ZVwiIHwgXCJjbG9zZWRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uSW5mbzxUVHJhbnNwb3J0IGV4dGVuZHMgc3RyaW5nID0gc3RyaW5nPiB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBsb2NhbENoYW5uZWw6IHN0cmluZztcbiAgICByZW1vdGVDaGFubmVsOiBzdHJpbmc7XG4gICAgc2VuZGVyOiBzdHJpbmc7XG4gICAgdHJhbnNwb3J0VHlwZTogVFRyYW5zcG9ydDtcbiAgICBkaXJlY3Rpb246IENvbm5lY3Rpb25EaXJlY3Rpb247XG4gICAgc3RhdHVzOiBDb25uZWN0aW9uU3RhdHVzO1xuICAgIGNyZWF0ZWRBdDogbnVtYmVyO1xuICAgIHVwZGF0ZWRBdDogbnVtYmVyO1xuICAgIGxhc3ROb3RpZnlBdD86IG51bWJlcjtcbiAgICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvbkV2ZW50PFRUcmFuc3BvcnQgZXh0ZW5kcyBzdHJpbmcgPSBzdHJpbmc+IHtcbiAgICB0eXBlOiBcImNvbm5lY3RlZFwiIHwgXCJub3RpZmllZFwiIHwgXCJkaXNjb25uZWN0ZWRcIjtcbiAgICBjb25uZWN0aW9uOiBDb25uZWN0aW9uSW5mbzxUVHJhbnNwb3J0PjtcbiAgICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgICBwYXlsb2FkPzogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5Q29ubmVjdGlvbnNPcHRpb25zPFRUcmFuc3BvcnQgZXh0ZW5kcyBzdHJpbmcgPSBzdHJpbmc+IHtcbiAgICBjaGFubmVsPzogc3RyaW5nO1xuICAgIGxvY2FsQ2hhbm5lbD86IHN0cmluZztcbiAgICByZW1vdGVDaGFubmVsPzogc3RyaW5nO1xuICAgIHNlbmRlcj86IHN0cmluZztcbiAgICB0cmFuc3BvcnRUeXBlPzogVFRyYW5zcG9ydDtcbiAgICBkaXJlY3Rpb24/OiBDb25uZWN0aW9uRGlyZWN0aW9uO1xuICAgIHN0YXR1cz86IENvbm5lY3Rpb25TdGF0dXM7XG4gICAgaW5jbHVkZUNsb3NlZD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVnaXN0ZXJDb25uZWN0aW9uUGFyYW1zPFRUcmFuc3BvcnQgZXh0ZW5kcyBzdHJpbmcgPSBzdHJpbmc+IHtcbiAgICBsb2NhbENoYW5uZWw6IHN0cmluZztcbiAgICByZW1vdGVDaGFubmVsOiBzdHJpbmc7XG4gICAgc2VuZGVyOiBzdHJpbmc7XG4gICAgdHJhbnNwb3J0VHlwZTogVFRyYW5zcG9ydDtcbiAgICBkaXJlY3Rpb246IENvbm5lY3Rpb25EaXJlY3Rpb247XG4gICAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDb25uZWN0aW9uS2V5PFRUcmFuc3BvcnQgZXh0ZW5kcyBzdHJpbmcgPSBzdHJpbmc+KFxuICAgIHBhcmFtczogUmVnaXN0ZXJDb25uZWN0aW9uUGFyYW1zPFRUcmFuc3BvcnQ+XG4pOiBzdHJpbmcge1xuICAgIHJldHVybiBbXG4gICAgICAgIHBhcmFtcy5sb2NhbENoYW5uZWwsXG4gICAgICAgIHBhcmFtcy5yZW1vdGVDaGFubmVsLFxuICAgICAgICBwYXJhbXMuc2VuZGVyLFxuICAgICAgICBwYXJhbXMudHJhbnNwb3J0VHlwZSxcbiAgICAgICAgcGFyYW1zLmRpcmVjdGlvblxuICAgIF0uam9pbihcIjo6XCIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcXVlcnlDb25uZWN0aW9uczxUVHJhbnNwb3J0IGV4dGVuZHMgc3RyaW5nID0gc3RyaW5nPihcbiAgICBjb25uZWN0aW9uczogSXRlcmFibGU8Q29ubmVjdGlvbkluZm88VFRyYW5zcG9ydD4+LFxuICAgIHF1ZXJ5OiBRdWVyeUNvbm5lY3Rpb25zT3B0aW9uczxUVHJhbnNwb3J0PiA9IHt9XG4pOiBDb25uZWN0aW9uSW5mbzxUVHJhbnNwb3J0PltdIHtcbiAgICBjb25zdCBpbmNsdWRlQ2xvc2VkID0gcXVlcnkuaW5jbHVkZUNsb3NlZCA/PyBmYWxzZTtcbiAgICBjb25zdCBkZXNpcmVkU3RhdHVzID0gcXVlcnkuc3RhdHVzID8/IChpbmNsdWRlQ2xvc2VkID8gdW5kZWZpbmVkIDogXCJhY3RpdmVcIik7XG5cbiAgICByZXR1cm4gWy4uLmNvbm5lY3Rpb25zXVxuICAgICAgICAuZmlsdGVyKChjb25uZWN0aW9uKSA9PiB7XG4gICAgICAgICAgICBpZiAoZGVzaXJlZFN0YXR1cyAmJiBjb25uZWN0aW9uLnN0YXR1cyAhPT0gZGVzaXJlZFN0YXR1cykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKHF1ZXJ5LmNoYW5uZWwgJiYgY29ubmVjdGlvbi5sb2NhbENoYW5uZWwgIT09IHF1ZXJ5LmNoYW5uZWwgJiYgY29ubmVjdGlvbi5yZW1vdGVDaGFubmVsICE9PSBxdWVyeS5jaGFubmVsKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZiAocXVlcnkubG9jYWxDaGFubmVsICYmIGNvbm5lY3Rpb24ubG9jYWxDaGFubmVsICE9PSBxdWVyeS5sb2NhbENoYW5uZWwpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmIChxdWVyeS5yZW1vdGVDaGFubmVsICYmIGNvbm5lY3Rpb24ucmVtb3RlQ2hhbm5lbCAhPT0gcXVlcnkucmVtb3RlQ2hhbm5lbCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKHF1ZXJ5LnNlbmRlciAmJiBjb25uZWN0aW9uLnNlbmRlciAhPT0gcXVlcnkuc2VuZGVyKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZiAocXVlcnkudHJhbnNwb3J0VHlwZSAmJiBjb25uZWN0aW9uLnRyYW5zcG9ydFR5cGUgIT09IHF1ZXJ5LnRyYW5zcG9ydFR5cGUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmIChxdWVyeS5kaXJlY3Rpb24gJiYgY29ubmVjdGlvbi5kaXJlY3Rpb24gIT09IHF1ZXJ5LmRpcmVjdGlvbikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pXG4gICAgICAgIC5zb3J0KChhLCBiKSA9PiBiLnVwZGF0ZWRBdCAtIGEudXBkYXRlZEF0KTtcbn1cblxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb25SZWdpc3RyeTxUVHJhbnNwb3J0IGV4dGVuZHMgc3RyaW5nID0gc3RyaW5nPiB7XG4gICAgcHJpdmF0ZSBfY29ubmVjdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgQ29ubmVjdGlvbkluZm88VFRyYW5zcG9ydD4+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBfY3JlYXRlSWQ6ICgpID0+IHN0cmluZyxcbiAgICAgICAgcHJpdmF0ZSBfZW1pdEV2ZW50PzogKGV2ZW50OiBDb25uZWN0aW9uRXZlbnQ8VFRyYW5zcG9ydD4pID0+IHZvaWRcbiAgICApIHt9XG5cbiAgICByZWdpc3RlcihwYXJhbXM6IFJlZ2lzdGVyQ29ubmVjdGlvblBhcmFtczxUVHJhbnNwb3J0Pik6IENvbm5lY3Rpb25JbmZvPFRUcmFuc3BvcnQ+IHtcbiAgICAgICAgY29uc3Qga2V5ID0gY3JlYXRlQ29ubmVjdGlvbktleShwYXJhbXMpO1xuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuX2Nvbm5lY3Rpb25zLmdldChrZXkpO1xuXG4gICAgICAgIGlmIChleGlzdGluZykge1xuICAgICAgICAgICAgZXhpc3RpbmcudXBkYXRlZEF0ID0gbm93O1xuICAgICAgICAgICAgZXhpc3Rpbmcuc3RhdHVzID0gXCJhY3RpdmVcIjtcbiAgICAgICAgICAgIGV4aXN0aW5nLm1ldGFkYXRhID0geyAuLi5leGlzdGluZy5tZXRhZGF0YSwgLi4ucGFyYW1zLm1ldGFkYXRhIH07XG4gICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb25uZWN0aW9uOiBDb25uZWN0aW9uSW5mbzxUVHJhbnNwb3J0PiA9IHtcbiAgICAgICAgICAgIGlkOiB0aGlzLl9jcmVhdGVJZCgpLFxuICAgICAgICAgICAgbG9jYWxDaGFubmVsOiBwYXJhbXMubG9jYWxDaGFubmVsLFxuICAgICAgICAgICAgcmVtb3RlQ2hhbm5lbDogcGFyYW1zLnJlbW90ZUNoYW5uZWwsXG4gICAgICAgICAgICBzZW5kZXI6IHBhcmFtcy5zZW5kZXIsXG4gICAgICAgICAgICB0cmFuc3BvcnRUeXBlOiBwYXJhbXMudHJhbnNwb3J0VHlwZSxcbiAgICAgICAgICAgIGRpcmVjdGlvbjogcGFyYW1zLmRpcmVjdGlvbixcbiAgICAgICAgICAgIHN0YXR1czogXCJhY3RpdmVcIixcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgICAgICAgdXBkYXRlZEF0OiBub3csXG4gICAgICAgICAgICBtZXRhZGF0YTogcGFyYW1zLm1ldGFkYXRhXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbnMuc2V0KGtleSwgY29ubmVjdGlvbik7XG4gICAgICAgIHRoaXMuX2VtaXRFdmVudD8uKHtcbiAgICAgICAgICAgIHR5cGU6IFwiY29ubmVjdGVkXCIsXG4gICAgICAgICAgICBjb25uZWN0aW9uLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBub3dcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBjb25uZWN0aW9uO1xuICAgIH1cblxuICAgIG1hcmtOb3RpZmllZChjb25uZWN0aW9uOiBDb25uZWN0aW9uSW5mbzxUVHJhbnNwb3J0PiwgcGF5bG9hZD86IGFueSk6IHZvaWQge1xuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICBjb25uZWN0aW9uLmxhc3ROb3RpZnlBdCA9IG5vdztcbiAgICAgICAgY29ubmVjdGlvbi51cGRhdGVkQXQgPSBub3c7XG4gICAgICAgIHRoaXMuX2VtaXRFdmVudD8uKHtcbiAgICAgICAgICAgIHR5cGU6IFwibm90aWZpZWRcIixcbiAgICAgICAgICAgIGNvbm5lY3Rpb24sXG4gICAgICAgICAgICB0aW1lc3RhbXA6IG5vdyxcbiAgICAgICAgICAgIHBheWxvYWRcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY2xvc2VCeUNoYW5uZWwoY2hhbm5lbDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICAgIGZvciAoY29uc3QgY29ubmVjdGlvbiBvZiB0aGlzLl9jb25uZWN0aW9ucy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24ubG9jYWxDaGFubmVsICE9PSBjaGFubmVsICYmIGNvbm5lY3Rpb24ucmVtb3RlQ2hhbm5lbCAhPT0gY2hhbm5lbCkgY29udGludWU7XG4gICAgICAgICAgICBpZiAoY29ubmVjdGlvbi5zdGF0dXMgPT09IFwiY2xvc2VkXCIpIGNvbnRpbnVlO1xuICAgICAgICAgICAgY29ubmVjdGlvbi5zdGF0dXMgPSBcImNsb3NlZFwiO1xuICAgICAgICAgICAgY29ubmVjdGlvbi51cGRhdGVkQXQgPSBub3c7XG4gICAgICAgICAgICB0aGlzLl9lbWl0RXZlbnQ/Lih7XG4gICAgICAgICAgICAgICAgdHlwZTogXCJkaXNjb25uZWN0ZWRcIixcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbm93XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNsb3NlQWxsKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICBmb3IgKGNvbnN0IGNvbm5lY3Rpb24gb2YgdGhpcy5fY29ubmVjdGlvbnMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIGlmIChjb25uZWN0aW9uLnN0YXR1cyA9PT0gXCJjbG9zZWRcIikgY29udGludWU7XG4gICAgICAgICAgICBjb25uZWN0aW9uLnN0YXR1cyA9IFwiY2xvc2VkXCI7XG4gICAgICAgICAgICBjb25uZWN0aW9uLnVwZGF0ZWRBdCA9IG5vdztcbiAgICAgICAgICAgIHRoaXMuX2VtaXRFdmVudD8uKHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcImRpc2Nvbm5lY3RlZFwiLFxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24sXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBub3dcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcXVlcnkocXVlcnk6IFF1ZXJ5Q29ubmVjdGlvbnNPcHRpb25zPFRUcmFuc3BvcnQ+ID0ge30pOiBDb25uZWN0aW9uSW5mbzxUVHJhbnNwb3J0PltdIHtcbiAgICAgICAgcmV0dXJuIHF1ZXJ5Q29ubmVjdGlvbnModGhpcy5fY29ubmVjdGlvbnMudmFsdWVzKCksIHF1ZXJ5KTtcbiAgICB9XG5cbiAgICB2YWx1ZXMoKTogQ29ubmVjdGlvbkluZm88VFRyYW5zcG9ydD5bXSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5fY29ubmVjdGlvbnMudmFsdWVzKCldO1xuICAgIH1cblxuICAgIGNsZWFyKCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9jb25uZWN0aW9ucy5jbGVhcigpO1xuICAgIH1cbn1cbiJdfQ==