/**
 * SharedWorker Transport
 *
 * Enables shared worker communication across multiple tabs/windows.
 * SharedWorker provides a shared context that persists across all
 * connected browsing contexts.
 */
import { UUIDv4 } from "fest/core";
import { ChannelSubject } from "../observable/Observable";
// ============================================================================
// SHARED WORKER CLIENT (Page/Tab Side)
// ============================================================================
/**
 * SharedWorker client - connects to a shared worker from page/tab
 */
export class SharedWorkerClient {
    _scriptUrl;
    _channelName;
    _options;
    _worker = null;
    _port = null;
    _subs = new Set();
    _pending = new Map();
    _listening = false;
    _cleanup = null;
    _portId = UUIDv4();
    _state = new ChannelSubject();
    constructor(_scriptUrl, _channelName, _options = {}) {
        this._scriptUrl = _scriptUrl;
        this._channelName = _channelName;
        this._options = _options;
        if (_options.autoConnect !== false)
            this.connect();
    }
    connect() {
        if (this._worker)
            return;
        try {
            this._worker = new SharedWorker(this._scriptUrl, {
                name: this._options.name,
                credentials: this._options.credentials,
                type: this._options.type
            });
            this._port = this._worker.port;
            this._setupListeners();
            this._port.start();
            this._state.next("connecting");
            // Send handshake
            this.send({
                id: UUIDv4(),
                channel: this._channelName,
                sender: this._portId,
                type: "signal",
                payload: { action: "connect", portId: this._portId }
            });
        }
        catch (e) {
            this._state.next("error");
            throw e;
        }
    }
    send(msg, transfer) {
        if (!this._port)
            return;
        const { transferable, ...data } = msg;
        this._port.postMessage({ ...data, portId: this._portId }, transfer ?? []);
    }
    request(msg) {
        const reqId = msg.reqId ?? UUIDv4();
        return new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
                if (this._pending.has(reqId)) {
                    this._pending.delete(reqId);
                    reject(new Error("Request timeout"));
                }
            }, 30000);
            this._pending.set(reqId, {
                resolve: (v) => { clearTimeout(timeout); resolve(v); },
                reject: (e) => { clearTimeout(timeout); reject(e); },
                timestamp: Date.now()
            });
            this.send({ ...msg, reqId, type: "request" });
        });
    }
    broadcast(msg, transfer) {
        this.send({ ...msg, broadcast: true }, transfer);
    }
    subscribe(observer) {
        const obs = typeof observer === "function" ? { next: observer } : observer;
        this._subs.add(obs);
        if (!this._listening)
            this._activate();
        return {
            closed: false,
            unsubscribe: () => {
                this._subs.delete(obs);
                if (this._subs.size === 0)
                    this._deactivate();
            }
        };
    }
    _setupListeners() {
        if (!this._port)
            return;
        const msgHandler = (e) => {
            const data = e.data;
            // Handle connection acknowledgment
            if (data.type === "signal" && data.payload?.action === "connected") {
                this._state.next("connected");
            }
            // Handle response
            if (data.type === "response" && data.reqId) {
                const p = this._pending.get(data.reqId);
                if (p) {
                    this._pending.delete(data.reqId);
                    if (data.payload?.error)
                        p.reject(new Error(data.payload.error));
                    else
                        p.resolve(data.payload?.result ?? data.payload);
                }
            }
            for (const s of this._subs) {
                try {
                    s.next?.(data);
                }
                catch (e) {
                    s.error?.(e);
                }
            }
        };
        const errHandler = (e) => {
            this._state.next("error");
            const err = new Error("SharedWorker error");
            for (const s of this._subs)
                s.error?.(err);
        };
        this._port.addEventListener("message", msgHandler);
        this._port.addEventListener("messageerror", errHandler);
        this._cleanup = () => {
            this._port?.removeEventListener("message", msgHandler);
            this._port?.removeEventListener("messageerror", errHandler);
        };
    }
    _activate() { this._listening = true; }
    _deactivate() {
        this._cleanup?.();
        this._cleanup = null;
        this._listening = false;
    }
    disconnect() {
        this.send({
            id: UUIDv4(),
            channel: this._channelName,
            sender: this._portId,
            type: "signal",
            payload: { action: "disconnect", portId: this._portId }
        });
        this._deactivate();
        this._port?.close();
        this._port = null;
        this._worker = null;
        this._state.next("disconnected");
    }
    close() {
        this._subs.forEach(s => s.complete?.());
        this._subs.clear();
        this.disconnect();
    }
    get port() { return this._port; }
    get portId() { return this._portId; }
    get isConnected() { return this._state.getValue() === "connected"; }
    get state() { return this._state; }
    get channelName() { return this._channelName; }
}
// ============================================================================
// SHARED WORKER HOST (Inside SharedWorker)
// ============================================================================
/**
 * SharedWorker host - runs inside the shared worker context
 */
export class SharedWorkerHost {
    _channelName;
    _ports = new Map();
    _subs = new Set();
    _state = new ChannelSubject();
    constructor(_channelName) {
        this._channelName = _channelName;
        this._setupGlobalHandler();
    }
    _setupGlobalHandler() {
        // In SharedWorker context, `self` has `onconnect`
        if (typeof self !== "undefined" && "onconnect" in self) {
            self.onconnect = (e) => {
                const port = e.ports[0];
                const portId = UUIDv4();
                this._registerPort(portId, port);
            };
            this._state.next("ready");
        }
    }
    _registerPort(portId, port) {
        const info = {
            id: portId,
            connectedAt: Date.now(),
            lastSeen: Date.now()
        };
        port.onmessage = (e) => {
            const data = e.data;
            info.lastSeen = Date.now();
            // Handle connection message
            if (data.type === "signal") {
                if (data.payload?.action === "connect") {
                    const realPortId = data.payload.portId || portId;
                    // Update mapping with real portId
                    this._ports.delete(portId);
                    info.id = realPortId;
                    this._ports.set(realPortId, { port, info });
                    // Send acknowledgment
                    port.postMessage({
                        id: UUIDv4(),
                        channel: this._channelName,
                        sender: "host",
                        type: "signal",
                        payload: { action: "connected", portId: realPortId }
                    });
                    return;
                }
                if (data.payload?.action === "disconnect") {
                    this._unregisterPort(data.portId ?? portId);
                    return;
                }
            }
            // Handle broadcast
            if (data.broadcast) {
                this.broadcast(data, data.portId ?? portId);
            }
            // Notify subscribers
            for (const s of this._subs) {
                try {
                    s.next?.({ ...data, portId: data.portId ?? portId });
                }
                catch (e) {
                    s.error?.(e);
                }
            }
        };
        port.onmessageerror = (e) => {
            const err = new Error("Port message error");
            for (const s of this._subs)
                s.error?.(err);
        };
        port.start();
        this._ports.set(portId, { port, info });
    }
    _unregisterPort(portId) {
        const entry = this._ports.get(portId);
        if (entry) {
            entry.port.close();
            this._ports.delete(portId);
        }
    }
    send(portId, msg, transfer) {
        const entry = this._ports.get(portId);
        if (!entry)
            return;
        const { transferable, ...data } = msg;
        entry.port.postMessage(data, transfer ?? []);
    }
    broadcast(msg, excludePortId) {
        const { transferable, ...data } = msg;
        for (const [id, entry] of this._ports) {
            if (id !== excludePortId) {
                entry.port.postMessage({ ...data, broadcast: true });
            }
        }
    }
    respond(msg, result, transfer) {
        if (!msg.portId || !msg.reqId)
            return;
        this.send(msg.portId, {
            id: UUIDv4(),
            channel: msg.sender,
            sender: this._channelName,
            type: "response",
            reqId: msg.reqId,
            payload: { result }
        }, transfer);
    }
    subscribe(observer) {
        const obs = typeof observer === "function" ? { next: observer } : observer;
        this._subs.add(obs);
        return {
            closed: false,
            unsubscribe: () => { this._subs.delete(obs); }
        };
    }
    getPorts() {
        const result = new Map();
        for (const [id, entry] of this._ports) {
            result.set(id, { ...entry.info });
        }
        return result;
    }
    get portCount() { return this._ports.size; }
    get state() { return this._state; }
    get channelName() { return this._channelName; }
}
// ============================================================================
// OBSERVABLE WRAPPER
// ============================================================================
export function createSharedWorkerObservable(scriptUrl, channelName, options) {
    return new SharedWorkerClient(scriptUrl, channelName, options);
}
export function createSharedWorkerHostObservable(channelName) {
    return new SharedWorkerHost(channelName);
}
// ============================================================================
// FACTORY
// ============================================================================
export const SharedWorkerObservableFactory = {
    client: (url, name, opts) => new SharedWorkerClient(url, name, opts),
    host: (name) => new SharedWorkerHost(name)
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2hhcmVkV29ya2VyVHJhbnNwb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU2hhcmVkV29ya2VyVHJhbnNwb3J0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFjLGNBQWMsRUFBb0MsTUFBTSwwQkFBMEIsQ0FBQztBQTBCeEcsK0VBQStFO0FBQy9FLHVDQUF1QztBQUN2QywrRUFBK0U7QUFFL0U7O0dBRUc7QUFDSCxNQUFNLE9BQU8sa0JBQWtCO0lBV2Y7SUFDQTtJQUNBO0lBWkosT0FBTyxHQUF3QixJQUFJLENBQUM7SUFDcEMsS0FBSyxHQUF1QixJQUFJLENBQUM7SUFDakMsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFpQyxDQUFDO0lBQ2pELFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztJQUM3QyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQ25CLFFBQVEsR0FBd0IsSUFBSSxDQUFDO0lBQ3JDLE9BQU8sR0FBVyxNQUFNLEVBQUUsQ0FBQztJQUMzQixNQUFNLEdBQUcsSUFBSSxjQUFjLEVBQXlELENBQUM7SUFFN0YsWUFDWSxVQUF3QixFQUN4QixZQUFvQixFQUNwQixXQUFnQyxFQUFFO1FBRmxDLGVBQVUsR0FBVixVQUFVLENBQWM7UUFDeEIsaUJBQVksR0FBWixZQUFZLENBQVE7UUFDcEIsYUFBUSxHQUFSLFFBQVEsQ0FBMEI7UUFFMUMsSUFBSSxRQUFRLENBQUMsV0FBVyxLQUFLLEtBQUs7WUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTztRQUV6QixJQUFJLENBQUM7WUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQzdDLElBQUksRUFB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a2VyIFRyYW5zcG9ydFxuICpcbiAqIEVuYWJsZXMgc2hhcmVkIHdvcmtlciBjb21tdW5pY2F0aW9uIGFjcm9zcyBtdWx0aXBsZSB0YWJzL3dpbmRvd3MuXG4gKiBTaGFyZWRXb3JrZXIgcHJvdmlkZXMgYSBzaGFyZWQgY29udGV4dCB0aGF0IHBlcnNpc3RzIGFjcm9zcyBhbGxcbiAqIGNvbm5lY3RlZCBicm93c2luZyBjb250ZXh0cy5cbiAqL1xuXG5pbXBvcnQgeyBVVUlEdjQgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBDaGFubmVsU3ViamVjdCwgdHlwZSBTdWJzY3JpcHRpb24sIHR5cGUgT2JzZXJ2ZXIgfSBmcm9tIFwiLi4vb2JzZXJ2YWJsZS9PYnNlcnZhYmxlXCI7XG5pbXBvcnQgdHlwZSB7IENoYW5uZWxNZXNzYWdlLCBQZW5kaW5nUmVxdWVzdCwgU3Vic2NyaWJlciB9IGZyb20gXCIuLi90eXBlcy9JbnRlcmZhY2VcIjtcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gVFlQRVNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGludGVyZmFjZSBTaGFyZWRXb3JrZXJNZXNzYWdlPFQgPSBhbnk+IGV4dGVuZHMgQ2hhbm5lbE1lc3NhZ2Uge1xuICAgIHBvcnRJZD86IHN0cmluZztcbiAgICBicm9hZGNhc3Q/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNoYXJlZFdvcmtlck9wdGlvbnMge1xuICAgIG5hbWU/OiBzdHJpbmc7XG4gICAgY3JlZGVudGlhbHM/OiBSZXF1ZXN0Q3JlZGVudGlhbHM7XG4gICAgdHlwZT86IFdvcmtlclR5cGU7XG4gICAgYXV0b0Nvbm5lY3Q/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNoYXJlZFdvcmtlclBvcnRJbmZvIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIGNvbm5lY3RlZEF0OiBudW1iZXI7XG4gICAgbGFzdFNlZW46IG51bWJlcjtcbiAgICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFNIQVJFRCBXT1JLRVIgQ0xJRU5UIChQYWdlL1RhYiBTaWRlKVxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIFNoYXJlZFdvcmtlciBjbGllbnQgLSBjb25uZWN0cyB0byBhIHNoYXJlZCB3b3JrZXIgZnJvbSBwYWdlL3RhYlxuICovXG5leHBvcnQgY2xhc3MgU2hhcmVkV29ya2VyQ2xpZW50IHtcbiAgICBwcml2YXRlIF93b3JrZXI6IFNoYXJlZFdvcmtlciB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgX3BvcnQ6IE1lc3NhZ2VQb3J0IHwgbnVsbCA9IG51bGw7XG4gICAgcHJpdmF0ZSBfc3VicyA9IG5ldyBTZXQ8T2JzZXJ2ZXI8U2hhcmVkV29ya2VyTWVzc2FnZT4+KCk7XG4gICAgcHJpdmF0ZSBfcGVuZGluZyA9IG5ldyBNYXA8c3RyaW5nLCBQZW5kaW5nUmVxdWVzdD4oKTtcbiAgICBwcml2YXRlIF9saXN0ZW5pbmcgPSBmYWxzZTtcbiAgICBwcml2YXRlIF9jbGVhbnVwOiAoKCkgPT4gdm9pZCkgfCBudWxsID0gbnVsbDtcbiAgICBwcml2YXRlIF9wb3J0SWQ6IHN0cmluZyA9IFVVSUR2NCgpO1xuICAgIHByaXZhdGUgX3N0YXRlID0gbmV3IENoYW5uZWxTdWJqZWN0PFwiY29ubmVjdGluZ1wiIHwgXCJjb25uZWN0ZWRcIiB8IFwiZGlzY29ubmVjdGVkXCIgfCBcImVycm9yXCI+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBfc2NyaXB0VXJsOiBzdHJpbmcgfCBVUkwsXG4gICAgICAgIHByaXZhdGUgX2NoYW5uZWxOYW1lOiBzdHJpbmcsXG4gICAgICAgIHByaXZhdGUgX29wdGlvbnM6IFNoYXJlZFdvcmtlck9wdGlvbnMgPSB7fVxuICAgICkge1xuICAgICAgICBpZiAoX29wdGlvbnMuYXV0b0Nvbm5lY3QgIT09IGZhbHNlKSB0aGlzLmNvbm5lY3QoKTtcbiAgICB9XG5cbiAgICBjb25uZWN0KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5fd29ya2VyKSByZXR1cm47XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuX3dvcmtlciA9IG5ldyBTaGFyZWRXb3JrZXIodGhpcy5fc2NyaXB0VXJsLCB7XG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5fb3B0aW9ucy5uYW1lLFxuICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxzOiB0aGlzLl9vcHRpb25zLmNyZWRlbnRpYWxzLFxuICAgICAgICAgICAgICAgIHR5cGU6IHRoaXMuX29wdGlvbnMudHlwZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLl9wb3J0ID0gdGhpcy5fd29ya2VyLnBvcnQ7XG4gICAgICAgICAgICB0aGlzLl9zZXR1cExpc3RlbmVycygpO1xuICAgICAgICAgICAgdGhpcy5fcG9ydC5zdGFydCgpO1xuICAgICAgICAgICAgdGhpcy5fc3RhdGUubmV4dChcImNvbm5lY3RpbmdcIik7XG5cbiAgICAgICAgICAgIC8vIFNlbmQgaGFuZHNoYWtlXG4gICAgICAgICAgICB0aGlzLnNlbmQoe1xuICAgICAgICAgICAgICAgIGlkOiBVVUlEdjQoKSxcbiAgICAgICAgICAgICAgICBjaGFubmVsOiB0aGlzLl9jaGFubmVsTmFtZSxcbiAgICAgICAgICAgICAgICBzZW5kZXI6IHRoaXMuX3BvcnRJZCxcbiAgICAgICAgICAgICAgICB0eXBlOiBcInNpZ25hbFwiLFxuICAgICAgICAgICAgICAgIHBheWxvYWQ6IHsgYWN0aW9uOiBcImNvbm5lY3RcIiwgcG9ydElkOiB0aGlzLl9wb3J0SWQgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMuX3N0YXRlLm5leHQoXCJlcnJvclwiKTtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZW5kKG1zZzogU2hhcmVkV29ya2VyTWVzc2FnZSwgdHJhbnNmZXI/OiBUcmFuc2ZlcmFibGVbXSk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuX3BvcnQpIHJldHVybjtcbiAgICAgICAgY29uc3QgeyB0cmFuc2ZlcmFibGUsIC4uLmRhdGEgfSA9IG1zZyBhcyBhbnk7XG4gICAgICAgIHRoaXMuX3BvcnQucG9zdE1lc3NhZ2UoeyAuLi5kYXRhLCBwb3J0SWQ6IHRoaXMuX3BvcnRJZCB9LCB0cmFuc2ZlciA/PyBbXSk7XG4gICAgfVxuXG4gICAgcmVxdWVzdChtc2c6IE9taXQ8U2hhcmVkV29ya2VyTWVzc2FnZSwgXCJyZXFJZFwiPiAmIHsgcmVxSWQ/OiBzdHJpbmcgfSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlcUlkID0gbXNnLnJlcUlkID8/IFVVSUR2NCgpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wZW5kaW5nLmhhcyhyZXFJZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGVuZGluZy5kZWxldGUocmVxSWQpO1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwiUmVxdWVzdCB0aW1lb3V0XCIpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCAzMDAwMCk7XG5cbiAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcuc2V0KHJlcUlkLCB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZTogKHYpID0+IHsgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOyByZXNvbHZlKHYpOyB9LFxuICAgICAgICAgICAgICAgIHJlamVjdDogKGUpID0+IHsgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOyByZWplY3QoZSk7IH0sXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgdGhpcy5zZW5kKHsgLi4ubXNnLCByZXFJZCwgdHlwZTogXCJyZXF1ZXN0XCIgfSBhcyBTaGFyZWRXb3JrZXJNZXNzYWdlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYnJvYWRjYXN0KG1zZzogU2hhcmVkV29ya2VyTWVzc2FnZSwgdHJhbnNmZXI/OiBUcmFuc2ZlcmFibGVbXSk6IHZvaWQge1xuICAgICAgICB0aGlzLnNlbmQoeyAuLi5tc2csIGJyb2FkY2FzdDogdHJ1ZSB9LCB0cmFuc2Zlcik7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlKG9ic2VydmVyOiBPYnNlcnZlcjxTaGFyZWRXb3JrZXJNZXNzYWdlPiB8ICgodjogU2hhcmVkV29ya2VyTWVzc2FnZSkgPT4gdm9pZCkpOiBTdWJzY3JpcHRpb24ge1xuICAgICAgICBjb25zdCBvYnM6IE9ic2VydmVyPFNoYXJlZFdvcmtlck1lc3NhZ2U+ID0gdHlwZW9mIG9ic2VydmVyID09PSBcImZ1bmN0aW9uXCIgPyB7IG5leHQ6IG9ic2VydmVyIH0gOiBvYnNlcnZlcjtcbiAgICAgICAgdGhpcy5fc3Vicy5hZGQob2JzKTtcbiAgICAgICAgaWYgKCF0aGlzLl9saXN0ZW5pbmcpIHRoaXMuX2FjdGl2YXRlKCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjbG9zZWQ6IGZhbHNlLFxuICAgICAgICAgICAgdW5zdWJzY3JpYmU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdWJzLmRlbGV0ZShvYnMpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zdWJzLnNpemUgPT09IDApIHRoaXMuX2RlYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zZXR1cExpc3RlbmVycygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLl9wb3J0KSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgbXNnSGFuZGxlciA9IChlOiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBlLmRhdGEgYXMgU2hhcmVkV29ya2VyTWVzc2FnZTtcblxuICAgICAgICAgICAgLy8gSGFuZGxlIGNvbm5lY3Rpb24gYWNrbm93bGVkZ21lbnRcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09IFwic2lnbmFsXCIgJiYgZGF0YS5wYXlsb2FkPy5hY3Rpb24gPT09IFwiY29ubmVjdGVkXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0ZS5uZXh0KFwiY29ubmVjdGVkXCIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBIYW5kbGUgcmVzcG9uc2VcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09IFwicmVzcG9uc2VcIiAmJiBkYXRhLnJlcUlkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuX3BlbmRpbmcuZ2V0KGRhdGEucmVxSWQpO1xuICAgICAgICAgICAgICAgIGlmIChwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmcuZGVsZXRlKGRhdGEucmVxSWQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5wYXlsb2FkPy5lcnJvcikgcC5yZWplY3QobmV3IEVycm9yKGRhdGEucGF5bG9hZC5lcnJvcikpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHAucmVzb2x2ZShkYXRhLnBheWxvYWQ/LnJlc3VsdCA/PyBkYXRhLnBheWxvYWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX3N1YnMpIHtcbiAgICAgICAgICAgICAgICB0cnkgeyBzLm5leHQ/LihkYXRhKTsgfSBjYXRjaCAoZSkgeyBzLmVycm9yPy4oZSBhcyBFcnJvcik7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBlcnJIYW5kbGVyID0gKGU6IE1lc3NhZ2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fc3RhdGUubmV4dChcImVycm9yXCIpO1xuICAgICAgICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKFwiU2hhcmVkV29ya2VyIGVycm9yXCIpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX3N1YnMpIHMuZXJyb3I/LihlcnIpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuX3BvcnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VcIiwgbXNnSGFuZGxlcik7XG4gICAgICAgIHRoaXMuX3BvcnQuYWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VlcnJvclwiLCBlcnJIYW5kbGVyKTtcbiAgICAgICAgdGhpcy5fY2xlYW51cCA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3BvcnQ/LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsIG1zZ0hhbmRsZXIpO1xuICAgICAgICAgICAgdGhpcy5fcG9ydD8ucmVtb3ZlRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VlcnJvclwiLCBlcnJIYW5kbGVyKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hY3RpdmF0ZSgpOiB2b2lkIHsgdGhpcy5fbGlzdGVuaW5nID0gdHJ1ZTsgfVxuICAgIHByaXZhdGUgX2RlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2NsZWFudXA/LigpO1xuICAgICAgICB0aGlzLl9jbGVhbnVwID0gbnVsbDtcbiAgICAgICAgdGhpcy5fbGlzdGVuaW5nID0gZmFsc2U7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZW5kKHtcbiAgICAgICAgICAgIGlkOiBVVUlEdjQoKSxcbiAgICAgICAgICAgIGNoYW5uZWw6IHRoaXMuX2NoYW5uZWxOYW1lLFxuICAgICAgICAgICAgc2VuZGVyOiB0aGlzLl9wb3J0SWQsXG4gICAgICAgICAgICB0eXBlOiBcInNpZ25hbFwiLFxuICAgICAgICAgICAgcGF5bG9hZDogeyBhY3Rpb246IFwiZGlzY29ubmVjdFwiLCBwb3J0SWQ6IHRoaXMuX3BvcnRJZCB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9kZWFjdGl2YXRlKCk7XG4gICAgICAgIHRoaXMuX3BvcnQ/LmNsb3NlKCk7XG4gICAgICAgIHRoaXMuX3BvcnQgPSBudWxsO1xuICAgICAgICB0aGlzLl93b3JrZXIgPSBudWxsO1xuICAgICAgICB0aGlzLl9zdGF0ZS5uZXh0KFwiZGlzY29ubmVjdGVkXCIpO1xuICAgIH1cblxuICAgIGNsb3NlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9zdWJzLmZvckVhY2gocyA9PiBzLmNvbXBsZXRlPy4oKSk7XG4gICAgICAgIHRoaXMuX3N1YnMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgfVxuXG4gICAgZ2V0IHBvcnQoKTogTWVzc2FnZVBvcnQgfCBudWxsIHsgcmV0dXJuIHRoaXMuX3BvcnQ7IH1cbiAgICBnZXQgcG9ydElkKCk6IHN0cmluZyB7IHJldHVybiB0aGlzLl9wb3J0SWQ7IH1cbiAgICBnZXQgaXNDb25uZWN0ZWQoKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLl9zdGF0ZS5nZXRWYWx1ZSgpID09PSBcImNvbm5lY3RlZFwiOyB9XG4gICAgZ2V0IHN0YXRlKCkgeyByZXR1cm4gdGhpcy5fc3RhdGU7IH1cbiAgICBnZXQgY2hhbm5lbE5hbWUoKTogc3RyaW5nIHsgcmV0dXJuIHRoaXMuX2NoYW5uZWxOYW1lOyB9XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIFNIQVJFRCBXT1JLRVIgSE9TVCAoSW5zaWRlIFNoYXJlZFdvcmtlcilcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuLyoqXG4gKiBTaGFyZWRXb3JrZXIgaG9zdCAtIHJ1bnMgaW5zaWRlIHRoZSBzaGFyZWQgd29ya2VyIGNvbnRleHRcbiAqL1xuZXhwb3J0IGNsYXNzIFNoYXJlZFdvcmtlckhvc3Qge1xuICAgIHByaXZhdGUgX3BvcnRzID0gbmV3IE1hcDxzdHJpbmcsIHsgcG9ydDogTWVzc2FnZVBvcnQ7IGluZm86IFNoYXJlZFdvcmtlclBvcnRJbmZvIH0+KCk7XG4gICAgcHJpdmF0ZSBfc3VicyA9IG5ldyBTZXQ8T2JzZXJ2ZXI8U2hhcmVkV29ya2VyTWVzc2FnZT4+KCk7XG4gICAgcHJpdmF0ZSBfc3RhdGUgPSBuZXcgQ2hhbm5lbFN1YmplY3Q8XCJyZWFkeVwiIHwgXCJlcnJvclwiPigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfY2hhbm5lbE5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLl9zZXR1cEdsb2JhbEhhbmRsZXIoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zZXR1cEdsb2JhbEhhbmRsZXIoKTogdm9pZCB7XG4gICAgICAgIC8vIEluIFNoYXJlZFdvcmtlciBjb250ZXh0LCBgc2VsZmAgaGFzIGBvbmNvbm5lY3RgXG4gICAgICAgIGlmICh0eXBlb2Ygc2VsZiAhPT0gXCJ1bmRlZmluZWRcIiAmJiBcIm9uY29ubmVjdFwiIGluIHNlbGYpIHtcbiAgICAgICAgICAgIChzZWxmIGFzIGFueSkub25jb25uZWN0ID0gKGU6IE1lc3NhZ2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBvcnQgPSBlLnBvcnRzWzBdO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBvcnRJZCA9IFVVSUR2NCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3JlZ2lzdGVyUG9ydChwb3J0SWQsIHBvcnQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuX3N0YXRlLm5leHQoXCJyZWFkeVwiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX3JlZ2lzdGVyUG9ydChwb3J0SWQ6IHN0cmluZywgcG9ydDogTWVzc2FnZVBvcnQpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaW5mbzogU2hhcmVkV29ya2VyUG9ydEluZm8gPSB7XG4gICAgICAgICAgICBpZDogcG9ydElkLFxuICAgICAgICAgICAgY29ubmVjdGVkQXQ6IERhdGUubm93KCksXG4gICAgICAgICAgICBsYXN0U2VlbjogRGF0ZS5ub3coKVxuICAgICAgICB9O1xuXG4gICAgICAgIHBvcnQub25tZXNzYWdlID0gKGU6IE1lc3NhZ2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGF0YSA9IGUuZGF0YSBhcyBTaGFyZWRXb3JrZXJNZXNzYWdlO1xuICAgICAgICAgICAgaW5mby5sYXN0U2VlbiA9IERhdGUubm93KCk7XG5cbiAgICAgICAgICAgIC8vIEhhbmRsZSBjb25uZWN0aW9uIG1lc3NhZ2VcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09IFwic2lnbmFsXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5wYXlsb2FkPy5hY3Rpb24gPT09IFwiY29ubmVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWxQb3J0SWQgPSBkYXRhLnBheWxvYWQucG9ydElkIHx8IHBvcnRJZDtcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIG1hcHBpbmcgd2l0aCByZWFsIHBvcnRJZFxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wb3J0cy5kZWxldGUocG9ydElkKTtcbiAgICAgICAgICAgICAgICAgICAgaW5mby5pZCA9IHJlYWxQb3J0SWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BvcnRzLnNldChyZWFsUG9ydElkLCB7IHBvcnQsIGluZm8gfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gU2VuZCBhY2tub3dsZWRnbWVudFxuICAgICAgICAgICAgICAgICAgICBwb3J0LnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBVVUlEdjQoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IHRoaXMuX2NoYW5uZWxOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGVyOiBcImhvc3RcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwic2lnbmFsXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB7IGFjdGlvbjogXCJjb25uZWN0ZWRcIiwgcG9ydElkOiByZWFsUG9ydElkIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5wYXlsb2FkPy5hY3Rpb24gPT09IFwiZGlzY29ubmVjdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VucmVnaXN0ZXJQb3J0KGRhdGEucG9ydElkID8/IHBvcnRJZCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEhhbmRsZSBicm9hZGNhc3RcbiAgICAgICAgICAgIGlmIChkYXRhLmJyb2FkY2FzdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYnJvYWRjYXN0KGRhdGEsIGRhdGEucG9ydElkID8/IHBvcnRJZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIE5vdGlmeSBzdWJzY3JpYmVyc1xuICAgICAgICAgICAgZm9yIChjb25zdCBzIG9mIHRoaXMuX3N1YnMpIHtcbiAgICAgICAgICAgICAgICB0cnkgeyBzLm5leHQ/Lih7IC4uLmRhdGEsIHBvcnRJZDogZGF0YS5wb3J0SWQgPz8gcG9ydElkIH0pOyB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsgcy5lcnJvcj8uKGUgYXMgRXJyb3IpOyB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgcG9ydC5vbm1lc3NhZ2VlcnJvciA9IChlOiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihcIlBvcnQgbWVzc2FnZSBlcnJvclwiKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9zdWJzKSBzLmVycm9yPy4oZXJyKTtcbiAgICAgICAgfTtcblxuICAgICAgICBwb3J0LnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuX3BvcnRzLnNldChwb3J0SWQsIHsgcG9ydCwgaW5mbyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF91bnJlZ2lzdGVyUG9ydChwb3J0SWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBjb25zdCBlbnRyeSA9IHRoaXMuX3BvcnRzLmdldChwb3J0SWQpO1xuICAgICAgICBpZiAoZW50cnkpIHtcbiAgICAgICAgICAgIGVudHJ5LnBvcnQuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMuX3BvcnRzLmRlbGV0ZShwb3J0SWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2VuZChwb3J0SWQ6IHN0cmluZywgbXNnOiBTaGFyZWRXb3JrZXJNZXNzYWdlLCB0cmFuc2Zlcj86IFRyYW5zZmVyYWJsZVtdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5fcG9ydHMuZ2V0KHBvcnRJZCk7XG4gICAgICAgIGlmICghZW50cnkpIHJldHVybjtcbiAgICAgICAgY29uc3QgeyB0cmFuc2ZlcmFibGUsIC4uLmRhdGEgfSA9IG1zZyBhcyBhbnk7XG4gICAgICAgIGVudHJ5LnBvcnQucG9zdE1lc3NhZ2UoZGF0YSwgdHJhbnNmZXIgPz8gW10pO1xuICAgIH1cblxuICAgIGJyb2FkY2FzdChtc2c6IFNoYXJlZFdvcmtlck1lc3NhZ2UsIGV4Y2x1ZGVQb3J0SWQ/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgeyB0cmFuc2ZlcmFibGUsIC4uLmRhdGEgfSA9IG1zZyBhcyBhbnk7XG4gICAgICAgIGZvciAoY29uc3QgW2lkLCBlbnRyeV0gb2YgdGhpcy5fcG9ydHMpIHtcbiAgICAgICAgICAgIGlmIChpZCAhPT0gZXhjbHVkZVBvcnRJZCkge1xuICAgICAgICAgICAgICAgIGVudHJ5LnBvcnQucG9zdE1lc3NhZ2UoeyAuLi5kYXRhLCBicm9hZGNhc3Q6IHRydWUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXNwb25kKG1zZzogU2hhcmVkV29ya2VyTWVzc2FnZSwgcmVzdWx0OiBhbnksIHRyYW5zZmVyPzogVHJhbnNmZXJhYmxlW10pOiB2b2lkIHtcbiAgICAgICAgaWYgKCFtc2cucG9ydElkIHx8ICFtc2cucmVxSWQpIHJldHVybjtcbiAgICAgICAgdGhpcy5zZW5kKG1zZy5wb3J0SWQsIHtcbiAgICAgICAgICAgIGlkOiBVVUlEdjQoKSxcbiAgICAgICAgICAgIGNoYW5uZWw6IG1zZy5zZW5kZXIsXG4gICAgICAgICAgICBzZW5kZXI6IHRoaXMuX2NoYW5uZWxOYW1lLFxuICAgICAgICAgICAgdHlwZTogXCJyZXNwb25zZVwiLFxuICAgICAgICAgICAgcmVxSWQ6IG1zZy5yZXFJZCxcbiAgICAgICAgICAgIHBheWxvYWQ6IHsgcmVzdWx0IH1cbiAgICAgICAgfSwgdHJhbnNmZXIpO1xuICAgIH1cblxuICAgIHN1YnNjcmliZShvYnNlcnZlcjogT2JzZXJ2ZXI8U2hhcmVkV29ya2VyTWVzc2FnZT4gfCAoKHY6IFNoYXJlZFdvcmtlck1lc3NhZ2UpID0+IHZvaWQpKTogU3Vic2NyaXB0aW9uIHtcbiAgICAgICAgY29uc3Qgb2JzOiBPYnNlcnZlcjxTaGFyZWRXb3JrZXJNZXNzYWdlPiA9IHR5cGVvZiBvYnNlcnZlciA9PT0gXCJmdW5jdGlvblwiID8geyBuZXh0OiBvYnNlcnZlciB9IDogb2JzZXJ2ZXI7XG4gICAgICAgIHRoaXMuX3N1YnMuYWRkKG9icyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjbG9zZWQ6IGZhbHNlLFxuICAgICAgICAgICAgdW5zdWJzY3JpYmU6ICgpID0+IHsgdGhpcy5fc3Vicy5kZWxldGUob2JzKTsgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGdldFBvcnRzKCk6IE1hcDxzdHJpbmcsIFNoYXJlZFdvcmtlclBvcnRJbmZvPiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBNYXA8c3RyaW5nLCBTaGFyZWRXb3JrZXJQb3J0SW5mbz4oKTtcbiAgICAgICAgZm9yIChjb25zdCBbaWQsIGVudHJ5XSBvZiB0aGlzLl9wb3J0cykge1xuICAgICAgICAgICAgcmVzdWx0LnNldChpZCwgeyAuLi5lbnRyeS5pbmZvIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgZ2V0IHBvcnRDb3VudCgpOiBudW1iZXIgeyByZXR1cm4gdGhpcy5fcG9ydHMuc2l6ZTsgfVxuICAgIGdldCBzdGF0ZSgpIHsgcmV0dXJuIHRoaXMuX3N0YXRlOyB9XG4gICAgZ2V0IGNoYW5uZWxOYW1lKCk6IHN0cmluZyB7IHJldHVybiB0aGlzLl9jaGFubmVsTmFtZTsgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBPQlNFUlZBQkxFIFdSQVBQRVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVNoYXJlZFdvcmtlck9ic2VydmFibGUoXG4gICAgc2NyaXB0VXJsOiBzdHJpbmcgfCBVUkwsXG4gICAgY2hhbm5lbE5hbWU6IHN0cmluZyxcbiAgICBvcHRpb25zPzogU2hhcmVkV29ya2VyT3B0aW9uc1xuKTogU2hhcmVkV29ya2VyQ2xpZW50IHtcbiAgICByZXR1cm4gbmV3IFNoYXJlZFdvcmtlckNsaWVudChzY3JpcHRVcmwsIGNoYW5uZWxOYW1lLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVNoYXJlZFdvcmtlckhvc3RPYnNlcnZhYmxlKGNoYW5uZWxOYW1lOiBzdHJpbmcpOiBTaGFyZWRXb3JrZXJIb3N0IHtcbiAgICByZXR1cm4gbmV3IFNoYXJlZFdvcmtlckhvc3QoY2hhbm5lbE5hbWUpO1xufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBGQUNUT1JZXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjb25zdCBTaGFyZWRXb3JrZXJPYnNlcnZhYmxlRmFjdG9yeSA9IHtcbiAgICBjbGllbnQ6ICh1cmw6IHN0cmluZyB8IFVSTCwgbmFtZTogc3RyaW5nLCBvcHRzPzogU2hhcmVkV29ya2VyT3B0aW9ucykgPT5cbiAgICAgICAgbmV3IFNoYXJlZFdvcmtlckNsaWVudCh1cmwsIG5hbWUsIG9wdHMpLFxuICAgIGhvc3Q6IChuYW1lOiBzdHJpbmcpID0+IG5ldyBTaGFyZWRXb3JrZXJIb3N0KG5hbWUpXG59O1xuIl19