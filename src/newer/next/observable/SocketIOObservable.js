/**
 * Socket.IO Observable API
 *
 * Observable wrapper for Socket.IO client.
 */
import { UUIDv4 } from "fest/core";
import { ChannelSubject } from "./Observable";
// ============================================================================
// SOCKET.IO OBSERVABLE
// ============================================================================
export class SocketIOObservable {
    _socket;
    _channelName;
    _options;
    _subs = new Set();
    _pending = new Map();
    _listening = false;
    _cleanups = [];
    _events;
    _defaultEvent;
    _state = new ChannelSubject();
    constructor(_socket, _channelName, _options = {}) {
        this._socket = _socket;
        this._channelName = _channelName;
        this._options = _options;
        this._events = _options.events ?? ["message", "channel"];
        this._defaultEvent = _options.defaultEvent ?? "message";
        if (_options.autoConnect !== false)
            this._socket.connect?.();
    }
    send(msg, event) {
        const { transferable, ack, ...data } = msg;
        this._socket.emit(event ?? msg.event ?? this._defaultEvent, data);
    }
    emit(event, data) {
        this._socket.emit(event, data);
    }
    request(msg, event) {
        const reqId = msg.reqId ?? UUIDv4();
        return new Promise((resolve, reject) => {
            this._pending.set(reqId, { resolve, reject, timestamp: Date.now() });
            const timeout = setTimeout(() => {
                if (this._pending.has(reqId)) {
                    this._pending.delete(reqId);
                    reject(new Error("Request timeout"));
                }
            }, 30000);
            const { transferable, ack, ...data } = { ...msg, reqId };
            this._socket.emit(event ?? this._defaultEvent, data, (response) => {
                clearTimeout(timeout);
                this._pending.delete(reqId);
                resolve(response);
            });
        });
    }
    subscribe(observer) {
        const obs = typeof observer === "function" ? { next: observer } : observer;
        const first = this._subs.size === 0;
        this._subs.add(obs);
        if (first && !this._listening)
            this._activate();
        return {
            closed: false,
            unsubscribe: () => {
                this._subs.delete(obs);
                if (this._subs.size === 0 && this._listening)
                    this._deactivate();
            }
        };
    }
    _activate() {
        if (this._listening)
            return;
        for (const event of this._events) {
            const handler = (data, ack) => {
                const msg = {
                    ...(typeof data === "object" ? data : { payload: data }),
                    id: data?.id ?? UUIDv4(),
                    event,
                    ack
                };
                // Handle response
                if (msg.type === "response" && msg.reqId) {
                    const p = this._pending.get(msg.reqId);
                    if (p) {
                        p.resolve(msg.payload);
                        this._pending.delete(msg.reqId);
                    }
                }
                for (const s of this._subs) {
                    try {
                        s.next?.(msg);
                    }
                    catch (e) {
                        s.error?.(e);
                    }
                }
            };
            this._socket.on(event, handler);
            this._cleanups.push(() => this._socket.off(event, handler));
        }
        // Connection events
        const onConnect = () => this._state.next("connected");
        const onDisconnect = () => this._state.next("disconnected");
        const onError = (err) => {
            this._state.next("error");
            for (const s of this._subs)
                s.error?.(err instanceof Error ? err : new Error(String(err)));
        };
        this._socket.on("connect", onConnect);
        this._socket.on("disconnect", onDisconnect);
        this._socket.on("error", onError);
        this._cleanups.push(() => this._socket.off("connect", onConnect), () => this._socket.off("disconnect", onDisconnect), () => this._socket.off("error", onError));
        this._listening = true;
    }
    _deactivate() {
        this._cleanups.forEach((fn) => fn());
        this._cleanups = [];
        this._listening = false;
    }
    close() {
        this._subs.forEach((s) => s.complete?.());
        this._subs.clear();
        this._deactivate();
        this._socket.disconnect?.();
    }
    get socket() { return this._socket; }
    get channelName() { return this._channelName; }
    get isConnected() { return this._socket.connected ?? false; }
    get state() { return this._state; }
}
// ============================================================================
// ROOM OBSERVABLE
// ============================================================================
export class SocketIORoomObservable {
    _parent;
    _roomName;
    _subs = new Set();
    _parentSub = null;
    constructor(_parent, _roomName) {
        this._parent = _parent;
        this._roomName = _roomName;
    }
    send(msg) {
        this._parent.send({ ...msg, room: this._roomName });
    }
    subscribe(observer) {
        const obs = typeof observer === "function" ? { next: observer } : observer;
        const first = this._subs.size === 0;
        this._subs.add(obs);
        if (first && !this._parentSub) {
            this._parentSub = this._parent.subscribe({
                next: (msg) => {
                    if (msg.room === this._roomName || msg.channel === this._roomName) {
                        for (const s of this._subs) {
                            try {
                                s.next?.(msg);
                            }
                            catch (e) {
                                s.error?.(e);
                            }
                        }
                    }
                },
                error: (e) => { for (const s of this._subs)
                    s.error?.(e); },
                complete: () => { for (const s of this._subs)
                    s.complete?.(); }
            });
        }
        return {
            closed: false,
            unsubscribe: () => {
                this._subs.delete(obs);
                if (this._subs.size === 0) {
                    this._parentSub?.unsubscribe();
                    this._parentSub = null;
                }
            }
        };
    }
    get roomName() { return this._roomName; }
}
// ============================================================================
// REQUEST HANDLER
// ============================================================================
export function createSocketRequestHandler(channelName, handlers) {
    return async (data) => {
        if (data.type !== "request" || !data.ack)
            return;
        const action = data.payload?.action;
        if (action && handlers[action]) {
            try {
                const result = await handlers[action](data.payload?.args ?? [], data);
                data.ack({ id: UUIDv4(), channel: data.sender, sender: channelName, reqId: data.reqId, type: "response", payload: { result }, timestamp: Date.now() });
            }
            catch (error) {
                data.ack({ id: UUIDv4(), channel: data.sender, sender: channelName, reqId: data.reqId, type: "response", payload: { error: error instanceof Error ? error.message : String(error) }, timestamp: Date.now() });
            }
        }
    };
}
// ============================================================================
// FACTORY
// ============================================================================
export const SocketIOObservableFactory = {
    create: (socket, channelName, options) => new SocketIOObservable(socket, channelName, options),
    room: (parent, roomName) => new SocketIORoomObservable(parent, roomName)
};
export function createSocketObservable(socket, channelName, options) {
    return new SocketIOObservable(socket, channelName, options);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU29ja2V0SU9PYnNlcnZhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU29ja2V0SU9PYnNlcnZhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25DLE9BQU8sRUFBYyxjQUFjLEVBQW9DLE1BQU0sY0FBYyxDQUFDO0FBNEI1RiwrRUFBK0U7QUFDL0UsdUJBQXVCO0FBQ3ZCLCtFQUErRTtBQUUvRSxNQUFNLE9BQU8sa0JBQWtCO0lBVWY7SUFDQTtJQUNBO0lBWEosS0FBSyxHQUFHLElBQUksR0FBRyxFQUEyQixDQUFDO0lBQzNDLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztJQUM3QyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQ25CLFNBQVMsR0FBbUIsRUFBRSxDQUFDO0lBQy9CLE9BQU8sQ0FBVztJQUNsQixhQUFhLENBQVM7SUFDdEIsTUFBTSxHQUFHLElBQUksY0FBYyxFQUF5RCxDQUFDO0lBRTdGLFlBQ1ksT0FBcUIsRUFDckIsWUFBb0IsRUFDcEIsV0FBb0MsRUFBRTtRQUZ0QyxZQUFPLEdBQVAsT0FBTyxDQUFjO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFRO1FBQ3BCLGFBQVEsR0FBUixRQUFRLENBQThCO1FBRTlDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQyxZQUFZLElBQUksU0FBUyxDQUFDO1FBQ3hELElBQUksUUFBUSxDQUFDLFdBQVcsS0FBSyxLQUFLO1lBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO0lBQ2pFLENBQUM7SUFFRCxJQUFJLENBQUMsR0FBa0IsRUFBRSxLQUFjO1FBQ25DLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxF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RSxFQUFFLENBQ3JGLElBQUksa0JBQWtCLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUM7SUFDeEQsSUFBSSxFQUFFLENBQUMsTUFBMEIsRUFBRSxRQUFnQixFQUFFLEVBQUUsQ0FDbkQsSUFBSSxzQkFBc0IsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDO0NBQ25ELENBQUM7QUFFRixNQUFNLFVBQVUsc0JBQXNCLENBQ2xDLE1BQW9CLEVBQ3BCLFdBQW1CLEVBQ25CLE9BQWlDO0lBRWpDLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ2hFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNvY2tldC5JTyBPYnNlcnZhYmxlIEFQSVxuICpcbiAqIE9ic2VydmFibGUgd3JhcHBlciBmb3IgU29ja2V0LklPIGNsaWVudC5cbiAqL1xuXG5pbXBvcnQgeyBVVUlEdjQgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBDaGFubmVsU3ViamVjdCwgdHlwZSBTdWJzY3JpcHRpb24sIHR5cGUgT2JzZXJ2ZXIgfSBmcm9tIFwiLi9PYnNlcnZhYmxlXCI7XG5pbXBvcnQgdHlwZSB7IENoYW5uZWxNZXNzYWdlLCBJbnZva2VySGFuZGxlciwgUmVzcG9uZGVyRm4sIFN1YnNjcmliZXIsIFBlbmRpbmdSZXF1ZXN0IH0gZnJvbSBcIi4uL3R5cGVzL0ludGVyZmFjZVwiO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBUWVBFU1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgaW50ZXJmYWNlIFNvY2tldElPTGlrZSB7XG4gICAgb24oZXZlbnQ6IHN0cmluZywgbGlzdGVuZXI6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IHZvaWQ7XG4gICAgb2ZmKGV2ZW50OiBzdHJpbmcsIGxpc3RlbmVyOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB2b2lkO1xuICAgIGVtaXQoZXZlbnQ6IHN0cmluZywgLi4uYXJnczogYW55W10pOiB2b2lkO1xuICAgIGNvbm5lY3Q/KCk6IHZvaWQ7XG4gICAgZGlzY29ubmVjdD8oKTogdm9pZDtcbiAgICBjb25uZWN0ZWQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNvY2tldE1lc3NhZ2U8VCA9IGFueT4gZXh0ZW5kcyBDaGFubmVsTWVzc2FnZSB7XG4gICAgZXZlbnQ/OiBzdHJpbmc7XG4gICAgcm9vbT86IHN0cmluZztcbiAgICBhY2s/OiAocmVzcG9uc2U6IGFueSkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTb2NrZXRPYnNlcnZhYmxlT3B0aW9ucyB7XG4gICAgZXZlbnRzPzogc3RyaW5nW107XG4gICAgZGVmYXVsdEV2ZW50Pzogc3RyaW5nO1xuICAgIGF1dG9Db25uZWN0PzogYm9vbGVhbjtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gU09DS0VULklPIE9CU0VSVkFCTEVcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGNsYXNzIFNvY2tldElPT2JzZXJ2YWJsZSB7XG4gICAgcHJpdmF0ZSBfc3VicyA9IG5ldyBTZXQ8T2JzZXJ2ZXI8U29ja2V0TWVzc2FnZT4+KCk7XG4gICAgcHJpdmF0ZSBfcGVuZGluZyA9IG5ldyBNYXA8c3RyaW5nLCBQZW5kaW5nUmVxdWVzdD4oKTtcbiAgICBwcml2YXRlIF9saXN0ZW5pbmcgPSBmYWxzZTtcbiAgICBwcml2YXRlIF9jbGVhbnVwczogKCgpID0+IHZvaWQpW10gPSBbXTtcbiAgICBwcml2YXRlIF9ldmVudHM6IHN0cmluZ1tdO1xuICAgIHByaXZhdGUgX2RlZmF1bHRFdmVudDogc3RyaW5nO1xuICAgIHByaXZhdGUgX3N0YXRlID0gbmV3IENoYW5uZWxTdWJqZWN0PFwiY29ubmVjdGluZ1wiIHwgXCJjb25uZWN0ZWRcIiB8IFwiZGlzY29ubmVjdGVkXCIgfCBcImVycm9yXCI+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBfc29ja2V0OiBTb2NrZXRJT0xpa2UsXG4gICAgICAgIHByaXZhdGUgX2NoYW5uZWxOYW1lOiBzdHJpbmcsXG4gICAgICAgIHByaXZhdGUgX29wdGlvbnM6IFNvY2tldE9ic2VydmFibGVPcHRpb25zID0ge31cbiAgICApIHtcbiAgICAgICAgdGhpcy5fZXZlbnRzID0gX29wdGlvbnMuZXZlbnRzID8/IFtcIm1lc3NhZ2VcIiwgXCJjaGFubmVsXCJdO1xuICAgICAgICB0aGlzLl9kZWZhdWx0RXZlbnQgPSBfb3B0aW9ucy5kZWZhdWx0RXZlbnQgPz8gXCJtZXNzYWdlXCI7XG4gICAgICAgIGlmIChfb3B0aW9ucy5hdXRvQ29ubmVjdCAhPT0gZmFsc2UpIHRoaXMuX3NvY2tldC5jb25uZWN0Py4oKTtcbiAgICB9XG5cbiAgICBzZW5kKG1zZzogU29ja2V0TWVzc2FnZSwgZXZlbnQ/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgeyB0cmFuc2ZlcmFibGUsIGFjaywgLi4uZGF0YSB9ID0gbXNnIGFzIGFueTtcbiAgICAgICAgdGhpcy5fc29ja2V0LmVtaXQoZXZlbnQgPz8gbXNnLmV2ZW50ID8/IHRoaXMuX2RlZmF1bHRFdmVudCwgZGF0YSk7XG4gICAgfVxuXG4gICAgZW1pdChldmVudDogc3RyaW5nLCBkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fc29ja2V0LmVtaXQoZXZlbnQsIGRhdGEpO1xuICAgIH1cblxuICAgIHJlcXVlc3QobXNnOiBTb2NrZXRNZXNzYWdlLCBldmVudD86IHN0cmluZyk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlcUlkID0gbXNnLnJlcUlkID8/IFVVSUR2NCgpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fcGVuZGluZy5zZXQocmVxSWQsIHsgcmVzb2x2ZSwgcmVqZWN0LCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSk7XG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BlbmRpbmcuaGFzKHJlcUlkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wZW5kaW5nLmRlbGV0ZShyZXFJZCk7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJSZXF1ZXN0IHRpbWVvdXRcIikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDMwMDAwKTtcbiAgICAgICAgICAgIGNvbnN0IHsgdHJhbnNmZXJhYmxlLCBhY2ssIC4uLmRhdGEgfSA9IHsgLi4ubXNnLCByZXFJZCB9IGFzIGFueTtcbiAgICAgICAgICAgIHRoaXMuX3NvY2tldC5lbWl0KGV2ZW50ID8/IHRoaXMuX2RlZmF1bHRFdmVudCwgZGF0YSwgKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGVuZGluZy5kZWxldGUocmVxSWQpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHN1YnNjcmliZShvYnNlcnZlcjogT2JzZXJ2ZXI8U29ja2V0TWVzc2FnZT4gfCAoKHY6IFNvY2tldE1lc3NhZ2UpID0+IHZvaWQpKTogU3Vic2NyaXB0aW9uIHtcbiAgICAgICAgY29uc3Qgb2JzOiBPYnNlcnZlcjxTb2NrZXRNZXNzYWdlPiA9IHR5cGVvZiBvYnNlcnZlciA9PT0gXCJmdW5jdGlvblwiID8geyBuZXh0OiBvYnNlcnZlciB9IDogb2JzZXJ2ZXI7XG4gICAgICAgIGNvbnN0IGZpcnN0ID0gdGhpcy5fc3Vicy5zaXplID09PSAwO1xuICAgICAgICB0aGlzLl9zdWJzLmFkZChvYnMpO1xuICAgICAgICBpZiAoZmlyc3QgJiYgIXRoaXMuX2xpc3RlbmluZykgdGhpcy5fYWN0aXZhdGUoKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNsb3NlZDogZmFsc2UsXG4gICAgICAgICAgICB1bnN1YnNjcmliZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX3N1YnMuZGVsZXRlKG9icyk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N1YnMuc2l6ZSA9PT0gMCAmJiB0aGlzLl9saXN0ZW5pbmcpIHRoaXMuX2RlYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuX2xpc3RlbmluZykgcmV0dXJuO1xuXG4gICAgICAgIGZvciAoY29uc3QgZXZlbnQgb2YgdGhpcy5fZXZlbnRzKSB7XG4gICAgICAgICAgICBjb25zdCBoYW5kbGVyID0gKGRhdGE6IGFueSwgYWNrPzogKHI6IGFueSkgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1zZzogU29ja2V0TWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uKHR5cGVvZiBkYXRhID09PSBcIm9iamVjdFwiID8gZGF0YSA6IHsgcGF5bG9hZDogZGF0YSB9KSxcbiAgICAgICAgICAgICAgICAgICAgaWQ6IGRhdGE/LmlkID8/IFVVSUR2NCgpLFxuICAgICAgICAgICAgICAgICAgICBldmVudCxcbiAgICAgICAgICAgICAgICAgICAgYWNrXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIC8vIEhhbmRsZSByZXNwb25zZVxuICAgICAgICAgICAgICAgIGlmIChtc2cudHlwZSA9PT0gXCJyZXNwb25zZVwiICYmIG1zZy5yZXFJZCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5fcGVuZGluZy5nZXQobXNnLnJlcUlkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHApIHsgcC5yZXNvbHZlKG1zZy5wYXlsb2FkKTsgdGhpcy5fcGVuZGluZy5kZWxldGUobXNnLnJlcUlkKTsgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcyBvZiB0aGlzLl9zdWJzKSB7IHRyeSB7IHMubmV4dD8uKG1zZyk7IH0gY2F0Y2ggKGUpIHsgcy5lcnJvcj8uKGUgYXMgRXJyb3IpOyB9IH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLl9zb2NrZXQub24oZXZlbnQsIGhhbmRsZXIpO1xuICAgICAgICAgICAgdGhpcy5fY2xlYW51cHMucHVzaCgoKSA9PiB0aGlzLl9zb2NrZXQub2ZmKGV2ZW50LCBoYW5kbGVyKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDb25uZWN0aW9uIGV2ZW50c1xuICAgICAgICBjb25zdCBvbkNvbm5lY3QgPSAoKSA9PiB0aGlzLl9zdGF0ZS5uZXh0KFwiY29ubmVjdGVkXCIpO1xuICAgICAgICBjb25zdCBvbkRpc2Nvbm5lY3QgPSAoKSA9PiB0aGlzLl9zdGF0ZS5uZXh0KFwiZGlzY29ubmVjdGVkXCIpO1xuICAgICAgICBjb25zdCBvbkVycm9yID0gKGVycjogYW55KSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9zdGF0ZS5uZXh0KFwiZXJyb3JcIik7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fc3Vicykgcy5lcnJvcj8uKGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyIDogbmV3IEVycm9yKFN0cmluZyhlcnIpKSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKFwiY29ubmVjdFwiLCBvbkNvbm5lY3QpO1xuICAgICAgICB0aGlzLl9zb2NrZXQub24oXCJkaXNjb25uZWN0XCIsIG9uRGlzY29ubmVjdCk7XG4gICAgICAgIHRoaXMuX3NvY2tldC5vbihcImVycm9yXCIsIG9uRXJyb3IpO1xuICAgICAgICB0aGlzLl9jbGVhbnVwcy5wdXNoKFxuICAgICAgICAgICAgKCkgPT4gdGhpcy5fc29ja2V0Lm9mZihcImNvbm5lY3RcIiwgb25Db25uZWN0KSxcbiAgICAgICAgICAgICgpID0+IHRoaXMuX3NvY2tldC5vZmYoXCJkaXNjb25uZWN0XCIsIG9uRGlzY29ubmVjdCksXG4gICAgICAgICAgICAoKSA9PiB0aGlzLl9zb2NrZXQub2ZmKFwiZXJyb3JcIiwgb25FcnJvcilcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLl9saXN0ZW5pbmcgPSB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2RlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2NsZWFudXBzLmZvckVhY2goKGZuKSA9PiBmbigpKTtcbiAgICAgICAgdGhpcy5fY2xlYW51cHMgPSBbXTtcbiAgICAgICAgdGhpcy5fbGlzdGVuaW5nID0gZmFsc2U7XG4gICAgfVxuXG4gICAgY2xvc2UoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3N1YnMuZm9yRWFjaCgocykgPT4gcy5jb21wbGV0ZT8uKCkpO1xuICAgICAgICB0aGlzLl9zdWJzLmNsZWFyKCk7XG4gICAgICAgIHRoaXMuX2RlYWN0aXZhdGUoKTtcbiAgICAgICAgdGhpcy5fc29ja2V0LmRpc2Nvbm5lY3Q/LigpO1xuICAgIH1cblxuICAgIGdldCBzb2NrZXQoKTogU29ja2V0SU9MaWtlIHsgcmV0dXJuIHRoaXMuX3NvY2tldDsgfVxuICAgIGdldCBjaGFubmVsTmFtZSgpOiBzdHJpbmcgeyByZXR1cm4gdGhpcy5fY2hhbm5lbE5hbWU7IH1cbiAgICBnZXQgaXNDb25uZWN0ZWQoKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLl9zb2NrZXQuY29ubmVjdGVkID8/IGZhbHNlOyB9XG4gICAgZ2V0IHN0YXRlKCkgeyByZXR1cm4gdGhpcy5fc3RhdGU7IH1cbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gUk9PTSBPQlNFUlZBQkxFXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBjbGFzcyBTb2NrZXRJT1Jvb21PYnNlcnZhYmxlIHtcbiAgICBwcml2YXRlIF9zdWJzID0gbmV3IFNldDxPYnNlcnZlcjxTb2NrZXRNZXNzYWdlPj4oKTtcbiAgICBwcml2YXRlIF9wYXJlbnRTdWI6IFN1YnNjcmlwdGlvbiB8IG51bGwgPSBudWxsO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgX3BhcmVudDogU29ja2V0SU9PYnNlcnZhYmxlLFxuICAgICAgICBwcml2YXRlIF9yb29tTmFtZTogc3RyaW5nXG4gICAgKSB7fVxuXG4gICAgc2VuZChtc2c6IFNvY2tldE1lc3NhZ2UpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fcGFyZW50LnNlbmQoeyAuLi5tc2csIHJvb206IHRoaXMuX3Jvb21OYW1lIH0pO1xuICAgIH1cblxuICAgIHN1YnNjcmliZShvYnNlcnZlcjogT2JzZXJ2ZXI8U29ja2V0TWVzc2FnZT4gfCAoKHY6IFNvY2tldE1lc3NhZ2UpID0+IHZvaWQpKTogU3Vic2NyaXB0aW9uIHtcbiAgICAgICAgY29uc3Qgb2JzOiBPYnNlcnZlcjxTb2NrZXRNZXNzYWdlPiA9IHR5cGVvZiBvYnNlcnZlciA9PT0gXCJmdW5jdGlvblwiID8geyBuZXh0OiBvYnNlcnZlciB9IDogb2JzZXJ2ZXI7XG4gICAgICAgIGNvbnN0IGZpcnN0ID0gdGhpcy5fc3Vicy5zaXplID09PSAwO1xuICAgICAgICB0aGlzLl9zdWJzLmFkZChvYnMpO1xuXG4gICAgICAgIGlmIChmaXJzdCAmJiAhdGhpcy5fcGFyZW50U3ViKSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJlbnRTdWIgPSB0aGlzLl9wYXJlbnQuc3Vic2NyaWJlKHtcbiAgICAgICAgICAgICAgICBuZXh0OiAobXNnKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtc2cucm9vbSA9PT0gdGhpcy5fcm9vbU5hbWUgfHwgbXNnLmNoYW5uZWwgPT09IHRoaXMuX3Jvb21OYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fc3VicykgeyB0cnkgeyBzLm5leHQ/Lihtc2cpOyB9IGNhdGNoIChlKSB7IHMuZXJyb3I/LihlIGFzIEVycm9yKTsgfSB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVycm9yOiAoZSkgPT4geyBmb3IgKGNvbnN0IHMgb2YgdGhpcy5fc3Vicykgcy5lcnJvcj8uKGUpOyB9LFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlOiAoKSA9PiB7IGZvciAoY29uc3QgcyBvZiB0aGlzLl9zdWJzKSBzLmNvbXBsZXRlPy4oKTsgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY2xvc2VkOiBmYWxzZSxcbiAgICAgICAgICAgIHVuc3Vic2NyaWJlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3Vicy5kZWxldGUob2JzKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc3Vicy5zaXplID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudFN1Yj8udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50U3ViID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZ2V0IHJvb21OYW1lKCk6IHN0cmluZyB7IHJldHVybiB0aGlzLl9yb29tTmFtZTsgfVxufVxuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBSRVFVRVNUIEhBTkRMRVJcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVNvY2tldFJlcXVlc3RIYW5kbGVyKFxuICAgIGNoYW5uZWxOYW1lOiBzdHJpbmcsXG4gICAgaGFuZGxlcnM6IFJlY29yZDxzdHJpbmcsIChhcmdzOiBhbnlbXSwgZGF0YTogU29ja2V0TWVzc2FnZSkgPT4gYW55IHwgUHJvbWlzZTxhbnk+PlxuKTogKGRhdGE6IFNvY2tldE1lc3NhZ2UpID0+IHZvaWQge1xuICAgIHJldHVybiBhc3luYyAoZGF0YSkgPT4ge1xuICAgICAgICBpZiAoZGF0YS50eXBlICE9PSBcInJlcXVlc3RcIiB8fCAhZGF0YS5hY2spIHJldHVybjtcbiAgICAgICAgY29uc3QgYWN0aW9uID0gZGF0YS5wYXlsb2FkPy5hY3Rpb247XG4gICAgICAgIGlmIChhY3Rpb24gJiYgaGFuZGxlcnNbYWN0aW9uXSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyc1thY3Rpb25dKGRhdGEucGF5bG9hZD8uYXJncyA/PyBbXSwgZGF0YSk7XG4gICAgICAgICAgICAgICAgZGF0YS5hY2soeyBpZDogVVVJRHY0KCksIGNoYW5uZWw6IGRhdGEuc2VuZGVyLCBzZW5kZXI6IGNoYW5uZWxOYW1lLCByZXFJZDogZGF0YS5yZXFJZCwgdHlwZTogXCJyZXNwb25zZVwiLCBwYXlsb2FkOiB7IHJlc3VsdCB9LCB0aW1lc3RhbXA6IERhdGUubm93KCkgfSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGRhdGEuYWNrKHsgaWQ6IFVVSUR2NCgpLCBjaGFubmVsOiBkYXRhLnNlbmRlciwgc2VuZGVyOiBjaGFubmVsTmFtZSwgcmVxSWQ6IGRhdGEucmVxSWQsIHR5cGU6IFwicmVzcG9uc2VcIiwgcGF5bG9hZDogeyBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpIH0sIHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEZBQ1RPUllcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGNvbnN0IFNvY2tldElPT2JzZXJ2YWJsZUZhY3RvcnkgPSB7XG4gICAgY3JlYXRlOiAoc29ja2V0OiBTb2NrZXRJT0xpa2UsIGNoYW5uZWxOYW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBTb2NrZXRPYnNlcnZhYmxlT3B0aW9ucykgPT5cbiAgICAgICAgbmV3IFNvY2tldElPT2JzZXJ2YWJsZShzb2NrZXQsIGNoYW5uZWxOYW1lLCBvcHRpb25zKSxcbiAgICByb29tOiAocGFyZW50OiBTb2NrZXRJT09ic2VydmFibGUsIHJvb21OYW1lOiBzdHJpbmcpID0+XG4gICAgICAgIG5ldyBTb2NrZXRJT1Jvb21PYnNlcnZhYmxlKHBhcmVudCwgcm9vbU5hbWUpXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU29ja2V0T2JzZXJ2YWJsZShcbiAgICBzb2NrZXQ6IFNvY2tldElPTGlrZSxcbiAgICBjaGFubmVsTmFtZTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBTb2NrZXRPYnNlcnZhYmxlT3B0aW9uc1xuKTogU29ja2V0SU9PYnNlcnZhYmxlIHtcbiAgICByZXR1cm4gbmV3IFNvY2tldElPT2JzZXJ2YWJsZShzb2NrZXQsIGNoYW5uZWxOYW1lLCBvcHRpb25zKTtcbn1cbiJdfQ==