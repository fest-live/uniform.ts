const runtimeListenerRegistry = new Map();
let runtimeListenerInstalled = false;
const ensureRuntimeListener = () => {
    if (runtimeListenerInstalled)
        return;
    runtimeListenerInstalled = true;
    chrome?.runtime?.onMessage?.addListener?.((message, sender, sendResponse) => {
        const channelName = (message?.channelName ?? message?.target);
        if (!channelName)
            return;
        const listeners = runtimeListenerRegistry.get(channelName);
        if (!listeners || listeners.size === 0)
            return;
        const event = {
            data: message,
            origin: sender?.url || "chrome-extension",
            source: sender
        };
        // Dispatch (sync or async). Returning true keeps sendResponse alive.
        for (const listener of listeners) {
            try {
                const out = listener(event, sender, sendResponse);
                // avoid unhandled rejections on async listeners
                if (out && typeof out?.catch === "function") {
                    out.catch((error) => console.error("[ChromeExtensionBroadcastChannel] Listener error:", error));
                }
            }
            catch (error) {
                console.error("[ChromeExtensionBroadcastChannel] Listener error:", error);
            }
        }
        return true;
    });
};
/**
 * Chrome Extension Broadcast-like Channel
 * Acts like a BroadcastChannel but uses chrome.runtime messaging
 */
export class ChromeExtensionBroadcastChannel {
    channelName;
    listeners = new Set();
    constructor(channelName) {
        this.channelName = channelName;
        ensureRuntimeListener();
    }
    addEventListener(type, listener) {
        if (type !== "message")
            return;
        this.listeners.add(listener);
        let set = runtimeListenerRegistry.get(this.channelName);
        if (!set) {
            set = new Set();
            runtimeListenerRegistry.set(this.channelName, set);
        }
        set.add(listener);
    }
    removeEventListener(type, listener) {
        if (type !== "message")
            return;
        this.listeners.delete(listener);
        runtimeListenerRegistry.get(this.channelName)?.delete(listener);
    }
    postMessage(message) {
        const messageWithChannel = {
            ...message,
            channelName: this.channelName,
            source: "broadcast-channel"
        };
        // Send via chrome runtime messaging (ignore response)
        chrome?.runtime?.sendMessage?.(messageWithChannel, () => void 0);
    }
    close() {
        for (const listener of this.listeners) {
            runtimeListenerRegistry.get(this.channelName)?.delete(listener);
        }
        this.listeners.clear();
    }
}
/**
 * Unified Chrome Extension Tabs Channel
 * Acts like a BroadcastChannel but uses chrome.tabs messaging to communicate with content scripts
 * Supports both broadcast-to-multiple-tabs and current-tab-only targeting
 */
export class ChromeExtensionTabsChannel {
    wrappedByOriginal = new Map();
    wrappedListeners = new Set();
    channelName;
    mode = 'broadcast';
    tabFilter;
    tabIdGetter;
    constructor(channelName, options) {
        this.channelName = channelName;
        this.mode = options?.mode || 'broadcast';
        this.tabFilter = options?.tabFilter;
        this.tabIdGetter = options?.tabIdGetter || this.getCurrentTabId;
        this.startListening();
    }
    startListening() {
        ensureRuntimeListener();
        // No per-instance chrome.runtime.onMessage listener here; we reuse the global runtime listener.
        // Filtering by tab is handled in our instance-level handler below.
    }
    addEventListener(type, listener) {
        if (type !== "message")
            return;
        const existing = this.wrappedByOriginal.get(listener);
        if (existing)
            return;
        const wrapped = async (event, sender, sendResponse) => {
            const message = event?.data;
            if (!sender?.tab)
                return;
            // For current-tab mode, verify this is from our target tab
            if (this.mode === "current-tab") {
                const targetTabId = await this.tabIdGetter?.();
                if (typeof targetTabId === "number" && sender.tab.id !== targetTabId)
                    return;
            }
            // For broadcast mode, apply tab filter if specified
            if (this.mode === "broadcast" && this.tabFilter && !this.tabFilter(sender.tab))
                return;
            const enhancedEvent = {
                ...event,
                origin: sender.url || "chrome-extension-tab",
                tab: sender.tab
            };
            return listener(enhancedEvent, sender, sendResponse);
        };
        this.wrappedByOriginal.set(listener, wrapped);
        this.wrappedListeners.add(wrapped);
        let set = runtimeListenerRegistry.get(this.channelName);
        if (!set) {
            set = new Set();
            runtimeListenerRegistry.set(this.channelName, set);
        }
        set.add(wrapped);
    }
    removeEventListener(type, listener) {
        if (type !== "message")
            return;
        const wrapped = this.wrappedByOriginal.get(listener);
        if (!wrapped)
            return;
        this.wrappedByOriginal.delete(listener);
        this.wrappedListeners.delete(wrapped);
        runtimeListenerRegistry.get(this.channelName)?.delete(wrapped);
    }
    /**
     * Send message to specific tab
     */
    sendToTab(tabId, message) {
        const messageWithChannel = {
            channelName: this.channelName,
            source: 'tabs-channel',
            ...message
        };
        return new Promise((resolve, reject) => {
            chrome?.tabs?.sendMessage?.(tabId, messageWithChannel, (response) => {
                if (chrome?.runtime?.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                }
                else {
                    resolve(response);
                }
            });
        });
    }
    /**
     * Send message to active/current tab
     */
    async sendToActiveTab(message) {
        if (this.mode === 'current-tab' && this.tabIdGetter) {
            // Use the configured tab ID getter
            const tabId = await this.tabIdGetter();
            return this.sendToTab(tabId, message);
        }
        else {
            // Fallback to querying active tab
            const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
            if (tabs.length === 0) {
                throw new Error('No active tab found');
            }
            return this.sendToTab(tabs[0].id, message);
        }
    }
    /**
     * Broadcast message to all matching tabs (only works in broadcast mode)
     */
    async broadcastToTabs(message, options) {
        if (this.mode === 'current-tab') {
            // In current-tab mode, broadcast is just sending to the current tab
            try {
                const response = await this.sendToActiveTab(message);
                return [{ tabId: await this.tabIdGetter(), response }];
            }
            catch (error) {
                return [{ error }];
            }
        }
        // Broadcast mode - send to multiple tabs
        const query = {
            status: 'complete'
        };
        if (!options?.allWindows) {
            query.currentWindow = true;
        }
        const tabs = await chrome.tabs.query(query);
        const targetTabs = tabs.filter(tab => {
            // Apply custom filter if provided
            if (options?.tabFilter && !options.tabFilter(tab))
                return false;
            // Apply instance filter
            if (this.tabFilter && !this.tabFilter(tab))
                return false;
            return true;
        });
        const messageWithChannel = {
            channelName: this.channelName,
            source: 'tabs-channel',
            ...message
        };
        const promises = targetTabs.map(tab => new Promise((resolve, reject) => {
            chrome?.tabs?.sendMessage?.(tab.id, messageWithChannel, (response) => {
                if (chrome?.runtime?.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                }
                else {
                    resolve({ tabId: tab.id, response });
                }
            });
        }));
        return Promise.allSettled(promises);
    }
    /**
     * Send message via chrome runtime (for service worker communication)
     */
    async postMessage(message) {
        const tabId = await this.tabIdGetter();
        const messageWithChannel = {
            channelName: this.channelName,
            source: 'tabs-channel',
            ...message
        };
        // Send via chrome.tabs messaging (ignore response)
        return chrome?.tabs?.sendMessage?.(tabId, messageWithChannel, () => void 0);
    }
    /**
     * Get current tab ID (convenience method)
     */
    async getCurrentTabId() {
        if (this.tabIdGetter) {
            return await this.tabIdGetter();
        }
        return 0;
    }
    close() {
        for (const wrapped of this.wrappedListeners) {
            runtimeListenerRegistry.get(this.channelName)?.delete(wrapped);
        }
        this.wrappedListeners.clear();
        this.wrappedByOriginal.clear();
    }
}
/**
 * Chrome Extension Port Channel
 * Adapts chrome.runtime.Port into a BroadcastChannel-like interface.
 */
export class ChromeExtensionPortChannel {
    port;
    channelName;
    listeners = new Set();
    constructor(port, channelName) {
        this.port = port;
        this.channelName = channelName;
        this.port?.onMessage?.addListener?.((message) => {
            if ((message?.channelName ?? message?.target) !== this.channelName)
                return;
            const event = { data: message, origin: "chrome-extension-port", source: this.port };
            for (const listener of this.listeners) {
                try {
                    listener(event);
                }
                catch (error) {
                    console.error("[ChromeExtensionPortChannel] Listener error:", error);
                }
            }
        });
    }
    addEventListener(type, listener) {
        if (type !== "message")
            return;
        this.listeners.add(listener);
    }
    removeEventListener(type, listener) {
        if (type !== "message")
            return;
        this.listeners.delete(listener);
    }
    postMessage(message) {
        this.port?.postMessage?.({
            ...message,
            channelName: this.channelName,
            source: "port-channel"
        });
    }
    close() {
        this.listeners.clear();
        this.port?.disconnect?.();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV3JhcHBlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJXcmFwcGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxNQUFNLHVCQUF1QixHQUFHLElBQUksR0FBRyxFQUE0QixDQUFDO0FBQ3BFLElBQUksd0JBQXdCLEdBQUcsS0FBSyxDQUFDO0FBRXJDLE1BQU0scUJBQXFCLEdBQUcsR0FBRyxFQUFFO0lBQy9CLElBQUksd0JBQXdCO1FBQUUsT0FBTztJQUNyQyx3QkFBd0IsR0FBRyxJQUFJLENBQUM7SUFFaEMsTUFBTSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxPQUFZLEVBQUUsTUFBaUIsRUFBRSxZQUE2QixFQUFFLEVBQUU7UUFDekcsTUFBTSxXQUFXLEdBQUcsQ0FBQyxPQUFPLEVBQUUsV0FBVyxJQUFJLE9BQU8sRUFBRSxNQUFNLENBQXVCLENBQUM7UUFDcEYsSUFBSSxDQUFDLFdBQVc7WUFBRSxPQUFPO1FBRXpCLE1BQU0sU0FBUyxHQUFHLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxJQUFJLEtBQUssQ0FBQztZQUFFLE9BQU87UUFFL0MsTUFBTSxLQUFLLEdBQUc7WUFDVixJQUFJLEVBQUUsT0FBTztZQUNiLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLGtCQUFrQjtZQUN6QyxNQUFNLEVBQUUsTUFBTTtTQUNqQixDQUFDO1FBRUYscUVBQXFFO1FBQ3JFLEtBQUssTUFBTSxRQUFRLElBQUksU0FBUyxFQUFFLENBQUM7WUFDL0IsSUFBSSxDQUFDO2dCQUNELE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUNsRCxnREFBZ0Q7Z0JBQ2hELElBQUksR0FBRyxJQUFJLE9BQVEsR0FBVyxFQUFFLEtBQUssS0FBSyxVQUFVLEVBQUUs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RSxDQUFDO0lBQzlCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbInR5cGUgQ3J4U2VuZGVyID0gY2hyb21lLnJ1bnRpbWUuTWVzc2FnZVNlbmRlcjtcbnR5cGUgQ3J4U2VuZFJlc3BvbnNlID0gKHJlc3BvbnNlOiBhbnkpID0+IHZvaWQ7XG50eXBlIENyeExpc3RlbmVyID0gKGV2ZW50OiBhbnksIHNlbmRlcjogQ3J4U2VuZGVyLCBzZW5kUmVzcG9uc2U6IENyeFNlbmRSZXNwb25zZSkgPT4gdm9pZCB8IFByb21pc2U8dm9pZD47XG5cbmNvbnN0IHJ1bnRpbWVMaXN0ZW5lclJlZ2lzdHJ5ID0gbmV3IE1hcDxzdHJpbmcsIFNldDxDcnhMaXN0ZW5lcj4+KCk7XG5sZXQgcnVudGltZUxpc3RlbmVySW5zdGFsbGVkID0gZmFsc2U7XG5cbmNvbnN0IGVuc3VyZVJ1bnRpbWVMaXN0ZW5lciA9ICgpID0+IHtcbiAgICBpZiAocnVudGltZUxpc3RlbmVySW5zdGFsbGVkKSByZXR1cm47XG4gICAgcnVudGltZUxpc3RlbmVySW5zdGFsbGVkID0gdHJ1ZTtcblxuICAgIGNocm9tZT8ucnVudGltZT8ub25NZXNzYWdlPy5hZGRMaXN0ZW5lcj8uKChtZXNzYWdlOiBhbnksIHNlbmRlcjogQ3J4U2VuZGVyLCBzZW5kUmVzcG9uc2U6IENyeFNlbmRSZXNwb25zZSkgPT4ge1xuICAgICAgICBjb25zdCBjaGFubmVsTmFtZSA9IChtZXNzYWdlPy5jaGFubmVsTmFtZSA/PyBtZXNzYWdlPy50YXJnZXQpIGFzIHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKCFjaGFubmVsTmFtZSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGxpc3RlbmVycyA9IHJ1bnRpbWVMaXN0ZW5lclJlZ2lzdHJ5LmdldChjaGFubmVsTmFtZSk7XG4gICAgICAgIGlmICghbGlzdGVuZXJzIHx8IGxpc3RlbmVycy5zaXplID09PSAwKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgZXZlbnQgPSB7XG4gICAgICAgICAgICBkYXRhOiBtZXNzYWdlLFxuICAgICAgICAgICAgb3JpZ2luOiBzZW5kZXI/LnVybCB8fCBcImNocm9tZS1leHRlbnNpb25cIixcbiAgICAgICAgICAgIHNvdXJjZTogc2VuZGVyXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gRGlzcGF0Y2ggKHN5bmMgb3IgYXN5bmMpLiBSZXR1cm5pbmcgdHJ1ZSBrZWVwcyBzZW5kUmVzcG9uc2UgYWxpdmUuXG4gICAgICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgbGlzdGVuZXJzKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG91dCA9IGxpc3RlbmVyKGV2ZW50LCBzZW5kZXIsIHNlbmRSZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgLy8gYXZvaWQgdW5oYW5kbGVkIHJlamVjdGlvbnMgb24gYXN5bmMgbGlzdGVuZXJzXG4gICAgICAgICAgICAgICAgaWYgKG91dCAmJiB0eXBlb2YgKG91dCBhcyBhbnkpPy5jYXRjaCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIChvdXQgYXMgUHJvbWlzZTx2b2lkPikuY2F0Y2goKGVycm9yKSA9PiBjb25zb2xlLmVycm9yKFwiW0Nocm9tZUV4dGVuc2lvbkJyb2FkY2FzdENoYW5uZWxdIExpc3RlbmVyIGVycm9yOlwiLCBlcnJvcikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIltDaHJvbWVFeHRlbnNpb25Ccm9hZGNhc3RDaGFubmVsXSBMaXN0ZW5lciBlcnJvcjpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSk7XG59O1xuXG4vKipcbiAqIENocm9tZSBFeHRlbnNpb24gQnJvYWRjYXN0LWxpa2UgQ2hhbm5lbFxuICogQWN0cyBsaWtlIGEgQnJvYWRjYXN0Q2hhbm5lbCBidXQgdXNlcyBjaHJvbWUucnVudGltZSBtZXNzYWdpbmdcbiAqL1xuZXhwb3J0IGNsYXNzIENocm9tZUV4dGVuc2lvbkJyb2FkY2FzdENoYW5uZWwge1xuICAgIHByaXZhdGUgbGlzdGVuZXJzOiBTZXQ8Q3J4TGlzdGVuZXI+ID0gbmV3IFNldCgpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjaGFubmVsTmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGVuc3VyZVJ1bnRpbWVMaXN0ZW5lcigpO1xuICAgIH1cblxuICAgIGFkZEV2ZW50TGlzdGVuZXIodHlwZTogXCJtZXNzYWdlXCIsIGxpc3RlbmVyOiAoZXZlbnQ6IGFueSwgc2VuZGVyOiBDcnhTZW5kZXIsIHNlbmRSZXNwb25zZTogQ3J4U2VuZFJlc3BvbnNlKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPikge1xuICAgICAgICBpZiAodHlwZSAhPT0gXCJtZXNzYWdlXCIpIHJldHVybjtcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuYWRkKGxpc3RlbmVyKTtcbiAgICAgICAgbGV0IHNldCA9IHJ1bnRpbWVMaXN0ZW5lclJlZ2lzdHJ5LmdldCh0aGlzLmNoYW5uZWxOYW1lKTtcbiAgICAgICAgaWYgKCFzZXQpIHtcbiAgICAgICAgICAgIHNldCA9IG5ldyBTZXQoKTtcbiAgICAgICAgICAgIHJ1bnRpbWVMaXN0ZW5lclJlZ2lzdHJ5LnNldCh0aGlzLmNoYW5uZWxOYW1lLCBzZXQpO1xuICAgICAgICB9XG4gICAgICAgIHNldC5hZGQobGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZTogXCJtZXNzYWdlXCIsIGxpc3RlbmVyOiAoZXZlbnQ6IGFueSwgc2VuZGVyOiBDcnhTZW5kZXIsIHNlbmRSZXNwb25zZTogQ3J4U2VuZFJlc3BvbnNlKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPikge1xuICAgICAgICBpZiAodHlwZSAhPT0gXCJtZXNzYWdlXCIpIHJldHVybjtcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVyKTtcbiAgICAgICAgcnVudGltZUxpc3RlbmVyUmVnaXN0cnkuZ2V0KHRoaXMuY2hhbm5lbE5hbWUpPy5kZWxldGUobGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHBvc3RNZXNzYWdlKG1lc3NhZ2U6IGFueSkge1xuICAgICAgICBjb25zdCBtZXNzYWdlV2l0aENoYW5uZWwgPSB7XG4gICAgICAgICAgICAuLi5tZXNzYWdlLFxuICAgICAgICAgICAgY2hhbm5lbE5hbWU6IHRoaXMuY2hhbm5lbE5hbWUsXG4gICAgICAgICAgICBzb3VyY2U6IFwiYnJvYWRjYXN0LWNoYW5uZWxcIlxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFNlbmQgdmlhIGNocm9tZSBydW50aW1lIG1lc3NhZ2luZyAoaWdub3JlIHJlc3BvbnNlKVxuICAgICAgICBjaHJvbWU/LnJ1bnRpbWU/LnNlbmRNZXNzYWdlPy4obWVzc2FnZVdpdGhDaGFubmVsLCAoKSA9PiB2b2lkIDApO1xuICAgIH1cblxuICAgIGNsb3NlKCkge1xuICAgICAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMubGlzdGVuZXJzKSB7XG4gICAgICAgICAgICBydW50aW1lTGlzdGVuZXJSZWdpc3RyeS5nZXQodGhpcy5jaGFubmVsTmFtZSk/LmRlbGV0ZShsaXN0ZW5lcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuY2xlYXIoKTtcbiAgICB9XG59XG5cbi8qKlxuICogVW5pZmllZCBDaHJvbWUgRXh0ZW5zaW9uIFRhYnMgQ2hhbm5lbFxuICogQWN0cyBsaWtlIGEgQnJvYWRjYXN0Q2hhbm5lbCBidXQgdXNlcyBjaHJvbWUudGFicyBtZXNzYWdpbmcgdG8gY29tbXVuaWNhdGUgd2l0aCBjb250ZW50IHNjcmlwdHNcbiAqIFN1cHBvcnRzIGJvdGggYnJvYWRjYXN0LXRvLW11bHRpcGxlLXRhYnMgYW5kIGN1cnJlbnQtdGFiLW9ubHkgdGFyZ2V0aW5nXG4gKi9cbmV4cG9ydCBjbGFzcyBDaHJvbWVFeHRlbnNpb25UYWJzQ2hhbm5lbCB7XG4gICAgcHJpdmF0ZSB3cmFwcGVkQnlPcmlnaW5hbCA9IG5ldyBNYXA8Q3J4TGlzdGVuZXIsIENyeExpc3RlbmVyPigpO1xuICAgIHByaXZhdGUgd3JhcHBlZExpc3RlbmVyczogU2V0PENyeExpc3RlbmVyPiA9IG5ldyBTZXQoKTtcbiAgICBwcml2YXRlIGNoYW5uZWxOYW1lOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBtb2RlOiAnYnJvYWRjYXN0JyB8ICdjdXJyZW50LXRhYicgPSAnYnJvYWRjYXN0JztcbiAgICBwcml2YXRlIHRhYkZpbHRlcj86ICh0YWI6IGNocm9tZS50YWJzLlRhYikgPT4gYm9vbGVhbjtcbiAgICBwcml2YXRlIHRhYklkR2V0dGVyPzogKCkgPT4gUHJvbWlzZTxudW1iZXI+IHwgbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoY2hhbm5lbE5hbWU6IHN0cmluZywgb3B0aW9ucz86IHtcbiAgICAgICAgbW9kZT86ICdicm9hZGNhc3QnIHwgJ2N1cnJlbnQtdGFiJztcbiAgICAgICAgdGFiRmlsdGVyPzogKHRhYjogY2hyb21lLnRhYnMuVGFiKSA9PiBib29sZWFuO1xuICAgICAgICB0YWJJZEdldHRlcj86ICgpID0+IFByb21pc2U8bnVtYmVyPiB8IG51bWJlcjtcbiAgICB9KSB7XG4gICAgICAgIHRoaXMuY2hhbm5lbE5hbWUgPSBjaGFubmVsTmFtZTtcbiAgICAgICAgdGhpcy5tb2RlID0gb3B0aW9ucz8ubW9kZSB8fCAnYnJvYWRjYXN0JztcbiAgICAgICAgdGhpcy50YWJGaWx0ZXIgPSBvcHRpb25zPy50YWJGaWx0ZXI7XG4gICAgICAgIHRoaXMudGFiSWRHZXR0ZXIgPSBvcHRpb25zPy50YWJJZEdldHRlciB8fCB0aGlzLmdldEN1cnJlbnRUYWJJZDtcbiAgICAgICAgdGhpcy5zdGFydExpc3RlbmluZygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRMaXN0ZW5pbmcoKSB7XG4gICAgICAgIGVuc3VyZVJ1bnRpbWVMaXN0ZW5lcigpO1xuXG4gICAgICAgIC8vIE5vIHBlci1pbnN0YW5jZSBjaHJvbWUucnVudGltZS5vbk1lc3NhZ2UgbGlzdGVuZXIgaGVyZTsgd2UgcmV1c2UgdGhlIGdsb2JhbCBydW50aW1lIGxpc3RlbmVyLlxuICAgICAgICAvLyBGaWx0ZXJpbmcgYnkgdGFiIGlzIGhhbmRsZWQgaW4gb3VyIGluc3RhbmNlLWxldmVsIGhhbmRsZXIgYmVsb3cuXG4gICAgfVxuXG4gICAgYWRkRXZlbnRMaXN0ZW5lcih0eXBlOiBcIm1lc3NhZ2VcIiwgbGlzdGVuZXI6IENyeExpc3RlbmVyKSB7XG4gICAgICAgIGlmICh0eXBlICE9PSBcIm1lc3NhZ2VcIikgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy53cmFwcGVkQnlPcmlnaW5hbC5nZXQobGlzdGVuZXIpO1xuICAgICAgICBpZiAoZXhpc3RpbmcpIHJldHVybjtcblxuICAgICAgICBjb25zdCB3cmFwcGVkOiBDcnhMaXN0ZW5lciA9IGFzeW5jIChldmVudCwgc2VuZGVyLCBzZW5kUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBldmVudD8uZGF0YTtcbiAgICAgICAgICAgIGlmICghc2VuZGVyPy50YWIpIHJldHVybjtcblxuICAgICAgICAgICAgLy8gRm9yIGN1cnJlbnQtdGFiIG1vZGUsIHZlcmlmeSB0aGlzIGlzIGZyb20gb3VyIHRhcmdldCB0YWJcbiAgICAgICAgICAgIGlmICh0aGlzLm1vZGUgPT09IFwiY3VycmVudC10YWJcIikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFRhYklkID0gYXdhaXQgdGhpcy50YWJJZEdldHRlcj8uKCk7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRUYWJJZCA9PT0gXCJudW1iZXJcIiAmJiBzZW5kZXIudGFiLmlkICE9PSB0YXJnZXRUYWJJZCkgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBGb3IgYnJvYWRjYXN0IG1vZGUsIGFwcGx5IHRhYiBmaWx0ZXIgaWYgc3BlY2lmaWVkXG4gICAgICAgICAgICBpZiAodGhpcy5tb2RlID09PSBcImJyb2FkY2FzdFwiICYmIHRoaXMudGFiRmlsdGVyICYmICF0aGlzLnRhYkZpbHRlcihzZW5kZXIudGFiKSkgcmV0dXJuO1xuXG4gICAgICAgICAgICBjb25zdCBlbmhhbmNlZEV2ZW50ID0ge1xuICAgICAgICAgICAgICAgIC4uLmV2ZW50LFxuICAgICAgICAgICAgICAgIG9yaWdpbjogc2VuZGVyLnVybCB8fCBcImNocm9tZS1leHRlbnNpb24tdGFiXCIsXG4gICAgICAgICAgICAgICAgdGFiOiBzZW5kZXIudGFiXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZXR1cm4gbGlzdGVuZXIoZW5oYW5jZWRFdmVudCwgc2VuZGVyLCBzZW5kUmVzcG9uc2UpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMud3JhcHBlZEJ5T3JpZ2luYWwuc2V0KGxpc3RlbmVyLCB3cmFwcGVkKTtcbiAgICAgICAgdGhpcy53cmFwcGVkTGlzdGVuZXJzLmFkZCh3cmFwcGVkKTtcbiAgICAgICAgbGV0IHNldCA9IHJ1bnRpbWVMaXN0ZW5lclJlZ2lzdHJ5LmdldCh0aGlzLmNoYW5uZWxOYW1lKTtcbiAgICAgICAgaWYgKCFzZXQpIHtcbiAgICAgICAgICAgIHNldCA9IG5ldyBTZXQoKTtcbiAgICAgICAgICAgIHJ1bnRpbWVMaXN0ZW5lclJlZ2lzdHJ5LnNldCh0aGlzLmNoYW5uZWxOYW1lLCBzZXQpO1xuICAgICAgICB9XG4gICAgICAgIHNldC5hZGQod3JhcHBlZCk7XG4gICAgfVxuXG4gICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlOiBcIm1lc3NhZ2VcIiwgbGlzdGVuZXI6IENyeExpc3RlbmVyKSB7XG4gICAgICAgIGlmICh0eXBlICE9PSBcIm1lc3NhZ2VcIikgcmV0dXJuO1xuICAgICAgICBjb25zdCB3cmFwcGVkID0gdGhpcy53cmFwcGVkQnlPcmlnaW5hbC5nZXQobGlzdGVuZXIpO1xuICAgICAgICBpZiAoIXdyYXBwZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy53cmFwcGVkQnlPcmlnaW5hbC5kZWxldGUobGlzdGVuZXIpO1xuICAgICAgICB0aGlzLndyYXBwZWRMaXN0ZW5lcnMuZGVsZXRlKHdyYXBwZWQpO1xuICAgICAgICBydW50aW1lTGlzdGVuZXJSZWdpc3RyeS5nZXQodGhpcy5jaGFubmVsTmFtZSk/LmRlbGV0ZSh3cmFwcGVkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZW5kIG1lc3NhZ2UgdG8gc3BlY2lmaWMgdGFiXG4gICAgICovXG4gICAgc2VuZFRvVGFiKHRhYklkOiBudW1iZXIsIG1lc3NhZ2U6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2VXaXRoQ2hhbm5lbCA9IHtcbiAgICAgICAgICAgIGNoYW5uZWxOYW1lOiB0aGlzLmNoYW5uZWxOYW1lLFxuICAgICAgICAgICAgc291cmNlOiAndGFicy1jaGFubmVsJyxcbiAgICAgICAgICAgIC4uLm1lc3NhZ2VcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY2hyb21lPy50YWJzPy5zZW5kTWVzc2FnZT8uKHRhYklkLCBtZXNzYWdlV2l0aENoYW5uZWwsIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjaHJvbWU/LnJ1bnRpbWU/Lmxhc3RFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGNocm9tZS5ydW50aW1lLmxhc3RFcnJvci5tZXNzYWdlKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlbmQgbWVzc2FnZSB0byBhY3RpdmUvY3VycmVudCB0YWJcbiAgICAgKi9cbiAgICBhc3luYyBzZW5kVG9BY3RpdmVUYWIobWVzc2FnZTogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgaWYgKHRoaXMubW9kZSA9PT0gJ2N1cnJlbnQtdGFiJyAmJiB0aGlzLnRhYklkR2V0dGVyKSB7XG4gICAgICAgICAgICAvLyBVc2UgdGhlIGNvbmZpZ3VyZWQgdGFiIElEIGdldHRlclxuICAgICAgICAgICAgY29uc3QgdGFiSWQgPSBhd2FpdCB0aGlzLnRhYklkR2V0dGVyKCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZW5kVG9UYWIodGFiSWQsIG1lc3NhZ2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gcXVlcnlpbmcgYWN0aXZlIHRhYlxuICAgICAgICAgICAgY29uc3QgdGFicyA9IGF3YWl0IGNocm9tZS50YWJzLnF1ZXJ5KHsgYWN0aXZlOiB0cnVlLCBjdXJyZW50V2luZG93OiB0cnVlIH0pO1xuICAgICAgICAgICAgaWYgKHRhYnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBhY3RpdmUgdGFiIGZvdW5kJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZW5kVG9UYWIodGFic1swXS5pZCEsIG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQnJvYWRjYXN0IG1lc3NhZ2UgdG8gYWxsIG1hdGNoaW5nIHRhYnMgKG9ubHkgd29ya3MgaW4gYnJvYWRjYXN0IG1vZGUpXG4gICAgICovXG4gICAgYXN5bmMgYnJvYWRjYXN0VG9UYWJzKG1lc3NhZ2U6IGFueSwgb3B0aW9ucz86IHsgYWxsV2luZG93cz86IGJvb2xlYW47IHRhYkZpbHRlcj86ICh0YWI6IGNocm9tZS50YWJzLlRhYikgPT4gYm9vbGVhbiB9KTogUHJvbWlzZTxhbnlbXT4ge1xuICAgICAgICBpZiAodGhpcy5tb2RlID09PSAnY3VycmVudC10YWInKSB7XG4gICAgICAgICAgICAvLyBJbiBjdXJyZW50LXRhYiBtb2RlLCBicm9hZGNhc3QgaXMganVzdCBzZW5kaW5nIHRvIHRoZSBjdXJyZW50IHRhYlxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZFRvQWN0aXZlVGFiKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbeyB0YWJJZDogYXdhaXQgdGhpcy50YWJJZEdldHRlciEoKSwgcmVzcG9uc2UgfV07XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHJldHVybiBbeyBlcnJvciB9XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEJyb2FkY2FzdCBtb2RlIC0gc2VuZCB0byBtdWx0aXBsZSB0YWJzXG4gICAgICAgIGNvbnN0IHF1ZXJ5OiBjaHJvbWUudGFicy5RdWVyeUluZm8gPSB7XG4gICAgICAgICAgICBzdGF0dXM6ICdjb21wbGV0ZSdcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAoIW9wdGlvbnM/LmFsbFdpbmRvd3MpIHtcbiAgICAgICAgICAgIHF1ZXJ5LmN1cnJlbnRXaW5kb3cgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGFicyA9IGF3YWl0IGNocm9tZS50YWJzLnF1ZXJ5KHF1ZXJ5KTtcbiAgICAgICAgY29uc3QgdGFyZ2V0VGFicyA9IHRhYnMuZmlsdGVyKHRhYiA9PiB7XG4gICAgICAgICAgICAvLyBBcHBseSBjdXN0b20gZmlsdGVyIGlmIHByb3ZpZGVkXG4gICAgICAgICAgICBpZiAob3B0aW9ucz8udGFiRmlsdGVyICYmICFvcHRpb25zLnRhYkZpbHRlcih0YWIpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAvLyBBcHBseSBpbnN0YW5jZSBmaWx0ZXJcbiAgICAgICAgICAgIGlmICh0aGlzLnRhYkZpbHRlciAmJiAhdGhpcy50YWJGaWx0ZXIodGFiKSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IG1lc3NhZ2VXaXRoQ2hhbm5lbCA9IHtcbiAgICAgICAgICAgIGNoYW5uZWxOYW1lOiB0aGlzLmNoYW5uZWxOYW1lLFxuICAgICAgICAgICAgc291cmNlOiAndGFicy1jaGFubmVsJyxcbiAgICAgICAgICAgIC4uLm1lc3NhZ2VcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IHRhcmdldFRhYnMubWFwKHRhYiA9PlxuICAgICAgICAgICAgbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgY2hyb21lPy50YWJzPy5zZW5kTWVzc2FnZT8uKHRhYi5pZCEsIG1lc3NhZ2VXaXRoQ2hhbm5lbCwgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaHJvbWU/LnJ1bnRpbWU/Lmxhc3RFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihjaHJvbWUucnVudGltZS5sYXN0RXJyb3IubWVzc2FnZSkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7IHRhYklkOiB0YWIuaWQsIHJlc3BvbnNlIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNlbmQgbWVzc2FnZSB2aWEgY2hyb21lIHJ1bnRpbWUgKGZvciBzZXJ2aWNlIHdvcmtlciBjb21tdW5pY2F0aW9uKVxuICAgICAqL1xuICAgIGFzeW5jIHBvc3RNZXNzYWdlKG1lc3NhZ2U6IGFueSkge1xuICAgICAgICBjb25zdCB0YWJJZCA9IGF3YWl0IHRoaXMudGFiSWRHZXR0ZXIhKCk7XG5cbiAgICAgICAgY29uc3QgbWVzc2FnZVdpdGhDaGFubmVsID0ge1xuICAgICAgICAgICAgY2hhbm5lbE5hbWU6IHRoaXMuY2hhbm5lbE5hbWUsXG4gICAgICAgICAgICBzb3VyY2U6ICd0YWJzLWNoYW5uZWwnLFxuICAgICAgICAgICAgLi4ubWVzc2FnZVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFNlbmQgdmlhIGNocm9tZS50YWJzIG1lc3NhZ2luZyAoaWdub3JlIHJlc3BvbnNlKVxuICAgICAgICByZXR1cm4gY2hyb21lPy50YWJzPy5zZW5kTWVzc2FnZT8uKHRhYklkLCBtZXNzYWdlV2l0aENoYW5uZWwsICgpID0+IHZvaWQgMCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGN1cnJlbnQgdGFiIElEIChjb252ZW5pZW5jZSBtZXRob2QpXG4gICAgICovXG4gICAgYXN5bmMgZ2V0Q3VycmVudFRhYklkKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGlmICh0aGlzLnRhYklkR2V0dGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50YWJJZEdldHRlcigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIGNsb3NlKCkge1xuICAgICAgICBmb3IgKGNvbnN0IHdyYXBwZWQgb2YgdGhpcy53cmFwcGVkTGlzdGVuZXJzKSB7XG4gICAgICAgICAgICBydW50aW1lTGlzdGVuZXJSZWdpc3RyeS5nZXQodGhpcy5jaGFubmVsTmFtZSk/LmRlbGV0ZSh3cmFwcGVkKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLndyYXBwZWRMaXN0ZW5lcnMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy53cmFwcGVkQnlPcmlnaW5hbC5jbGVhcigpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBDaHJvbWUgRXh0ZW5zaW9uIFBvcnQgQ2hhbm5lbFxuICogQWRhcHRzIGNocm9tZS5ydW50aW1lLlBvcnQgaW50byBhIEJyb2FkY2FzdENoYW5uZWwtbGlrZSBpbnRlcmZhY2UuXG4gKi9cbmV4cG9ydCBjbGFzcyBDaHJvbWVFeHRlbnNpb25Qb3J0Q2hhbm5lbCB7XG4gICAgcHJpdmF0ZSBsaXN0ZW5lcnMgPSBuZXcgU2V0PChldmVudDogYW55KSA9PiB2b2lkPigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwb3J0OiBjaHJvbWUucnVudGltZS5Qb3J0LCBwcml2YXRlIGNoYW5uZWxOYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5wb3J0Py5vbk1lc3NhZ2U/LmFkZExpc3RlbmVyPy4oKG1lc3NhZ2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKChtZXNzYWdlPy5jaGFubmVsTmFtZSA/PyBtZXNzYWdlPy50YXJnZXQpICE9PSB0aGlzLmNoYW5uZWxOYW1lKSByZXR1cm47XG4gICAgICAgICAgICBjb25zdCBldmVudCA9IHsgZGF0YTogbWVzc2FnZSwgb3JpZ2luOiBcImNocm9tZS1leHRlbnNpb24tcG9ydFwiLCBzb3VyY2U6IHRoaXMucG9ydCB9O1xuICAgICAgICAgICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiB0aGlzLmxpc3RlbmVycykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyKGV2ZW50KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiW0Nocm9tZUV4dGVuc2lvblBvcnRDaGFubmVsXSBMaXN0ZW5lciBlcnJvcjpcIiwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYWRkRXZlbnRMaXN0ZW5lcih0eXBlOiBcIm1lc3NhZ2VcIiwgbGlzdGVuZXI6IChldmVudDogYW55KSA9PiB2b2lkKSB7XG4gICAgICAgIGlmICh0eXBlICE9PSBcIm1lc3NhZ2VcIikgcmV0dXJuO1xuICAgICAgICB0aGlzLmxpc3RlbmVycy5hZGQobGlzdGVuZXIpO1xuICAgIH1cblxuICAgIHJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZTogXCJtZXNzYWdlXCIsIGxpc3RlbmVyOiAoZXZlbnQ6IGFueSkgPT4gdm9pZCkge1xuICAgICAgICBpZiAodHlwZSAhPT0gXCJtZXNzYWdlXCIpIHJldHVybjtcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICBwb3N0TWVzc2FnZShtZXNzYWdlOiBhbnkpIHtcbiAgICAgICAgdGhpcy5wb3J0Py5wb3N0TWVzc2FnZT8uKHtcbiAgICAgICAgICAgIC4uLm1lc3NhZ2UsXG4gICAgICAgICAgICBjaGFubmVsTmFtZTogdGhpcy5jaGFubmVsTmFtZSxcbiAgICAgICAgICAgIHNvdXJjZTogXCJwb3J0LWNoYW5uZWxcIlxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjbG9zZSgpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5wb3J0Py5kaXNjb25uZWN0Py4oKTtcbiAgICB9XG59XG4iXX0=